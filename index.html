<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NeoChat Web</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Babel for running React JSX directly in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Import Maps -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.39.3"
      }
    }
  </script>

  <style>
    .hide-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
    .hide-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .hide-scrollbar::-webkit-scrollbar-thumb { background-color: #202225; border-radius: 10px; }
    .hide-scrollbar:hover::-webkit-scrollbar-thumb { background-color: #1a1d21; }
    
    /* Prevent pull-to-refresh on mobile */
    body { overscroll-behavior-y: none; }
  </style>
</head>
<body class="bg-[#2b2f33] text-[#dcddde] overflow-hidden">
  
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { createClient } from '@supabase/supabase-js';
    import { 
      Hash, Search, Bell, Users, Plus, Compass, Settings, 
      Mic, MicOff, Headphones, Send, Paperclip, X, Check, LogOut, User, Database, Mail, Lock, Menu, AlertCircle, ShieldBan
    } from 'lucide-react';

    // ==========================================
    // ðŸ›‘ SUPABASE CONFIG
    // ==========================================
    const supabaseUrl = 'https://cwsslsvuslimptikvrds.supabase.co'; 
    const supabaseKey = 'sb_publishable_OETJRLtsxWNsEMTi61PpsA_QXfQqu41';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // --- Audio Assets ---
    const MESSAGE_SOUND = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqOkZSWl5iZmZmYl5aUkY6KhYGAfXl1cW5ramhlYmBdW1lXVlVUU1NTVFVWV1ldYGJlaGpucXV5fYCBhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en4=');

    // --- Helper Functions ---
    const generateId = (prefix) => prefix + "_" + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    
    // Generates a color avoiding blue (hues 180-260 omitted)
    const getPalette = (seed) => {
        const palettes = [
            '#ef4444', // Red
            '#f97316', // Orange
            '#f59e0b', // Yellow
            '#10b981', // Emerald/Green
            '#22c55e', // Light Green
            '#8b5cf6', // Violet
            '#d946ef', // Fuchsia
            '#f43f5e', // Rose
            '#a855f7'  // Purple
        ];
        if (!seed) return palettes[0];
        let hash = 0;
        for (let i = 0; i < seed.length; i++) {
            hash = seed.charCodeAt(i) + ((hash << 5) - hash);
        }
        return palettes[Math.abs(hash) % palettes.length];
    };

    const getAvatarStyle = (avatarUrl, username) => {
        if (!avatarUrl || avatarUrl === 'pfp.png') {
            return { backgroundColor: getPalette(username) };
        }
        return {};
    };

    const parseMarkdown = (text) => {
      if (!text) return { __html: '' };
      let html = String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/__(.*?)__/g, '<u>$1</u>')
        .replace(new RegExp('`(.*?)`', 'g'), '<code class="bg-[#202225] px-1 rounded text-[#eb459e]">$1</code>')
        .replace(/\n/g, '<br />');
        
      html = html.replace(
        /(https?:\/\/[^\s]+)/g, 
        '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-[#00aff4] hover:underline">$1</a>'
      );
      return { __html: html };
    };

    const compressImage = (file, maxWidth = 1200, maxHeight = 1200, quality = 0.7) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxWidth) {
                height = Math.round((height * maxWidth) / width);
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = Math.round((width * maxHeight) / height);
                height = maxHeight;
              }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = reject;
        };
        reader.onerror = reject;
      });
    };

    function App() {
      const [user, setUser] = useState(null);
      const [data, setData] = useState({ users: [], servers: [], channels: [], messages: [] });
      const [isLoading, setIsLoading] = useState(true);
      
      const profile = user ? data.users.find(u => u.uid === user.uid) : null;
      
      // App Navigation & Context State
      const [context, setContext] = useState('home'); 
      const [activeServerId, setActiveServerId] = useState(null);
      const [activeChannelId, setActiveChannelId] = useState(null);
      
      // Mobile & UI State
      const [leftMenuOpen, setLeftMenuOpen] = useState(false);
      const [membersSidebarOpen, setMembersSidebarOpen] = useState(false);
      const [profileMenuOpen, setProfileMenuOpen] = useState(false);
      
      // Hardware States
      const [micMuted, setMicMuted] = useState(false);
      const [deafened, setDeafened] = useState(false);
      
      // Search & Input State
      const [authMode, setAuthMode] = useState('login'); 
      const [inputText, setInputText] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [toast, setToast] = useState(null);
      const [imageView, setImageView] = useState(null); 
      const messagesEndRef = useRef(null);

      // Modals Setup
      const [modals, setModals] = useState({ 
          createServer: false, 
          createChannel: false, 
          settings: false, 
          profile: null, 
          serverSettings: false,
          search: false,
          notifications: false
      });

      // 1. Setup Auth Listener (Manage session and auth state)
      useEffect(() => {
        if (supabaseUrl === 'YOUR_SUPABASE_URL') {
            setIsLoading(false);
            return;
        }

        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                setUser({ uid: session.user.id });
            } else {
                setIsLoading(false);
            }
        });

        const { data: authListener } = supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                setUser({ uid: session.user.id });
            } else {
                setUser(null);
                setIsLoading(false);
            }
        });

        return () => { 
            authListener.subscription.unsubscribe();
        };
      }, []);

      // 2. Fetch Chat Data & Listen for Realtime changes (Runs automatically upon login)
      useEffect(() => {
        if (!user?.uid || supabaseUrl === 'YOUR_SUPABASE_URL') return;

        let channel;

        const fetchInitialData = async () => {
            const [usersReq, serversReq, channelsReq, messagesReq] = await Promise.all([
                supabase.from('users').select('*'),
                supabase.from('servers').select('*'),
                supabase.from('channels').select('*'),
                supabase.from('messages').select('*').order('timestamp', { ascending: true })
            ]);

            setData({
                users: usersReq.data || [],
                servers: serversReq.data || [],
                channels: channelsReq.data || [],
                messages: messagesReq.data || []
            });
            setIsLoading(false);

            // Subscribe to ALL Postgres changes across our 4 tables
            channel = supabase.channel('db-changes')
              .on('postgres_changes', { event: '*', schema: 'public' }, (payload) => {
                const table = payload.table;
                const eventType = payload.eventType;
                const newRecord = payload.new;
                const oldRecord = payload.old;

                setData(prev => {
                  const next = Object.assign({}, prev);
                  if (!next[table]) return prev;

                  if (eventType === 'INSERT') {
                    // Prevent duplicate rendering if we already optimistically added it locally
                    if (!next[table].find(item => item.id === newRecord.id)) {
                        next[table] = [...next[table], newRecord];
                    }
                  } else if (eventType === 'UPDATE') {
                    next[table] = next[table].map(item => item.id === newRecord.id ? newRecord : item);
                  } else if (eventType === 'DELETE') {
                    next[table] = next[table].filter(item => item.id !== oldRecord.id);
                  }
                  return next;
                });
              })
              .subscribe();
        };

        fetchInitialData();

        return () => { 
            if (channel) supabase.removeChannel(channel); 
        };
      }, [user?.uid]);

      const activeServer = useMemo(() => data.servers.find(s => s.id === activeServerId), [data.servers, activeServerId]);
      const serverChannels = useMemo(() => data.channels.filter(c => c.serverId === activeServerId).sort((a,b) => a.createdAt - b.createdAt), [data.channels, activeServerId]);
      const activeChannel = useMemo(() => data.channels.find(c => c.id === activeChannelId), [data.channels, activeChannelId]);
      
      const channelMessages = useMemo(() => {
        return data.messages
          .filter(m => m.channelId === activeChannelId)
          .sort((a, b) => a.timestamp - b.timestamp);
      }, [data.messages, activeChannelId]);

      // Search and Notification Derivations
      const searchResults = useMemo(() => {
          if (!searchQuery.trim()) return [];
          const q = searchQuery.toLowerCase();
          return data.messages.filter(m => m.text && m.text.toLowerCase().includes(q)).sort((a,b) => b.timestamp - a.timestamp).slice(0, 30);
      }, [data.messages, searchQuery]);

      const myNotifications = useMemo(() => {
          if (!profile) return [];
          // Find DMs where I am a participant
          const myDMs = data.channels.filter(c => c.serverId === 'dm' && c.name.includes(profile.uid));
          const dmIds = myDMs.map(c => c.id);
          // Get recent messages in these DMs sent by others
          return data.messages
              .filter(m => dmIds.includes(m.channelId) && m.senderId !== profile.uid)
              .sort((a,b) => b.timestamp - a.timestamp)
              .slice(0, 10);
      }, [data.channels, data.messages, profile]);

      useEffect(() => {
        if (channelMessages.length > 0) {
          const lastMsg = channelMessages[channelMessages.length - 1];
          if (lastMsg && profile && lastMsg.senderId !== profile.uid && Date.now() - lastMsg.timestamp < 5000 && !deafened) {
            try {
              MESSAGE_SOUND.currentTime = 0;
              MESSAGE_SOUND.play().catch(() => {});
            } catch(e) {}
          }
          scrollToBottom();
        }
      }, [channelMessages, profile, deafened]);

      const scrollToBottom = () => {
        if (messagesEndRef.current) {
          messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
      };

      const showToast = (message, type = 'info') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      // --- Auth Actions ---
      const handleAuth = async (e) => {
        e.preventDefault();
        const email = e.target.email.value.trim();
        const password = e.target.password.value;
        const username = e.target.username ? e.target.username.value.trim() : '';

        try {
            if (authMode === 'register') {
                const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });
                if (authError) throw authError;

                if (authData.user) {
                    const isDavid = username.toLowerCase().includes('david');
                    const finalUser = {
                        id: authData.user.id,
                        uid: authData.user.id,
                        username: username,
                        avatar: 'pfp.png',
                        bio: '',
                        isAdmin: isDavid,
                        status: 'online',
                        lastActive: Date.now()
                    };
                    
                    const { error: dbError } = await supabase.from('users').upsert(finalUser);
                    if (dbError) throw dbError;
                    
                    if (!authData.session) {
                        showToast("Check your email to confirm your account!", "info");
                    } else {
                        showToast("Account created!", "success");
                    }
                }
            } else {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                showToast("Logged in successfully!", "success");
            }
        } catch (error) {
            showToast(error.message, "error");
        }
      };

      const handleLogout = async () => {
        await supabase.auth.signOut();
        setContext('home');
        setActiveServerId(null);
        setActiveChannelId(null);
        showToast("Logged out successfully.", "success");
      };

      // --- Chat Actions ---
      const handleStartDM = async (targetUser) => {
        if (!profile || !targetUser) return;
        
        // Ensure consistent naming convention for the DM channel
        const uids = [profile.uid, targetUser.uid].sort();
        const dmName = uids.join('_');
        
        // Check if DM channel exists
        let dmChannel = data.channels.find(c => c.serverId === 'dm' && c.name === dmName);
        
        if (!dmChannel) {
            const newChannel = {
                id: generateId('chan'),
                serverId: 'dm',
                name: dmName,
                createdAt: Date.now()
            };
            await supabase.from('channels').insert(newChannel);
            dmChannel = newChannel;
        }

        setModals(m => ({ ...m, profile: null }));
        setLeftMenuOpen(false);
        setContext('home');
        setActiveServerId(null);
        setActiveChannelId(dmChannel.id);
      };

      const handleCreateServer = async (e) => {
        e.preventDefault();
        const name = e.target.name.value.trim();
        if (!name) return;

        const serverId = generateId('srv');
        const channelId = generateId('chan');

        const newServer = {
          id: serverId,
          name: name,
          ownerId: profile.uid,
          createdAt: Date.now(),
          icon: "https://ui-avatars.com/api/?name=" + encodeURIComponent(name) + "&background=5865F2&color=fff&bold=true"
        };

        const newChannel = {
          id: channelId,
          serverId: serverId,
          name: 'general',
          createdAt: Date.now()
        };

        // Optimistic UI Update: Render instantly
        setData(prev => Object.assign({}, prev, {
          servers: [...prev.servers, newServer],
          channels: [...prev.channels, newChannel]
        }));

        await supabase.from('servers').insert(newServer);
        await supabase.from('channels').insert(newChannel);

        setModals(m => ({ ...m, createServer: false }));
        switchContext('server', serverId);
        setLeftMenuOpen(false);
        showToast("Server " + name + " created!", "success");
      };

      const handleCreateChannel = async (e) => {
        e.preventDefault();
        const name = e.target.name.value.trim().toLowerCase().replace(/\s+/g, '-');
        if (!name || !activeServerId) return;

        const newChannel = {
          id: generateId('chan'),
          serverId: activeServerId,
          name: name,
          createdAt: Date.now()
        };

        // Optimistic UI Update: Render instantly
        setData(prev => Object.assign({}, prev, {
          channels: [...prev.channels, newChannel]
        }));

        await supabase.from('channels').insert(newChannel);
        setModals(m => ({ ...m, createChannel: false }));
        showToast("Channel #" + name + " created!", "success");
      };

      const sendMessage = async (e) => {
        if (e) e.preventDefault();
        if (!inputText.trim() || !activeChannelId) return;

        const newMsg = {
          id: generateId('msg'),
          channelId: activeChannelId,
          text: inputText.trim(),
          senderId: profile.uid,
          timestamp: Date.now(),
          reactions: {}
        };

        setInputText('');

        // Optimistic UI Update: Render message instantly
        setData(prev => Object.assign({}, prev, {
          messages: [...prev.messages, newMsg]
        }));

        await supabase.from('messages').insert(newMsg);
      };

      const handleImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          showToast("Compressing image...", "info");
          const compressedBase64 = await compressImage(file, 1200, 1200, 0.8);

          const newMsg = {
            id: generateId('msg'),
            channelId: activeChannelId,
            text: '',
            imageUrl: compressedBase64,
            senderId: profile.uid,
            timestamp: Date.now(),
            reactions: {}
          };

          // Optimistic UI Update: Render image instantly
          setData(prev => Object.assign({}, prev, {
            messages: [...prev.messages, newMsg]
          }));

          await supabase.from('messages').insert(newMsg);
          showToast("Image uploaded!", "success");
        } catch (err) {
          showToast("Failed to upload image.", "error");
        }
      };

      const toggleReaction = async (msgId, emoji, currentReactions) => {
        let rxns = Object.assign({}, currentReactions);
        if (!rxns[emoji]) rxns[emoji] = [];
        if (rxns[emoji].includes(profile.uid)) {
          rxns[emoji] = rxns[emoji].filter(id => id !== profile.uid);
          if (rxns[emoji].length === 0) delete rxns[emoji];
        } else {
          rxns[emoji].push(profile.uid);
        }
        
        setData(prev => {
          const updatedMessages = prev.messages.map(m => {
            if (m.id === msgId) return Object.assign({}, m, { reactions: rxns });
            return m;
          });
          return Object.assign({}, prev, { messages: updatedMessages });
        });

        await supabase.from('messages').update({ reactions: rxns }).eq('id', msgId);
      };

      const updateProfile = async (updates) => {
        setData(prev => {
           const updatedUsers = prev.users.map(u => {
              if (u.uid === profile.uid) return Object.assign({}, u, updates);
              return u;
           });
           return Object.assign({}, prev, { users: updatedUsers });
        });
        await supabase.from('users').update(updates).eq('id', profile.id);
      };

      const switchContext = (ctx, id = null) => {
        setContext(ctx);
        if (ctx === 'server') {
          setActiveServerId(id);
          const firstChannel = data.channels.find(c => c.serverId === id);
          if (firstChannel) setActiveChannelId(firstChannel.id);
        } else {
          setActiveServerId(null);
          setActiveChannelId(null);
        }
        setLeftMenuOpen(false);
      };

      // --- Loading & Login UI ---
      if (isLoading) {
          return <div className="flex h-screen w-full items-center justify-center bg-[#2b2f33] text-white font-bold text-xl animate-pulse">Connecting...</div>;
      }

      if (!profile) {
        return (
          <div className="flex h-screen w-full items-center justify-center bg-gradient-to-br from-[#1a1d21] to-[#2b2f33] font-sans text-white overflow-hidden relative p-4">
            <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'radial-gradient(circle, #fff 1px, transparent 1px)', backgroundSize: '50px 50px' }} />
            
            <div className="bg-[#36393f] p-6 md:p-8 rounded-2xl w-full max-w-[400px] shadow-2xl z-10 border border-white/5 animate-in zoom-in-95 duration-300">
              
              {toast ? (
                <div className={"absolute top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-xl font-bold text-sm w-[90%] text-center z-[200] " + (toast.type === 'success' ? 'bg-[#3ba55c]' : toast.type === 'error' ? 'bg-[#ed4245]' : 'bg-[#5865F2]')}>
                  {toast.message}
                </div>
              ) : null}

              <div className="text-center mb-6 mt-4">
                <img src="logo.png" alt="Logo" className="w-20 h-20 mx-auto mb-4 object-contain" onError={(e) => { e.target.onerror = null; e.target.style.display = 'none'; }} />
                <h2 className="text-2xl font-bold mb-2">NeoChat Web</h2>
                <p className="text-[#b9bbbe] text-sm">Global Real-time Communities</p>
              </div>

              {/* Mode Toggle */}
              <div className="flex border-b border-black/20 mb-6 pb-2">
                <button type="button" onClick={() => setAuthMode('login')} className={"flex-1 text-center pb-2 font-bold text-sm transition-colors " + (authMode === 'login' ? 'text-white border-b-2 border-[#5865F2]' : 'text-[#8e9297] hover:text-[#b9bbbe]')}>Login</button>
                <button type="button" onClick={() => setAuthMode('register')} className={"flex-1 text-center pb-2 font-bold text-sm transition-colors " + (authMode === 'register' ? 'text-white border-b-2 border-[#5865F2]' : 'text-[#8e9297] hover:text-[#b9bbbe]')}>Register</button>
              </div>

              <form onSubmit={handleAuth} className="space-y-4">
                {authMode === 'register' ? (
                  <div>
                    <label className="block text-[#b9bbbe] text-xs font-bold uppercase tracking-wider mb-2">Username</label>
                    <div className="relative">
                      <User className="absolute left-3 top-3.5 text-[#8e9297]" size={16} />
                      <input name="username" required placeholder="Display Name" autoComplete="off" className="w-full bg-[#202225] border border-black/30 rounded px-10 py-3 text-white focus:outline-none focus:border-[#5865F2] transition-all" />
                    </div>
                  </div>
                ) : null}
                
                <div>
                  <label className="block text-[#b9bbbe] text-xs font-bold uppercase tracking-wider mb-2">Email Address</label>
                  <div className="relative">
                    <Mail className="absolute left-3 top-3.5 text-[#8e9297]" size={16} />
                    <input name="email" type="email" required placeholder="you@example.com" className="w-full bg-[#202225] border border-black/30 rounded px-10 py-3 text-white focus:outline-none focus:border-[#5865F2] transition-all" />
                  </div>
                </div>
                
                <div>
                  <label className="block text-[#b9bbbe] text-xs font-bold uppercase tracking-wider mb-2">Password</label>
                  <div className="relative">
                    <Lock className="absolute left-3 top-3.5 text-[#8e9297]" size={16} />
                    <input name="password" type="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" minLength="6" className="w-full bg-[#202225] border border-black/30 rounded px-10 py-3 text-white focus:outline-none focus:border-[#5865F2] transition-all" />
                  </div>
                </div>
                
                <button type="submit" className="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white font-bold py-3 px-4 rounded transition-all mt-4">
                  {authMode === 'login' ? 'Sign In' : 'Create Account'}
                </button>
              </form>
            </div>
          </div>
        );
      }

      // Pre-process DM channels to extract user objects
      const dmChannelsWithUsers = context === 'home' 
        ? data.channels.filter(c => c.serverId === 'dm' && c.name.includes(profile.uid)).map(c => {
            const otherUid = c.name.split('_').find(id => id !== profile.uid);
            const otherUser = data.users.find(u => u.uid === otherUid) || { username: 'Unknown User', avatar: 'pfp.png' };
            return { ...c, targetUser: otherUser };
        }) : [];

      // Find top header info for active channel
      let activeChannelInfo = { name: 'select-channel', isDM: false };
      if (activeChannelId) {
         if (context === 'server' && activeChannel) {
             activeChannelInfo = { name: activeChannel.name, isDM: false };
         } else if (context === 'home') {
             const ch = dmChannelsWithUsers.find(c => c.id === activeChannelId);
             if (ch) activeChannelInfo = { name: ch.targetUser.username, avatar: ch.targetUser.avatar, isDM: true };
         }
      }

      // --- Main App Render ---
      return (
        <div className="flex h-screen w-full bg-[#2b2f33] text-[#dcddde] font-sans overflow-hidden selection:bg-[#5865F2]/50 relative">
          
          {/* Toast Notifications */}
          {toast ? (
            <div className={"fixed top-5 right-5 z-[200] px-6 py-4 rounded-lg shadow-2xl font-semibold flex items-center gap-3 animate-in slide-in-from-right-10 duration-300 " + (toast.type === 'success' ? 'bg-[#3ba55c]' : toast.type === 'error' ? 'bg-[#ed4245]' : 'bg-[#5865F2]')}>
              <Check size={20} />
              {toast.message}
            </div>
          ) : null}

          {/* Fullscreen Image Modal */}
          {imageView ? (
            <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[150] p-4 cursor-pointer" onClick={() => setImageView(null)}>
              <img src={imageView} className="max-w-full max-h-full object-contain cursor-default" alt="Fullscreen view" onClick={e => e.stopPropagation()} />
              <button type="button" onClick={() => setImageView(null)} className="absolute top-6 right-6 text-white hover:text-gray-300 transition-colors bg-black/50 p-2 rounded-full">
                <X size={24} />
              </button>
            </div>
          ) : null}

          {/* MOBILE OVERLAYS */}
          {leftMenuOpen && (
             <div className="fixed inset-0 bg-black/60 z-30 md:hidden" onClick={() => setLeftMenuOpen(false)}></div>
          )}
          {membersSidebarOpen && (
             <div className="fixed inset-0 bg-black/60 z-30 md:hidden" onClick={() => setMembersSidebarOpen(false)}></div>
          )}

          {/* 1. Left Navigation Wrapper (Rail + Context Sidebar) */}
          <div className={`fixed inset-y-0 left-0 z-40 md:relative md:z-auto h-full flex flex-row shrink-0 transform transition-transform duration-300 ${leftMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
            
            {/* Server Rail */}
            <div className="w-[72px] bg-[#1a1d21] flex flex-col items-center py-3 gap-2 overflow-y-auto shrink-0 border-r border-black/20 hide-scrollbar">
              <button 
                type="button"
                onClick={() => switchContext('home')}
                className={"relative w-12 h-12 rounded-[24px] hover:rounded-[16px] bg-[#36393f] flex items-center justify-center transition-all duration-200 group shrink-0 " + (context === 'home' ? 'bg-[#5865F2] rounded-[16px] text-white' : 'text-[#dcddde] hover:bg-[#5865F2] hover:text-white')}
              >
                <div className={"absolute left-[-12px] w-2 bg-white rounded-r-full transition-all duration-200 " + (context === 'home' ? 'h-10 opacity-100' : 'h-5 opacity-0 group-hover:opacity-100')} />
                <div className="w-full h-full flex items-center justify-center p-2 rounded-inherit">
                  <img src="logo.png" alt="Home" className="w-full h-full object-contain" onError={(e) => { e.target.onerror = null; e.target.src = 'pfp.png'; }} />
                </div>
              </button>
              
              <div className="w-8 h-[2px] bg-[#2f3136] rounded my-1 shrink-0" />

              {data.servers.map(srv => (
                <button 
                  key={srv.id}
                  type="button"
                  onClick={() => switchContext('server', srv.id)}
                  className={"relative w-12 h-12 shrink-0 rounded-[24px] hover:rounded-[16px] flex items-center justify-center transition-all duration-200 group overflow-hidden " + (activeServerId === srv.id ? 'rounded-[16px]' : '')}
                  title={srv.name}
                >
                  <div className={"absolute left-[-12px] w-2 bg-white rounded-r-full transition-all duration-200 z-10 " + (activeServerId === srv.id ? 'h-10 opacity-100' : 'h-5 opacity-0 group-hover:opacity-100')} />
                  <img src={srv.icon} alt={srv.name} className="w-full h-full object-cover" />
                </button>
              ))}

              <button type="button" onClick={() => setModals(m => ({ ...m, createServer: true }))} className="w-12 h-12 shrink-0 rounded-[24px] hover:rounded-[16px] bg-[#36393f] text-[#3ba55c] hover:bg-[#3ba55c] hover:text-white flex items-center justify-center transition-all duration-200 mt-2">
                <Plus size={24} />
              </button>
              <button type="button" onClick={() => switchContext('discovery')} className="w-12 h-12 shrink-0 rounded-[24px] hover:rounded-[16px] bg-[#36393f] text-[#3ba55c] hover:bg-[#3ba55c] hover:text-white flex items-center justify-center transition-all duration-200 mt-auto">
                <Compass size={24} />
              </button>
            </div>

            {/* Context Sidebar (Channels / DMs) */}
            {context !== 'discovery' ? (
              <div className="w-60 bg-[#2f3136] flex flex-col shrink-0 border-r border-black/20">
                <div className="h-12 px-4 flex items-center justify-between font-bold text-white shadow-sm border-b border-black/10 transition-colors shrink-0">
                  <span className="truncate">{context === 'server' && activeServer ? activeServer.name : 'Direct Messages'}</span>
                  {context === 'server' && activeServer && profile && activeServer.ownerId === profile.uid ? (
                    <button type="button" onClick={() => setModals(m => ({ ...m, serverSettings: true }))} className="p-1 hover:bg-white/10 rounded transition-colors text-[#b9bbbe] hover:text-white shrink-0" title="Server Settings">
                      <Settings size={16} />
                    </button>
                  ) : null}
                </div>
                
                <div className="flex-1 overflow-y-auto p-2 hide-scrollbar">
                  {context === 'server' ? (
                    <React.Fragment>
                      <div className="flex items-center justify-between px-2 pt-4 pb-1 text-xs font-bold text-[#8e9297] uppercase tracking-wider group">
                        <span>Text Channels</span>
                        {profile.isAdmin ? (
                          <button type="button" onClick={() => setModals(m => ({ ...m, createChannel: true }))} className="hover:text-white hidden group-hover:block"><Plus size={14}/></button>
                        ) : null}
                      </div>
                      {serverChannels.map(ch => (
                        <button 
                          key={ch.id} 
                          type="button"
                          onClick={() => { setActiveChannelId(ch.id); setLeftMenuOpen(false); }}
                          className={"w-full flex items-center gap-2 px-2 py-1.5 mb-0.5 rounded transition-colors " + (activeChannelId === ch.id ? 'bg-white/10 text-white font-medium' : 'text-[#8e9297] hover:bg-white/5 hover:text-[#dcddde]')}
                        >
                          <Hash size={18} className="text-[#8e9297] shrink-0" />
                          <span className="truncate">{ch.name}</span>
                        </button>
                      ))}
                    </React.Fragment>
                  ) : (
                    <React.Fragment>
                      <div className="text-xs font-bold text-[#8e9297] uppercase tracking-wider px-2 pt-4 pb-2">Direct Messages</div>
                      {dmChannelsWithUsers.length === 0 ? (
                         <div className="text-center p-4 text-sm text-[#8e9297] mt-4">You have no open DMs. Click a user in a server to start chatting!</div>
                      ) : null}
                      {dmChannelsWithUsers.map(ch => (
                        <button 
                          key={ch.id} 
                          type="button"
                          onClick={() => { setActiveChannelId(ch.id); setLeftMenuOpen(false); }}
                          className={"w-full flex items-center gap-3 px-2 py-1.5 mb-0.5 rounded transition-colors " + (activeChannelId === ch.id ? 'bg-white/10 text-white font-medium' : 'text-[#8e9297] hover:bg-white/5 hover:text-[#dcddde]')}
                        >
                          <div className="relative shrink-0 w-8 h-8">
                             <img src={ch.targetUser.avatar || 'pfp.png'} className="w-8 h-8 rounded-full object-cover bg-[#202225]" style={getAvatarStyle(ch.targetUser.avatar, ch.targetUser.username)} />
                             <div className={"absolute -bottom-0.5 -right-0.5 w-3 h-3 border-2 border-[#2f3136] rounded-full transition-colors " + (ch.targetUser.status === 'online' ? 'bg-[#3ba55c]' : 'bg-[#747f8d]')} />
                          </div>
                          <span className="truncate">{ch.targetUser.username}</span>
                        </button>
                      ))}
                    </React.Fragment>
                  )}
                </div>

                {/* User Controls Panel */}
                <div className="h-[52px] bg-[#292b2f] flex items-center px-2 gap-2 border-t border-black/20 shrink-0">
                  <button type="button" onClick={() => setModals(m => ({ ...m, profile: profile }))} className="flex items-center gap-2 flex-1 min-w-0 hover:bg-white/10 p-1 rounded transition-colors text-left">
                    <div className="relative shrink-0 w-8 h-8">
                      <img src={profile.avatar || 'pfp.png'} alt="Avatar" className="w-8 h-8 rounded-full bg-[#202225] object-cover" style={getAvatarStyle(profile.avatar, profile.username)} />
                      <div className="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-[#3ba55c] border-2 border-[#292b2f] rounded-full" />
                    </div>
                    <div className="flex-1 min-w-0 leading-tight">
                      <div className="text-sm font-bold text-white truncate flex items-center gap-1">
                        {profile.username}
                        {profile.isAdmin ? <span className="bg-amber-400 text-black text-[9px] px-1 rounded-sm tracking-wider">ADMIN</span> : null}
                      </div>
                      <div className="text-xs text-[#8e9297] truncate">#{profile.uid.substring(0,4)}</div>
                    </div>
                  </button>
                  <div className="flex text-[#b9bbbe] shrink-0">
                    <button type="button" onClick={() => setMicMuted(!micMuted)} className={"p-1.5 rounded transition-colors " + (micMuted ? 'text-[#ed4245] hover:bg-[#ed4245]/10' : 'hover:bg-white/10')} title="Toggle Mic">
                      {micMuted ? <MicOff size={18} /> : <Mic size={18} />}
                    </button>
                    <button type="button" onClick={() => setDeafened(!deafened)} className={"p-1.5 rounded transition-colors " + (deafened ? 'text-[#ed4245] hover:bg-[#ed4245]/10' : 'hover:bg-white/10')} title="Toggle Audio">
                      <Headphones size={18} className={deafened ? 'opacity-50' : ''} />
                    </button>
                    <button type="button" onClick={() => setModals(m => ({ ...m, settings: true }))} className="p-1.5 hover:bg-white/10 rounded" title="Settings">
                      <Settings size={18} />
                    </button>
                  </div>
                </div>
              </div>
            ) : null}
          </div>

          {/* 3. Main Chat Area */}
          <div className="flex-1 flex flex-col min-w-0 bg-[#36393f] relative h-full">
            {context === 'discovery' ? (
              <div className="flex-1 p-4 md:p-8 overflow-y-auto hide-scrollbar">
                <div className="md:hidden flex items-center gap-3 mb-6">
                  <button type="button" onClick={() => setLeftMenuOpen(true)} className="p-2 bg-[#202225] rounded text-white">
                    <Menu size={24} />
                  </button>
                </div>
                <h1 className="text-2xl md:text-3xl font-bold text-white mb-6 flex items-center gap-3">
                  <Compass className="text-[#5865F2] shrink-0" size={32}/> Global Servers
                </h1>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                  {data.servers.length === 0 ? (
                    <div className="text-[#8e9297]">No servers exist yet. Create one!</div>
                  ) : null}
                  {data.servers.map(s => (
                    <div key={s.id} onClick={() => switchContext('server', s.id)} className="bg-[#2f3136] rounded-lg overflow-hidden cursor-pointer hover:-translate-y-1 hover:shadow-xl transition-all border border-white/5 group">
                      <div className="h-24 bg-gradient-to-br from-[#5865F2] to-purple-600 relative overflow-hidden group-hover:opacity-90">
                         <div className="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"/>
                      </div>
                      <div className="p-4 relative">
                        <img src={s.icon} className="absolute -top-10 left-4 w-16 h-16 rounded-xl border-4 border-[#2f3136] bg-[#202225] shadow-lg object-cover shrink-0" alt=""/>
                        <div className="mt-8 font-bold text-white text-lg">{s.name}</div>
                        <div className="text-sm text-[#b9bbbe] mt-1 line-clamp-2">A global community.</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ) : (
              <React.Fragment>
                {/* Header Top Bar */}
                <div className="h-12 px-4 flex items-center justify-between shadow-sm border-b border-black/20 shrink-0 z-10 bg-[#36393f]">
                  <div className="flex items-center gap-2 min-w-0">
                    <button type="button" className="md:hidden p-1 mr-1 text-[#b9bbbe] hover:text-white shrink-0" onClick={() => setLeftMenuOpen(true)}>
                      <Menu size={20} />
                    </button>
                    {activeChannelInfo.isDM ? (
                       <img src={activeChannelInfo.avatar || 'pfp.png'} className="w-6 h-6 rounded-full object-cover shrink-0" style={getAvatarStyle(activeChannelInfo.avatar, activeChannelInfo.name)} />
                    ) : (
                       <Hash className="text-[#8e9297] shrink-0" size={24} />
                    )}
                    <span className="font-bold text-white truncate">{activeChannelInfo.name}</span>
                  </div>
                  <div className="flex items-center gap-3 md:gap-4 text-[#b9bbbe] shrink-0 relative">
                    <button type="button" onClick={() => setModals(m => ({ ...m, search: true }))} className="hover:text-white p-1 rounded hover:bg-white/10 transition-colors">
                      <Search size={20} />
                    </button>
                    
                    <button type="button" onClick={() => setModals(m => ({ ...m, notifications: true }))} className="hover:text-white p-1 rounded hover:bg-white/10 transition-colors relative">
                      <Bell size={20} />
                      {myNotifications.length > 0 && <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-[#ed4245] rounded-full border-2 border-[#36393f]"></span>}
                    </button>

                    {context === 'server' && (
                      <button type="button" className={membersSidebarOpen ? 'text-white p-1 bg-white/10 rounded' : 'hover:text-white p-1 rounded hover:bg-white/10 transition-colors'} onClick={() => setMembersSidebarOpen(!membersSidebarOpen)}>
                        <Users size={20} />
                      </button>
                    )}
                  </div>
                </div>

                {/* Messages Container */}
                <div className="flex-1 overflow-y-auto p-4 flex flex-col gap-1 hide-scrollbar">
                  {!activeChannelId ? (
                    <div className="m-auto text-center text-[#8e9297] px-4">
                      <Hash size={48} className="mx-auto mb-4 opacity-50 shrink-0"/>
                      <p>Select a channel from the sidebar to start chatting</p>
                    </div>
                  ) : null}
                  {activeChannelId ? channelMessages.map((msg, idx) => {
                    const prevMsg = channelMessages[idx - 1];
                    const isGrouped = prevMsg && prevMsg.senderId === msg.senderId && (msg.timestamp - prevMsg.timestamp < 300000); 
                    const sender = data.users.find(u => u.uid === msg.senderId);
                    const date = new Date(msg.timestamp);
                    const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    return (
                      <div key={msg.id} className={"group flex gap-3 md:gap-4 px-2 md:px-4 py-1 hover:bg-black/5 rounded " + (isGrouped ? 'mt-0' : 'mt-4')}>
                        {isGrouped ? (
                          <div className="w-10 flex-shrink-0 text-right opacity-0 group-hover:opacity-100 text-[10px] text-[#72767d] pt-1 select-none hidden md:block">
                            {timeStr}
                          </div>
                        ) : (
                          <img 
                            src={sender?.avatar || 'pfp.png'} 
                            alt="Avatar" 
                            className="w-10 h-10 shrink-0 rounded-full cursor-pointer hover:shadow-lg transition-transform hover:scale-105 bg-[#202225] object-cover"
                            style={getAvatarStyle(sender?.avatar, sender?.username)}
                            onClick={() => setModals(m => ({ ...m, profile: sender }))}
                          />
                        )}
                        
                        <div className="flex-1 min-w-0">
                          {!isGrouped || window.innerWidth < 768 ? (
                            <div className="flex items-baseline gap-2 mb-1">
                              <span 
                                className="font-medium text-white hover:underline cursor-pointer flex items-center gap-1 truncate"
                                onClick={() => setModals(m => ({ ...m, profile: sender }))}
                              >
                                {sender && sender.username ? sender.username : 'Unknown User'}
                                {sender && sender.isAdmin ? <span className="bg-amber-400 text-black text-[9px] px-1 rounded-sm tracking-wider font-bold h-3 flex items-center">ADMIN</span> : null}
                              </span>
                              <span className="text-xs text-[#72767d] shrink-0">{date.toLocaleDateString()} at {timeStr}</span>
                            </div>
                          ) : null}
                          
                          {msg.text ? (
                            <div className="text-[#dcddde] break-words leading-relaxed text-sm md:text-base" dangerouslySetInnerHTML={parseMarkdown(msg.text)} />
                          ) : null}
                          {msg.imageUrl ? (
                            <img src={msg.imageUrl} alt="attachment" className="max-w-xs md:max-w-sm max-h-60 md:max-h-80 rounded-lg mt-2 cursor-pointer border border-white/10 object-contain" onClick={() => setImageView(msg.imageUrl)} />
                          ) : null}

                          {msg.reactions && Object.keys(msg.reactions).length > 0 ? (
                            <div className="flex flex-wrap gap-1 mt-1">
                              {Object.keys(msg.reactions).map(emoji => {
                                const uids = msg.reactions[emoji];
                                return (
                                  <button 
                                    key={emoji} 
                                    type="button"
                                    onClick={() => toggleReaction(msg.id, emoji, msg.reactions)}
                                    className={"flex items-center gap-1 px-1.5 py-0.5 rounded border " + (uids.includes(profile.uid) ? 'bg-[#5865F2]/20 border-[#5865F2] text-[#5865F2]' : 'bg-[#2f3136] border-transparent text-[#b9bbbe] hover:border-white/20') + " text-xs font-bold transition-colors"}
                                  >
                                    <span>{emoji}</span>
                                    <span>{uids.length}</span>
                                  </button>
                                );
                              })}
                            </div>
                          ) : null}
                        </div>

                        {/* Quick Reactions Hover Bar */}
                        <div className="absolute right-4 -mt-3 hidden group-hover:flex items-center bg-[#36393f] border border-black/20 rounded shadow-sm px-1 py-0.5">
                          {['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®'].map(emoji => (
                            <button type="button" key={emoji} onClick={() => toggleReaction(msg.id, emoji, msg.reactions || {})} className="p-1 hover:bg-white/10 rounded text-lg grayscale hover:grayscale-0 transition-all hover:scale-110">
                              {emoji}
                            </button>
                          ))}
                        </div>
                      </div>
                    );
                  }) : null}
                  <div ref={messagesEndRef} className="h-4" />
                </div>

                {/* Input Area */}
                {activeChannelId ? (
                  <div className="px-2 md:px-4 pb-4 md:pb-6 pt-2 shrink-0">
                    <div className="bg-[#383a40] rounded-lg flex items-center p-2 gap-2 shadow-sm focus-within:ring-1 focus-within:ring-[#5865F2]">
                      <label className="p-2 hover:bg-[#4f545c] rounded-full cursor-pointer text-[#b9bbbe] hover:text-white transition-colors shrink-0">
                        <Paperclip size={20} />
                        <input type="file" hidden accept="image/*" onChange={handleImageUpload} />
                      </label>
                      <form onSubmit={sendMessage} className="flex-1 flex min-w-0">
                        <input 
                          type="text" 
                          value={inputText}
                          onChange={(e) => setInputText(e.target.value)}
                          placeholder={"Message " + (activeChannelInfo.isDM ? "@" : "#") + activeChannelInfo.name}
                          className="flex-1 bg-transparent text-white placeholder-[#72767d] focus:outline-none px-2 py-1 min-w-0"
                          autoComplete="off"
                        />
                        <button type="submit" disabled={!inputText.trim()} className={"p-2 rounded-full transition-colors shrink-0 " + (inputText.trim() ? 'bg-[#5865F2] text-white hover:bg-[#4752c4]' : 'text-[#72767d] bg-transparent')}>
                          <Send size={18} className={inputText.trim() ? 'translate-x-0.5' : ''}/>
                        </button>
                      </form>
                    </div>
                    <div className="text-xs text-[#72767d] mt-1 px-2 font-mono">
                      Markdown supported: **bold**, *italic*, __underline__, <code>code</code>
                    </div>
                  </div>
                ) : null}
              </React.Fragment>
            )}
          </div>

          {/* 4. Members Sidebar (Right) */}
          {context === 'server' && membersSidebarOpen ? (
            <div className={`fixed inset-y-0 right-0 z-40 md:relative md:z-auto h-full w-60 bg-[#2f3136] flex flex-col shrink-0 overflow-y-auto border-l border-black/20 hide-scrollbar transform transition-transform duration-300 ${membersSidebarOpen ? 'translate-x-0' : 'translate-x-full hidden md:flex md:translate-x-0'}`}>
              <div className="text-xs font-bold text-[#8e9297] uppercase tracking-wider px-4 pt-6 pb-2 border-b border-white/5 mb-2">
                Global Users â€” {data.users.length}
              </div>
              {data.users.map(u => (
                <div key={u.uid} onClick={() => { setModals(m => ({ ...m, profile: u })); setMembersSidebarOpen(false); }} className="flex items-center gap-3 px-4 py-2 mx-2 rounded hover:bg-white/5 cursor-pointer group">
                  <div className="relative shrink-0 w-8 h-8">
                    <img src={u.avatar || 'pfp.png'} className="w-8 h-8 shrink-0 rounded-full bg-[#202225] object-cover" alt="" style={getAvatarStyle(u.avatar, u.username)} />
                    <div className={"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 border-[3px] border-[#2f3136] group-hover:border-[#33353b] rounded-full transition-colors " + (u.status === 'online' ? 'bg-[#3ba55c]' : 'bg-[#747f8d]')} />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="text-[#8e9297] group-hover:text-[#dcddde] font-medium truncate flex items-center gap-1">
                      {u.username}
                      {u.isAdmin ? <span className="bg-amber-400 text-black text-[8px] px-1 rounded-sm tracking-wider font-bold">ADMIN</span> : null}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : null}

          {/* --- Modals --- */}
          
          {/* Global Search Modal */}
          {modals.search ? (
             <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={() => setModals(m => ({ ...m, search: false }))}>
               <div className="bg-[#36393f] w-full max-w-2xl h-[80vh] rounded-lg shadow-2xl flex flex-col border border-white/5" onClick={e => e.stopPropagation()}>
                 <div className="p-4 border-b border-black/20 flex items-center gap-3 shrink-0">
                    <Search className="text-[#8e9297] shrink-0" />
                    <input autoFocus type="text" placeholder="Search all messages globally..." className="bg-transparent text-white w-full outline-none text-lg" onChange={(e) => setSearchQuery(e.target.value)} />
                    <button type="button" className="shrink-0 p-1 bg-white/10 hover:bg-white/20 rounded" onClick={() => setModals(m => ({ ...m, search: false }))}><X className="text-[#dcddde]" size={20} /></button>
                 </div>
                 <div className="flex-1 overflow-y-auto p-4 hide-scrollbar">
                    {searchQuery.trim() === '' ? (
                       <div className="text-center text-[#8e9297] mt-10">Type something to search through all loaded messages.</div>
                    ) : searchResults.length === 0 ? (
                       <div className="text-center text-[#8e9297] mt-10">No messages matched your search.</div>
                    ) : (
                       searchResults.map(msg => {
                           const sender = data.users.find(u => u.uid === msg.senderId) || { username: 'Unknown User', avatar: 'pfp.png' };
                           return (
                               <div key={msg.id} className="mb-4 bg-[#2f3136] p-3 rounded border border-white/5 cursor-pointer hover:border-[#5865F2] transition-colors" onClick={() => {
                                  setActiveChannelId(msg.channelId);
                                  setModals(m => ({...m, search: false}));
                               }}>
                                  <div className="flex items-center gap-2 mb-1">
                                      <img src={sender.avatar} style={getAvatarStyle(sender.avatar, sender.username)} className="w-5 h-5 rounded-full object-cover shrink-0" />
                                      <span className="font-bold text-sm text-white">{sender.username}</span>
                                      <span className="text-xs text-[#72767d] ml-auto">{new Date(msg.timestamp).toLocaleDateString()}</span>
                                  </div>
                                  <div className="text-[#dcddde] text-sm line-clamp-2">{msg.text || '[Image Attachment]'}</div>
                               </div>
                           )
                       })
                    )}
                 </div>
               </div>
             </div>
          ) : null}

          {/* Notifications Modal */}
          {modals.notifications ? (
             <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={() => setModals(m => ({ ...m, notifications: false }))}>
               <div className="bg-[#36393f] w-full max-w-sm max-h-[80vh] rounded-lg shadow-2xl flex flex-col border border-white/5" onClick={e => e.stopPropagation()}>
                 <div className="p-4 border-b border-black/20 flex items-center justify-between shrink-0">
                    <h2 className="font-bold text-white flex items-center gap-2"><Bell size={20} className="text-[#5865F2]" /> Notifications</h2>
                    <button type="button" className="shrink-0 p-1 hover:bg-white/10 rounded" onClick={() => setModals(m => ({ ...m, notifications: false }))}><X className="text-[#8e9297]" size={20} /></button>
                 </div>
                 <div className="flex-1 overflow-y-auto p-4 hide-scrollbar">
                    {myNotifications.length === 0 ? (
                       <div className="text-center text-[#8e9297] my-10">You have no new notifications.</div>
                    ) : (
                       myNotifications.map(msg => {
                           const sender = data.users.find(u => u.uid === msg.senderId) || { username: 'Unknown User', avatar: 'pfp.png' };
                           return (
                               <div key={msg.id} className="mb-3 bg-[#2f3136] p-3 rounded border-l-4 border-l-[#5865F2] cursor-pointer hover:bg-[#202225] transition-colors" onClick={() => {
                                  switchContext('home');
                                  setActiveChannelId(msg.channelId);
                                  setModals(m => ({...m, notifications: false}));
                               }}>
                                  <div className="text-xs text-[#b9bbbe] mb-1">New Direct Message from <strong>{sender.username}</strong></div>
                                  <div className="text-[#dcddde] text-sm truncate">{msg.text || '[Image Attachment]'}</div>
                                  <div className="text-[10px] text-[#72767d] mt-1">{new Date(msg.timestamp).toLocaleString()}</div>
                               </div>
                           )
                       })
                    )}
                 </div>
               </div>
             </div>
          ) : null}

          {/* Server Settings */}
          {modals.serverSettings && activeServer ? (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={() => setModals(m => ({ ...m, serverSettings: false }))}>
              <div className="bg-[#36393f] w-full max-w-md rounded-lg p-6 shadow-2xl border border-white/5" onClick={e => e.stopPropagation()}>
                <h2 className="text-xl md:text-2xl font-bold text-white mb-6 text-center">Server Settings</h2>
                <div className="mb-6">
                  <label className="block text-xs font-bold text-[#8e9297] uppercase mb-2">Server Name</label>
                  <input type="text" id="edit-server-name" defaultValue={activeServer.name} className="w-full bg-[#202225] text-white p-2.5 rounded border border-black/30 focus:border-[#5865F2] outline-none" />
                </div>
                <div className="flex justify-between items-center mt-8 border-t border-white/10 pt-6">
                  <button type="button" onClick={async () => {
                      const val = document.getElementById('edit-server-name').value.trim();
                      if (val && val !== activeServer.name) {
                          await supabase.from('servers').update({ name: val }).eq('id', activeServer.id);
                          showToast('Server name updated', 'success');
                      }
                      setModals(m => ({ ...m, serverSettings: false }));
                  }} className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-6 py-2 rounded font-medium transition-colors">Save Changes</button>
                  
                  <button type="button" onClick={async () => {
                      if (confirm('Are you sure you want to delete this server? This cannot be undone.')) {
                          await supabase.from('servers').delete().eq('id', activeServer.id);
                          setModals(m => ({ ...m, serverSettings: false }));
                          switchContext('home');
                          showToast('Server deleted', 'success');
                      }
                  }} className="text-[#ed4245] hover:underline text-sm font-medium">Delete Server</button>
                </div>
              </div>
            </div>
          ) : null}

          {/* Create Server Modal */}
          {modals.createServer ? (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={() => setModals(m => ({ ...m, createServer: false }))}>
              <div className="bg-[#36393f] w-full max-w-md rounded-lg p-6 shadow-2xl border border-white/5" onClick={e => e.stopPropagation()}>
                <h2 className="text-xl md:text-2xl font-bold text-white mb-2 text-center">Customize your server</h2>
                <p className="text-center text-[#b9bbbe] mb-6 text-sm">Give your new server a personality with a name.</p>
                <form onSubmit={handleCreateServer}>
                  <div className="mb-6">
                    <label className="block text-xs font-bold text-[#8e9297] uppercase mb-2">Server Name</label>
                    <input name="name" autoFocus placeholder={(profile ? profile.username : '') + "'s server"} className="w-full bg-[#202225] text-white p-2.5 rounded border border-black/30 focus:border-[#5865F2] outline-none" required />
                  </div>
                  <div className="flex justify-between items-center bg-[#2f3136] -m-6 p-4 mt-2 rounded-b-lg">
                    <button type="button" onClick={() => setModals(m => ({ ...m, createServer: false }))} className="text-white hover:underline px-4 py-2 text-sm">Back</button>
                    <button type="submit" className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-6 py-2 rounded font-medium transition-colors">Create</button>
                  </div>
                </form>
              </div>
            </div>
          ) : null}

          {/* Create Channel Modal */}
          {modals.createChannel ? (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={() => setModals(m => ({ ...m, createChannel: false }))}>
              <div className="bg-[#36393f] w-full max-w-md rounded-lg p-6 shadow-2xl border border-white/5" onClick={e => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-xl font-bold text-white">Create Text Channel</h2>
                  <button type="button" onClick={() => setModals(m => ({ ...m, createChannel: false }))} className="text-[#8e9297] hover:text-white"><X size={20}/></button>
                </div>
                <form onSubmit={handleCreateChannel}>
                  <div className="mb-6">
                    <label className="block text-xs font-bold text-[#8e9297] uppercase mb-2">Channel Name</label>
                    <div className="relative flex items-center bg-[#202225] rounded border border-black/30 focus-within:border-[#5865F2]">
                      <Hash className="absolute left-2 text-[#8e9297] shrink-0" size={18} />
                      <input name="name" autoFocus placeholder="new-channel" className="w-full bg-transparent text-white p-2.5 pl-8 outline-none" required />
                    </div>
                  </div>
                  <div className="flex justify-end gap-3 bg-[#2f3136] -m-6 p-4 mt-2 rounded-b-lg">
                    <button type="button" onClick={() => setModals(m => ({ ...m, createChannel: false }))} className="text-white hover:underline px-4 py-2 text-sm">Cancel</button>
                    <button type="submit" className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-6 py-2 rounded font-medium transition-colors">Create Channel</button>
                  </div>
                </form>
              </div>
            </div>
          ) : null}

          {/* User Profile Modal */}
          {modals.profile ? (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4" onClick={() => { setModals(m => ({ ...m, profile: null })); setProfileMenuOpen(false); }}>
              <div className="w-full max-w-[340px] bg-[#292b2f] rounded-lg shadow-2xl overflow-visible border border-[#202225] animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                <div className="h-24 bg-gradient-to-r from-[#5865F2] to-purple-600 relative shrink-0 rounded-t-lg" />
                <div className="px-4 pb-4 relative">
                  <div className="absolute -top-12 left-4 rounded-full border-[6px] border-[#292b2f] bg-[#292b2f] w-[92px] h-[92px] shrink-0">
                    <img src={modals.profile.avatar || 'pfp.png'} className="w-full h-full rounded-full object-cover bg-[#202225] shrink-0" alt="User Avatar" style={getAvatarStyle(modals.profile.avatar, modals.profile.username)} />
                    <div className={"absolute bottom-1 right-1 w-5 h-5 border-[3px] border-[#292b2f] rounded-full " + (modals.profile.status === 'online' ? 'bg-[#3ba55c]' : 'bg-[#747f8d]')} />
                  </div>
                  
                  <div className="bg-[#1a1d21] rounded-lg p-3 mt-16 mb-4 border border-white/5">
                    <div className="text-xl font-bold text-white flex items-center gap-2 flex-wrap">
                      {modals.profile.username}
                      {modals.profile.isAdmin ? <span className="bg-amber-400 text-black text-[10px] px-1.5 py-0.5 rounded-sm tracking-wider h-fit">ADMIN</span> : null}
                    </div>
                    <div className="text-sm text-[#b9bbbe]">#{modals.profile.uid.substring(0,6)}</div>
                    
                    <hr className="my-3 border-white/10" />
                    
                    <div className="text-xs font-bold text-[#8e9297] uppercase mb-1">About Me</div>
                    <div className="text-sm text-[#dcddde] break-words whitespace-pre-wrap max-h-24 overflow-y-auto hide-scrollbar">
                      {modals.profile.bio || "This user hasn't set a bio yet."}
                    </div>
                    <div className="text-xs font-bold text-[#8e9297] uppercase mb-1 mt-4">NeoChat Member Since</div>
                    <div className="text-sm text-[#dcddde]">
                      {new Date(modals.profile.lastActive || Date.now()).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                    </div>
                  </div>

                  {modals.profile.uid === profile.uid ? (
                    <button type="button" onClick={() => setModals(m => ({ ...m, profile: null, settings: true }))} className="w-full bg-[#4f545c] hover:bg-[#5d6269] text-white py-2 rounded text-sm font-medium transition-colors">
                      Edit User Profile
                    </button>
                  ) : (
                    <div className="flex gap-2 relative">
                      <button type="button" onClick={() => handleStartDM(modals.profile)} className="flex-1 bg-[#5865F2] hover:bg-[#4752c4] text-white py-2 rounded text-sm font-medium transition-colors">
                        Send Message
                      </button>
                      <button type="button" onClick={() => setProfileMenuOpen(!profileMenuOpen)} className="bg-[#4f545c] hover:bg-[#5d6269] px-3 rounded transition-colors text-white flex items-center justify-center shrink-0">
                         <span className="font-bold tracking-widest leading-none block transform -translate-y-1">...</span>
                      </button>

                      {/* Dropdown Menu for Other Users */}
                      {profileMenuOpen && (
                         <div className="absolute bottom-full right-0 mb-2 w-48 bg-[#18191c] rounded shadow-xl border border-white/5 py-1 z-[110]">
                            <button type="button" className="w-full text-left px-3 py-2 text-sm text-[#ed4245] hover:bg-[#ed4245] hover:text-white transition-colors flex items-center gap-2" onClick={() => { showToast(`You blocked ${modals.profile.username}.`, "error"); setProfileMenuOpen(false); }}>
                                <ShieldBan size={14} /> Block User
                            </button>
                            <button type="button" className="w-full text-left px-3 py-2 text-sm text-[#ed4245] hover:bg-[#ed4245] hover:text-white transition-colors flex items-center gap-2" onClick={() => { showToast(`Reported ${modals.profile.username} to Trust & Safety.`, "error"); setProfileMenuOpen(false); }}>
                                <AlertCircle size={14} /> Report User
                            </button>
                         </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
          ) : null}

          {/* Personal Settings */}
          {modals.settings ? (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={() => setModals(m => ({ ...m, settings: false }))}>
              <div className="bg-[#36393f] w-full max-w-2xl h-full max-h-[85vh] rounded-lg shadow-2xl flex flex-col md:flex-row overflow-hidden border border-white/10" onClick={e => e.stopPropagation()}>
                
                {/* Settings Left Menu (Top on Mobile) */}
                <div className="w-full md:w-1/3 bg-[#2f3136] p-4 md:p-6 flex flex-row md:flex-col overflow-x-auto hide-scrollbar shrink-0 border-b md:border-b-0 md:border-r border-black/20">
                  <div className="hidden md:block text-xs font-bold text-[#8e9297] uppercase mb-2 px-2">User Settings</div>
                  <div className="bg-[#393c43] text-white px-3 py-1.5 rounded mr-2 md:mr-0 md:mb-1 cursor-pointer font-medium whitespace-nowrap shrink-0">My Account</div>
                  <div className="text-[#b9bbbe] hover:bg-white/5 px-3 py-1.5 rounded mr-2 md:mr-0 md:mb-4 cursor-pointer whitespace-nowrap shrink-0" onClick={() => showToast("Profiles settings coming soon", "info")}>Profiles</div>
                  <div className="hidden md:block text-xs font-bold text-[#8e9297] uppercase mb-2 px-2 md:mt-4">App Settings</div>
                  <div className="text-[#b9bbbe] hover:bg-white/5 px-3 py-1.5 rounded mr-2 md:mr-0 md:mb-1 cursor-pointer whitespace-nowrap shrink-0" onClick={() => showToast("Appearance settings coming soon", "info")}>Appearance</div>
                  <div className="text-[#b9bbbe] hover:bg-white/5 px-3 py-1.5 rounded md:mb-1 cursor-pointer whitespace-nowrap shrink-0" onClick={() => showToast("Notification settings coming soon", "info")}>Notifications</div>
                  
                  <div className="hidden md:block mt-auto border-t border-white/10 pt-4">
                     <button type="button" onClick={handleLogout} className="flex items-center justify-center gap-2 bg-[#ed4245] hover:bg-[#c9383b] text-white px-3 py-2 rounded w-full transition-colors font-bold shadow-sm">
                       <LogOut size={16}/> Log Out
                     </button>
                  </div>
                </div>

                {/* Settings Content Area */}
                <div className="w-full md:w-2/3 p-6 md:p-10 overflow-y-auto relative hide-scrollbar flex-1">
                  <div className="absolute top-4 right-4 md:top-6 md:right-6 p-1 text-[#8e9297] hover:text-white cursor-pointer hover:bg-white/10 rounded-full transition-all border-2 border-transparent hover:border-white/20" onClick={() => setModals(m => ({ ...m, settings: false }))}>
                    <X size={20} />
                  </div>
                  
                  <h2 className="text-xl font-bold text-white mb-6">My Account</h2>
                  
                  <div className="bg-[#202225] rounded-lg mb-6 relative overflow-hidden border border-white/5">
                    <div className="h-20 md:h-24 bg-[#5865F2] w-full shrink-0" />
                    <div className="px-4 pb-4 relative">
                      
                      <div className="absolute -top-10 md:-top-12 left-4 w-20 h-20 md:w-24 md:h-24 rounded-full border-4 md:border-[6px] border-[#202225] bg-[#36393f] overflow-hidden shrink-0">
                         <img src={profile.avatar || 'pfp.png'} className="w-full h-full object-cover" alt="" style={getAvatarStyle(profile.avatar, profile.username)} />
                      </div>

                      <div className="mt-14 md:mt-16 flex flex-col md:flex-row md:justify-between md:items-end mb-2 gap-4">
                        <div>
                           <div className="text-xl font-bold text-white leading-tight">{profile.username}</div>
                           <div className="text-sm text-[#b9bbbe]">#{profile.uid.substring(0,4)}</div>
                        </div>
                        <label className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-4 py-2 md:py-1.5 rounded text-sm font-medium cursor-pointer transition-colors w-full md:w-auto text-center shrink-0">
                          Edit Avatar
                          <input type="file" hidden accept="image/*" onChange={async (e) => {
                             const f = e.target.files[0];
                             if(f) {
                               try {
                                 showToast("Compressing new avatar...", "info");
                                 const compressedAvatar = await compressImage(f, 400, 400, 0.8);
                                 updateProfile({ avatar: compressedAvatar });
                                 showToast("Avatar updated!", "success");
                               } catch (err) {
                                 showToast("Error updating avatar", "error");
                               }
                             }
                          }}/>
                        </label>
                      </div>

                      <div className="bg-[#2f3136] rounded p-4 border border-white/5 mt-4">
                        <div className="mb-4">
                           <label className="block text-xs font-bold text-[#8e9297] uppercase mb-1">Username</label>
                           <div className="text-white font-medium">{profile.username}</div>
                        </div>
                        <div>
                           <label className="block text-xs font-bold text-[#8e9297] uppercase mb-1">Bio</label>
                           <textarea 
                              className="w-full bg-[#202225] text-white p-2 rounded border border-black/30 focus:border-[#5865F2] outline-none text-sm resize-none" 
                              rows="3"
                              defaultValue={profile.bio}
                              onBlur={(e) => {
                                updateProfile({ bio: e.target.value });
                              }}
                              placeholder="Tell everyone a little about yourself..."
                           />
                        </div>
                      </div>

                    </div>
                  </div>

                  <div className="md:hidden mt-6 pt-6 border-t border-white/10">
                     <button type="button" onClick={handleLogout} className="flex items-center justify-center gap-2 bg-[#ed4245] hover:bg-[#c9383b] text-white px-3 py-3 rounded w-full transition-colors font-bold shadow-sm">
                       <LogOut size={18}/> Log Out
                     </button>
                  </div>
                </div>

              </div>
            </div>
          ) : null}

        </div>
      );
    }

    // Mount the App
    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
