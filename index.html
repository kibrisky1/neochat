<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NeoChat Web</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Babel for running React JSX directly in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Import Maps -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.39.3"
      }
    }
  </script>

  <style>
    /* THEME ENGINE */
    :root {
      --bg-base: #2b2f33;
      --bg-panel: #36393f;
      --bg-sidebar: #2f3136;
      --bg-rail: #1a1d21;
      --bg-input: #202225;
      --bg-userpanel: #292b2f;
      --text-main: #dcddde;
      --text-muted: #b9bbbe;
      --text-faded: #8e9297;
      --border-light: rgba(255,255,255,0.05);
      --border-dark: rgba(0,0,0,0.2);
    }
    body.theme-light {
      --bg-base: #e3e5e8;
      --bg-panel: #ffffff;
      --bg-sidebar: #f2f3f5;
      --bg-rail: #e3e5e8;
      --bg-input: #ebedef;
      --bg-userpanel: #ebedef;
      --text-main: #313338;
      --text-muted: #4e5058;
      --text-faded: #5c5e66;
      --border-light: rgba(0,0,0,0.08);
      --border-dark: rgba(0,0,0,0.1);
    }
    body.theme-oled {
      --bg-base: #000000;
      --bg-panel: #000000;
      --bg-sidebar: #050505;
      --bg-rail: #000000;
      --bg-input: #111111;
      --bg-userpanel: #0a0a0a;
      --text-main: #f3f4f6;
      --text-muted: #d1d5db;
      --text-faded: #9ca3af;
      --border-light: rgba(255,255,255,0.1);
      --border-dark: rgba(255,255,255,0.05);
    }

    body { background-color: var(--bg-base); color: var(--text-main); overscroll-behavior-y: none; }
    
    .hide-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
    .hide-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .hide-scrollbar::-webkit-scrollbar-thumb { background-color: var(--bg-input); border-radius: 10px; }
    .hide-scrollbar:hover::-webkit-scrollbar-thumb { background-color: var(--bg-rail); }
  </style>
</head>
<body class="overflow-hidden theme-dark">
  
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { createClient } from '@supabase/supabase-js';
    import { 
      Hash, Search, Bell, Users, Plus, Compass, Settings, 
      Mic, MicOff, Headphones, Send, Paperclip, X, Check, LogOut, User, Database, Mail, Lock, Menu, AlertCircle, ShieldBan, MessageSquare, Monitor, Image as ImageIcon, Trash2, UserPlus, UserMinus, UserCheck, UserX
    } from 'lucide-react';

    // ==========================================
    // ðŸ›‘ SUPABASE CONFIG
    // ==========================================
    const supabaseUrl = 'https://cwsslsvuslimptikvrds.supabase.co'; 
    const supabaseKey = 'sb_publishable_OETJRLtsxWNsEMTi61PpsA_QXfQqu41';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // --- Audio Assets ---
    const MESSAGE_SOUND = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqOkZSWl5iZmZmYl5aUkY6KhYGAfXl1cW5ramhlYmBdW1lXVlVUU1NTVFVWV1ldYGJlaGpucXV5fYCBhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en4=');

    // --- Helper Functions ---
    const generateId = (prefix) => prefix + "_" + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    
    const getPalette = (seed) => {
        const palettes = ['#ef4444', '#f97316', '#f59e0b', '#10b981', '#22c55e', '#8b5cf6', '#d946ef', '#f43f5e', '#a855f7'];
        if (!seed) return palettes[0];
        let hash = 0;
        for (let i = 0; i < seed.length; i++) hash = seed.charCodeAt(i) + ((hash << 5) - hash);
        return palettes[Math.abs(hash) % palettes.length];
    };

    const getAvatarStyle = (avatarUrl, username) => {
        if (!avatarUrl || avatarUrl === 'pfp.png') return { backgroundColor: getPalette(username) };
        return {};
    };

    const getDeletedUser = (uid) => {
        const str = uid || "unknown";
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const num = Math.abs(hash) % 10000;
        return { 
            uid: str, 
            username: `deleted_user${num.toString().padStart(4, '0')}`, 
            nickname: `deleted_user${num.toString().padStart(4, '0')}`,
            avatar: 'pfp.png', 
            color: '#747f8d',
            bio: '',
            isDeleted: true 
        };
    };

    const parseMarkdown = (text) => {
      if (!text) return { __html: '' };
      let html = String(text)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/__(.*?)__/g, '<u>$1</u>')
        .replace(new RegExp('`(.*?)`', 'g'), '<code class="bg-[var(--bg-input)] px-1 rounded text-[#eb459e]">$1</code>')
        .replace(/\n/g, '<br />');
      html = html.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-[#00aff4] hover:underline">$1</a>');
      return { __html: html };
    };

    const compressImage = (file, maxWidth = 1200, maxHeight = 1200, quality = 0.7) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let { width, height } = img;
            if (width > height) { if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; } } 
            else { if (height > maxHeight) { width = Math.round((width * maxHeight) / height); height = maxHeight; } }
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = reject;
        };
        reader.onerror = reject;
      });
    };

    const isOnline = (lastActive) => (Date.now() - (lastActive || 0)) < 120000;

    function App() {
      const [user, setUser] = useState(null);
      const [data, setData] = useState({ users: [], servers: [], channels: [], messages: [] });
      const [isLoading, setIsLoading] = useState(true);
      
      const profile = user ? data.users.find(u => u.uid === user.uid) : null;
      
      // App State
      const [context, setContext] = useState('home'); 
      const [activeServerId, setActiveServerId] = useState(null);
      const [activeChannelId, setActiveChannelId] = useState(null);
      const [homeTab, setHomeTab] = useState('online'); 
      const [closedDMs, setClosedDMs] = useState(() => JSON.parse(localStorage.getItem('neochat_closed_dms') || '{}'));
      
      const [leftMenuOpen, setLeftMenuOpen] = useState(false);
      const [hasAutoOpened, setHasAutoOpened] = useState(false);
      const [membersSidebarOpen, setMembersSidebarOpen] = useState(false);
      const [dmProfileSidebarOpen, setDmProfileSidebarOpen] = useState(true);
      const [profileMenuOpen, setProfileMenuOpen] = useState(false);
      const [settingsTab, setSettingsTab] = useState('account');
      
      const [micMuted, setMicMuted] = useState(false);
      const [deafened, setDeafened] = useState(false);
      
      const [authMode, setAuthMode] = useState('login'); 
      const [inputText, setInputText] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [toast, setToast] = useState(null);
      const [imageView, setImageView] = useState(null); 
      const messagesEndRef = useRef(null);

      const [modals, setModals] = useState({ createServer: false, createChannel: false, settings: false, profile: null, serverSettings: false, search: false, notifications: false });

      // Apply initial theme
      useEffect(() => {
          document.body.className = `overflow-hidden theme-${localStorage.getItem('neochat_theme') || 'dark'}`;
      }, []);

      useEffect(() => {
        if (supabaseUrl === 'YOUR_SUPABASE_URL') return setIsLoading(false);
        supabase.auth.getSession().then(({ data: { session } }) => { if (session) setUser({ uid: session.user.id }); else setIsLoading(false); });
        const { data: authListener } = supabase.auth.onAuthStateChange((event, session) => { if (session) setUser({ uid: session.user.id }); else { setUser(null); setIsLoading(false); } });
        return () => authListener.subscription.unsubscribe();
      }, []);

      useEffect(() => {
        if (!user?.uid || supabaseUrl === 'YOUR_SUPABASE_URL') return;
        let channel;

        const fetchInitialData = async () => {
            const [usersReq, serversReq, channelsReq, messagesReq] = await Promise.all([
                supabase.from('users').select('*'),
                supabase.from('servers').select('*'),
                supabase.from('channels').select('*'),
                supabase.from('messages').select('*').order('timestamp', { ascending: true })
            ]);
            setData({ users: usersReq.data || [], servers: serversReq.data || [], channels: channelsReq.data || [], messages: messagesReq.data || [] });
            setIsLoading(false);

            channel = supabase.channel('db-changes')
              .on('postgres_changes', { event: '*', schema: 'public' }, (payload) => {
                const { table, eventType, new: newRecord, old: oldRecord } = payload;
                setData(prev => {
                  const next = { ...prev };
                  if (!next[table]) return prev;
                  if (eventType === 'INSERT') { if (!next[table].find(item => item.id === newRecord.id)) next[table] = [...next[table], newRecord]; } 
                  else if (eventType === 'UPDATE') { next[table] = next[table].map(item => item.id === newRecord.id ? newRecord : item); } 
                  else if (eventType === 'DELETE') { next[table] = next[table].filter(item => item.id !== oldRecord.id); }
                  return next;
                });
              }).subscribe();
        };
        fetchInitialData();
        return () => { if (channel) supabase.removeChannel(channel); };
      }, [user?.uid]);

      useEffect(() => {
          if (!user?.uid || !profile) return;
          supabase.from('users').update({ lastActive: Date.now(), status: 'online' }).eq('id', user.uid);
          const pingInterval = setInterval(() => { supabase.from('users').update({ lastActive: Date.now(), status: 'online' }).eq('id', user.uid); }, 60000);
          return () => clearInterval(pingInterval);
      }, [user?.uid, profile?.id]);

      useEffect(() => {
          if (profile && !activeChannelId && window.innerWidth < 768 && !hasAutoOpened) { setLeftMenuOpen(true); setHasAutoOpened(true); }
      }, [profile, activeChannelId, hasAutoOpened]);

      const activeServer = useMemo(() => data.servers.find(s => s.id === activeServerId), [data.servers, activeServerId]);
      const serverChannels = useMemo(() => data.channels.filter(c => c.serverId === activeServerId).sort((a,b) => a.createdAt - b.createdAt), [data.channels, activeServerId]);
      const activeChannel = useMemo(() => data.channels.find(c => c.id === activeChannelId), [data.channels, activeChannelId]);
      
      const channelMessages = useMemo(() => {
        return data.messages.filter(m => m.channelId === activeChannelId).sort((a, b) => a.timestamp - b.timestamp);
      }, [data.messages, activeChannelId]);

      // All Accepted DMs (with latest activity mapping)
      const allDMs = useMemo(() => {
          if (!profile) return [];
          return data.channels.filter(c => c.serverId === 'dm' && c.name.includes(profile.uid)).map(c => {
              const otherUid = c.name.split('_').find(id => id !== profile.uid);
              const otherUser = data.users.find(u => u.uid === otherUid) || getDeletedUser(otherUid);
              const channelMsgs = data.messages.filter(m => m.channelId === c.id);
              const latestMsgTime = channelMsgs.length > 0 ? Math.max(...channelMsgs.map(m => m.timestamp)) : c.createdAt;
              return { ...c, targetUser: otherUser, latestActivity: latestMsgTime };
          }).sort((a,b) => b.latestActivity - a.latestActivity);
      }, [data.channels, data.users, data.messages, profile]);

      // Inbox DMs (Filter out manually closed ones unless new activity occurred)
      const activeDMs = useMemo(() => {
          return allDMs.filter(c => {
              const closedAt = closedDMs[c.id];
              if (!closedAt) return true;
              return c.latestActivity > closedAt; // Reappears if new message is sent
          });
      }, [allDMs, closedDMs]);

      // Pending Friend Requests
      const pendingRequests = useMemo(() => {
          if (!profile) return [];
          return data.channels.filter(c => c.serverId === 'request' && c.name.includes(profile.uid)).map(c => {
              const [uid1, uid2] = c.name.split('_');
              const isOutgoing = uid1 === profile.uid;
              const otherUid = isOutgoing ? uid2 : uid1;
              const otherUser = data.users.find(u => u.uid === otherUid) || getDeletedUser(otherUid);
              return { ...c, targetUser: otherUser, isOutgoing };
          }).sort((a,b) => b.createdAt - a.createdAt);
      }, [data.channels, data.users, profile]);

      const searchResults = useMemo(() => {
          if (!searchQuery.trim()) return [];
          return data.messages.filter(m => m.text && m.text.toLowerCase().includes(searchQuery.toLowerCase())).sort((a,b) => b.timestamp - a.timestamp).slice(0, 30);
      }, [data.messages, searchQuery]);

      const myNotifications = useMemo(() => {
          if (!profile) return [];
          const dmIds = allDMs.map(c => c.id);
          return data.messages.filter(m => dmIds.includes(m.channelId) && m.senderId !== profile.uid).sort((a,b) => b.timestamp - a.timestamp).slice(0, 10);
      }, [allDMs, data.messages, profile]);

      useEffect(() => {
        if (channelMessages.length > 0) {
          const lastMsg = channelMessages[channelMessages.length - 1];
          if (lastMsg && profile && lastMsg.senderId !== profile.uid && Date.now() - lastMsg.timestamp < 5000 && !deafened) {
            try { MESSAGE_SOUND.currentTime = 0; MESSAGE_SOUND.play().catch(() => {}); } catch(e) {}
            // Send Desktop Notification
            if ("Notification" in window && Notification.permission === "granted") {
                const senderName = data.users.find(u => u.uid === lastMsg.senderId)?.username || 'NeoChat User';
                new Notification(`New message from ${senderName}`, { body: lastMsg.text || 'Sent an image.' });
            }
          }
          scrollToBottom();
        }
      }, [channelMessages, profile, deafened, data.users]);

      const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      const showToast = (message, type = 'info') => { setToast({ message, type }); setTimeout(() => setToast(null), 3000); };

      // --- Auth Actions ---
      const handleAuth = async (e) => {
        e.preventDefault();
        const email = e.target.email.value.trim();
        const password = e.target.password.value;
        const username = e.target.username ? e.target.username.value.trim() : '';

        try {
            if (authMode === 'register') {
                const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });
                if (authError) throw authError;
                if (authData.user) {
                    const isDavid = username.toLowerCase().includes('david');
                    const finalUser = {
                        id: authData.user.id, uid: authData.user.id, username: username, nickname: username,
                        avatar: 'pfp.png', banner: '', color: getPalette(username), bio: '', 
                        isAdmin: isDavid, isBanned: false, status: 'online', lastActive: Date.now()
                    };
                    await supabase.from('users').upsert(finalUser);
                    if (!authData.session) showToast("Check your email to confirm your account!", "info");
                    else showToast("Account created!", "success");
                }
            } else {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                showToast("Logged in successfully!", "success");
            }
        } catch (error) { showToast(error.message, "error"); }
      };

      const handleLogout = async () => {
        await supabase.auth.signOut();
        setContext('home'); setActiveServerId(null); setActiveChannelId(null);
        showToast("Logged out successfully.", "success");
      };

      // --- Friend & DM Actions ---
      const handleSendRequest = async (targetUser) => {
          if (!profile || !targetUser) return;
          const reqName = `${profile.uid}_${targetUser.uid}`;
          const newReq = { id: generateId('chan'), serverId: 'request', name: reqName, createdAt: Date.now() };
          setData(prev => ({ ...prev, channels: [...prev.channels, newReq] }));
          await supabase.from('channels').insert(newReq);
          showToast(`Friend request sent to ${targetUser.username}!`, "success");
      };

      const handleAcceptRequest = async (channelId, targetUser) => {
          const uids = [profile.uid, targetUser.uid].sort();
          const dmName = uids.join('_');
          setData(prev => ({ ...prev, channels: prev.channels.map(c => c.id === channelId ? { ...c, serverId: 'dm', name: dmName } : c) }));
          await supabase.from('channels').update({ serverId: 'dm', name: dmName }).eq('id', channelId);
          showToast(`You are now friends with ${targetUser.username}!`, "success");
      };

      const handleRemoveFriendOrRequest = async (channelId) => {
          setData(prev => ({ ...prev, channels: prev.channels.filter(c => c.id !== channelId) }));
          await supabase.from('channels').delete().eq('id', channelId);
          if (activeChannelId === channelId) {
              setActiveChannelId(null);
              setContext('home');
          }
      };

      const handleStartDM = async (targetUser) => {
        if (!profile || !targetUser || targetUser.isDeleted) return;
        const uids = [profile.uid, targetUser.uid].sort();
        const dmName = uids.join('_');
        let dmChannel = data.channels.find(c => c.serverId === 'dm' && c.name === dmName);
        
        if (!dmChannel) {
            // Check if there is a pending request to accept instead
            const pendingReq = data.channels.find(c => c.serverId === 'request' && (c.name === `${profile.uid}_${targetUser.uid}` || c.name === `${targetUser.uid}_${profile.uid}`));
            if (pendingReq) {
                await handleAcceptRequest(pendingReq.id, targetUser);
                dmChannel = { ...pendingReq, serverId: 'dm', name: dmName };
            } else {
                return showToast("You must be friends to send a direct message.", "error");
            }
        }

        if (closedDMs[dmChannel.id]) {
            const newClosed = { ...closedDMs };
            delete newClosed[dmChannel.id];
            setClosedDMs(newClosed);
            localStorage.setItem('neochat_closed_dms', JSON.stringify(newClosed));
        }

        setModals(m => ({ ...m, profile: null })); setLeftMenuOpen(false); setContext('home'); setActiveServerId(null); setActiveChannelId(dmChannel.id);
      };

      const handleCloseDM = (e, channelId) => {
          e.stopPropagation();
          const newClosed = { ...closedDMs, [channelId]: Date.now() };
          setClosedDMs(newClosed);
          localStorage.setItem('neochat_closed_dms', JSON.stringify(newClosed));
          if (activeChannelId === channelId) setActiveChannelId(null);
      };

      const handleAddFriendSubmit = async (e) => {
          e.preventDefault();
          const targetUsername = e.target.friend_username.value.trim().toLowerCase();
          if (!targetUsername) return;
          if (targetUsername === profile.username.toLowerCase()) return showToast("You cannot add yourself.", "error");
          
          const target = data.users.find(u => u.username.toLowerCase() === targetUsername);
          if (!target) return showToast("User not found. Check the exact username.", "error");

          const sortedUids = [profile.uid, target.uid].sort().join('_');
          if (data.channels.find(c => c.serverId === 'dm' && c.name === sortedUids)) {
              return showToast("You are already friends.", "info");
          }
          if (data.channels.find(c => c.serverId === 'request' && (c.name === `${profile.uid}_${target.uid}` || c.name === `${target.uid}_${profile.uid}`))) {
              return showToast("A friend request already exists.", "info");
          }

          await handleSendRequest(target);
          e.target.reset();
      };

      // --- Server Actions ---
      const handleCreateServer = async (e) => {
        e.preventDefault();
        const name = e.target.name.value.trim();
        if (!name) return;
        const serverId = generateId('srv'), channelId = generateId('chan');
        const newServer = { id: serverId, name: name, ownerId: profile.uid, createdAt: Date.now(), icon: "https://ui-avatars.com/api/?name=" + encodeURIComponent(name) + "&background=5865F2&color=fff&bold=true" };
        const newChannel = { id: channelId, serverId: serverId, name: 'general', createdAt: Date.now() };

        setData(prev => ({ ...prev, servers: [...prev.servers, newServer], channels: [...prev.channels, newChannel] }));
        await supabase.from('servers').insert(newServer);
        await supabase.from('channels').insert(newChannel);

        setModals(m => ({ ...m, createServer: false })); switchContext('server', serverId); setLeftMenuOpen(false);
        showToast("Server created!", "success");
      };

      const handleCreateChannel = async (e) => {
        e.preventDefault();
        const name = e.target.name.value.trim().toLowerCase().replace(/\s+/g, '-');
        if (!name || !activeServerId) return;
        const newChannel = { id: generateId('chan'), serverId: activeServerId, name: name, createdAt: Date.now() };
        setData(prev => ({ ...prev, channels: [...prev.channels, newChannel] }));
        await supabase.from('channels').insert(newChannel);
        setModals(m => ({ ...m, createChannel: false }));
        showToast("Channel created!", "success");
      };

      const sendMessage = async (e) => {
        if (e) e.preventDefault();
        if (!inputText.trim() || !activeChannelId) return;
        if (profile.isBanned) return showToast("You are banned from sending messages.", "error");

        const newMsg = { id: generateId('msg'), channelId: activeChannelId, text: inputText.trim(), senderId: profile.uid, timestamp: Date.now(), reactions: {} };
        setInputText('');
        setData(prev => ({ ...prev, messages: [...prev.messages, newMsg] }));
        await supabase.from('messages').insert(newMsg);
      };

      const handleImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (profile.isBanned) return showToast("You are banned from sending messages.", "error");

        try {
          showToast("Compressing image...", "info");
          const compressedBase64 = await compressImage(file, 1200, 1200, 0.8);
          const newMsg = { id: generateId('msg'), channelId: activeChannelId, text: '', imageUrl: compressedBase64, senderId: profile.uid, timestamp: Date.now(), reactions: {} };
          setData(prev => ({ ...prev, messages: [...prev.messages, newMsg] }));
          await supabase.from('messages').insert(newMsg);
        } catch (err) { showToast("Failed to upload image.", "error"); }
      };

      const toggleReaction = async (msgId, emoji, currentReactions) => {
        let rxns = { ...currentReactions };
        if (!rxns[emoji]) rxns[emoji] = [];
        if (rxns[emoji].includes(profile.uid)) { rxns[emoji] = rxns[emoji].filter(id => id !== profile.uid); if (rxns[emoji].length === 0) delete rxns[emoji]; } 
        else rxns[emoji].push(profile.uid);
        
        setData(prev => ({ ...prev, messages: prev.messages.map(m => m.id === msgId ? { ...m, reactions: rxns } : m) }));
        await supabase.from('messages').update({ reactions: rxns }).eq('id', msgId);
      };

      const handleDeleteMessage = async (msgId) => {
          if (confirm("Are you sure you want to delete this message?")) {
              // Optimistically remove it from UI instantly
              setData(prev => ({ ...prev, messages: prev.messages.filter(m => m.id !== msgId) }));
              // Delete from Supabase
              await supabase.from('messages').delete().eq('id', msgId);
          }
      };

      const updateProfile = async (updates) => {
        setData(prev => ({ ...prev, users: prev.users.map(u => u.uid === profile.uid ? { ...u, ...updates } : u) }));
        await supabase.from('users').update(updates).eq('id', profile.id);
      };

      // Admin Tools
      const adminDeleteUser = async (targetUid) => {
          if (!profile.isAdmin) return;
          if (confirm("Are you sure you want to delete this user? Their account will be converted to a ghost profile.")) {
             const ghostNum = Math.floor(1000 + Math.random() * 9000);
             const ghostUpdates = {
                 username: `deleted_user${ghostNum}`,
                 nickname: `deleted_user${ghostNum}`,
                 avatar: 'pfp.png',
                 banner: '',
                 bio: '',
                 color: '#747f8d',
                 isDeleted: true
             };
             await supabase.from('users').update(ghostUpdates).eq('uid', targetUid);
             setModals(m => ({ ...m, profile: null }));
             showToast("User deleted and converted to ghost.", "success");
          }
      };
      
      const adminClearMessages = async (targetUid) => {
          if (!profile.isAdmin) return;
          if (confirm("Purge all messages sent by this user?")) {
             await supabase.from('messages').delete().eq('senderId', targetUid);
             showToast("User messages purged.", "success");
          }
      };

      const adminBanUser = async (targetUid) => {
          if (!profile.isAdmin) return;
          await supabase.from('users').update({ isBanned: true }).eq('uid', targetUid);
          showToast("User banned.", "success");
      };

      // Profile Modal Utilities
      const getRelationshipStatus = (targetUid) => {
          if (!profile) return null;
          if (targetUid === profile.uid) return 'self';
          const sorted = [profile.uid, targetUid].sort().join('_');
          const isFriend = data.channels.find(c => c.serverId === 'dm' && c.name === sorted);
          if (isFriend) return { type: 'friend', channel: isFriend };
          const pending = data.channels.find(c => c.serverId === 'request' && (c.name === `${profile.uid}_${targetUid}` || c.name === `${targetUid}_${profile.uid}`));
          if (pending) return { type: 'pending', channel: pending, isOutgoing: pending.name.startsWith(profile.uid) };
          return { type: 'none' };
      };

      // --- UI States ---
      if (isLoading) return <div className="flex h-screen w-full items-center justify-center bg-[var(--bg-base)] text-white font-bold text-xl animate-pulse">Connecting...</div>;

      if (!profile) {
        return (
          <div className="flex h-screen w-full items-center justify-center bg-gradient-to-br from-[var(--bg-rail)] to-[var(--bg-base)] font-sans text-white overflow-hidden relative p-4">
            <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'radial-gradient(circle, #fff 1px, transparent 1px)', backgroundSize: '50px 50px' }} />
            
            <div className="bg-[var(--bg-panel)] p-6 md:p-8 rounded-2xl w-full max-w-[400px] shadow-2xl z-10 border border-[var(--border-light)] animate-in zoom-in-95 duration-300">
              {toast && <div className={"absolute top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-xl font-bold text-sm w-[90%] text-center z-[200] text-white " + (toast.type === 'success' ? 'bg-[#3ba55c]' : 'bg-[#ed4245]')}>{toast.message}</div>}

              <div className="text-center mb-6 mt-4">
                <img src="logo.png" alt="Logo" className="w-20 h-20 mx-auto mb-4 object-contain" onError={(e) => { e.target.onerror = null; e.target.style.display = 'none'; }} />
                <h2 className="text-2xl font-bold mb-2 text-[var(--text-main)]">NeoChat Web</h2>
                <p className="text-[var(--text-muted)] text-sm">Global Real-time Communities</p>
              </div>

              <div className="flex border-b border-[var(--border-dark)] mb-6 pb-2">
                <button type="button" onClick={() => setAuthMode('login')} className={"flex-1 text-center pb-2 font-bold text-sm transition-colors " + (authMode === 'login' ? 'text-[var(--text-main)] border-b-2 border-[#5865F2]' : 'text-[var(--text-faded)] hover:text-[var(--text-muted)]')}>Login</button>
                <button type="button" onClick={() => setAuthMode('register')} className={"flex-1 text-center pb-2 font-bold text-sm transition-colors " + (authMode === 'register' ? 'text-[var(--text-main)] border-b-2 border-[#5865F2]' : 'text-[var(--text-faded)] hover:text-[var(--text-muted)]')}>Register</button>
              </div>

              <form onSubmit={handleAuth} className="space-y-4">
                {authMode === 'register' && (
                  <div>
                    <label className="block text-[var(--text-muted)] text-xs font-bold uppercase tracking-wider mb-2">Username</label>
                    <div className="relative">
                      <User className="absolute left-3 top-3.5 text-[var(--text-faded)]" size={16} />
                      <input name="username" required placeholder="Display Name" autoComplete="off" className="w-full bg-[var(--bg-input)] border border-[var(--border-dark)] rounded px-10 py-3 text-[var(--text-main)] focus:outline-none focus:border-[#5865F2] transition-all" />
                    </div>
                  </div>
                )}
                <div>
                  <label className="block text-[var(--text-muted)] text-xs font-bold uppercase tracking-wider mb-2">Email Address</label>
                  <div className="relative">
                    <Mail className="absolute left-3 top-3.5 text-[var(--text-faded)]" size={16} />
                    <input name="email" type="email" required placeholder="you@example.com" className="w-full bg-[var(--bg-input)] border border-[var(--border-dark)] rounded px-10 py-3 text-[var(--text-main)] focus:outline-none focus:border-[#5865F2] transition-all" />
                  </div>
                </div>
                <div>
                  <label className="block text-[var(--text-muted)] text-xs font-bold uppercase tracking-wider mb-2">Password</label>
                  <div className="relative">
                    <Lock className="absolute left-3 top-3.5 text-[var(--text-faded)]" size={16} />
                    <input name="password" type="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" minLength="6" className="w-full bg-[var(--bg-input)] border border-[var(--border-dark)] rounded px-10 py-3 text-[var(--text-main)] focus:outline-none focus:border-[#5865F2] transition-all" />
                  </div>
                </div>
                <button type="submit" className="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white font-bold py-3 px-4 rounded transition-all mt-4">{authMode === 'login' ? 'Sign In' : 'Create Account'}</button>
              </form>
            </div>
          </div>
        );
      }

      let activeChannelInfo = { name: 'select-channel', isDM: false };
      if (activeChannelId) {
         if (context === 'server' && activeChannel) activeChannelInfo = { name: activeChannel.name, isDM: false };
         else if (context === 'home') {
             const ch = allDMs.find(c => c.id === activeChannelId);
             if (ch) activeChannelInfo = { name: ch.targetUser.nickname || ch.targetUser.username, avatar: ch.targetUser.avatar, color: ch.targetUser.color, banner: ch.targetUser.banner, isDM: true, targetUser: ch.targetUser };
         }
      }

      const pendingIncomingCount = pendingRequests.filter(r => !r.isOutgoing).length;

      // --- Main Layout ---
      return (
        <div className="flex h-screen w-full bg-[var(--bg-base)] text-[var(--text-main)] font-sans overflow-hidden selection:bg-[#5865F2]/50 relative">
          
          {toast && <div className={"fixed top-5 right-5 z-[200] px-6 py-4 rounded-lg shadow-2xl font-semibold flex items-center gap-3 animate-in slide-in-from-right-10 duration-300 text-white " + (toast.type === 'success' ? 'bg-[#3ba55c]' : 'bg-[#ed4245]')}><Check size={20} />{toast.message}</div>}

          {imageView && (
            <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[150] p-4 cursor-pointer" onClick={() => setImageView(null)}>
              <img src={imageView} className="max-w-full max-h-full object-contain cursor-default" alt="Fullscreen view" onClick={e => e.stopPropagation()} />
              <button type="button" onClick={() => setImageView(null)} className="absolute top-6 right-6 text-white hover:text-gray-300 transition-colors bg-black/50 p-2 rounded-full"><X size={24} /></button>
            </div>
          )}

          {/* MOBILE OVERLAYS */}
          {leftMenuOpen && <div className="fixed inset-0 bg-black/60 z-30 md:hidden" onClick={() => setLeftMenuOpen(false)}></div>}
          {membersSidebarOpen && <div className="fixed inset-0 bg-black/60 z-30 md:hidden" onClick={() => setMembersSidebarOpen(false)}></div>}

          {/* 1. Left Navigation Wrapper */}
          <div className={`fixed inset-y-0 left-0 z-40 md:relative md:z-auto h-full flex flex-row shrink-0 transform transition-transform duration-300 ${leftMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
            
            {/* Server Rail */}
            <div className="w-[72px] bg-[var(--bg-rail)] flex flex-col items-center py-3 gap-2 overflow-y-auto shrink-0 border-r border-[var(--border-dark)] hide-scrollbar">
              <button type="button" onClick={() => switchContext('home')} className={"relative w-12 h-12 rounded-[24px] hover:rounded-[16px] bg-[var(--bg-panel)] flex items-center justify-center transition-all duration-200 group shrink-0 " + (context === 'home' ? 'bg-[#5865F2] rounded-[16px] text-white' : 'text-[var(--text-main)] hover:bg-[#5865F2] hover:text-white')}>
                <div className={"absolute left-[-12px] w-2 bg-white rounded-r-full transition-all duration-200 " + (context === 'home' ? 'h-10 opacity-100' : 'h-5 opacity-0 group-hover:opacity-100')} />
                <div className="w-full h-full flex items-center justify-center p-2 rounded-inherit"><img src="logo.png" alt="Home" className="w-full h-full object-contain" onError={(e) => { e.target.onerror = null; e.target.src = 'pfp.png'; }} /></div>
                {pendingIncomingCount > 0 && <span className="absolute -top-1 -right-1 bg-[#ed4245] text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-[var(--bg-rail)]">{pendingIncomingCount}</span>}
              </button>
              
              <div className="w-8 h-[2px] bg-[var(--bg-sidebar)] rounded my-1 shrink-0" />

              {data.servers.map(srv => (
                <button key={srv.id} type="button" onClick={() => switchContext('server', srv.id)} className={"relative w-12 h-12 shrink-0 rounded-[24px] hover:rounded-[16px] flex items-center justify-center transition-all duration-200 group overflow-hidden " + (activeServerId === srv.id ? 'rounded-[16px]' : '')} title={srv.name}>
                  <div className={"absolute left-[-12px] w-2 bg-white rounded-r-full transition-all duration-200 z-10 " + (activeServerId === srv.id ? 'h-10 opacity-100' : 'h-5 opacity-0 group-hover:opacity-100')} />
                  <img src={srv.icon} alt={srv.name} className="w-full h-full object-cover" />
                </button>
              ))}

              <button type="button" onClick={() => setModals(m => ({ ...m, createServer: true }))} className="w-12 h-12 shrink-0 rounded-[24px] hover:rounded-[16px] bg-[var(--bg-panel)] text-[#3ba55c] hover:bg-[#3ba55c] hover:text-white flex items-center justify-center transition-all duration-200 mt-2"><Plus size={24} /></button>
              <button type="button" onClick={() => switchContext('discovery')} className="w-12 h-12 shrink-0 rounded-[24px] hover:rounded-[16px] bg-[var(--bg-panel)] text-[#3ba55c] hover:bg-[#3ba55c] hover:text-white flex items-center justify-center transition-all duration-200 mt-auto"><Compass size={24} /></button>
            </div>

            {/* Context Sidebar */}
            {context !== 'discovery' && (
              <div className="w-60 bg-[var(--bg-sidebar)] flex flex-col shrink-0 border-r border-[var(--border-dark)]">
                <div className="h-12 px-4 flex items-center justify-between font-bold text-[var(--text-main)] shadow-sm border-b border-[var(--border-dark)] transition-colors shrink-0">
                  <span className="truncate">{context === 'server' && activeServer ? activeServer.name : 'Direct Messages'}</span>
                  {context === 'server' && activeServer && profile && activeServer.ownerId === profile.uid && (
                    <button type="button" onClick={() => setModals(m => ({ ...m, serverSettings: true }))} className="p-1 hover:bg-[var(--border-light)] rounded transition-colors text-[var(--text-muted)] hover:text-[var(--text-main)] shrink-0" title="Server Settings"><Settings size={16} /></button>
                  )}
                </div>
                
                <div className="flex-1 overflow-y-auto p-2 hide-scrollbar">
                  {context === 'server' ? (
                    <React.Fragment>
                      <div className="flex items-center justify-between px-2 pt-4 pb-1 text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider group">
                        <span>Text Channels</span>
                        {profile.isAdmin && <button type="button" onClick={() => setModals(m => ({ ...m, createChannel: true }))} className="hover:text-[var(--text-main)] hidden group-hover:block"><Plus size={14}/></button>}
                      </div>
                      {serverChannels.map(ch => (
                        <button key={ch.id} type="button" onClick={() => { setActiveChannelId(ch.id); setLeftMenuOpen(false); }} className={"w-full flex items-center gap-2 px-2 py-1.5 mb-0.5 rounded transition-colors " + (activeChannelId === ch.id ? 'bg-[var(--border-light)] text-[var(--text-main)] font-medium' : 'text-[var(--text-faded)] hover:bg-[var(--border-light)] hover:text-[var(--text-main)]')}>
                          <Hash size={18} className="text-[var(--text-faded)] shrink-0" />
                          <span className="truncate">{ch.name}</span>
                        </button>
                      ))}
                    </React.Fragment>
                  ) : (
                    <React.Fragment>
                      <div className="text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider px-2 pt-4 pb-2">Direct Messages</div>
                      {activeDMs.length === 0 && <div className="text-center p-4 text-sm text-[var(--text-faded)] mt-4">No open conversations. Add a friend!</div>}
                      {activeDMs.map(ch => (
                        <div key={ch.id} onClick={() => { setActiveChannelId(ch.id); setLeftMenuOpen(false); }} className={"cursor-pointer relative group w-full flex items-center gap-3 px-2 py-1.5 mb-0.5 rounded transition-colors " + (activeChannelId === ch.id ? 'bg-[var(--border-light)] text-[var(--text-main)] font-medium' : 'text-[var(--text-faded)] hover:bg-[var(--border-light)] hover:text-[var(--text-main)]')}>
                          <div className="relative shrink-0 w-8 h-8">
                             <img src={ch.targetUser.avatar || 'pfp.png'} className={"w-8 h-8 rounded-full object-cover bg-[var(--bg-input)] " + (ch.targetUser.isDeleted ? 'opacity-50 grayscale' : '')} style={getAvatarStyle(ch.targetUser.avatar, ch.targetUser.username)} />
                             {!ch.targetUser.isDeleted && <div className={"absolute -bottom-0.5 -right-0.5 w-3 h-3 border-2 border-[var(--bg-sidebar)] rounded-full transition-colors " + (isOnline(ch.targetUser.lastActive) ? 'bg-[#3ba55c]' : 'bg-[#747f8d]')} />}
                          </div>
                          <span className="truncate pr-6">{ch.targetUser.nickname || ch.targetUser.username}</span>
                          <button type="button" onClick={(e) => handleCloseDM(e, ch.id)} className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 p-1 hover:text-[#ed4245] text-[var(--text-faded)] transition-all rounded z-10" title="Close DM">
                              <X size={14} />
                          </button>
                        </div>
                      ))}
                    </React.Fragment>
                  )}
                </div>

                {/* User Controls Panel */}
                <div className="h-[52px] bg-[var(--bg-userpanel)] flex items-center px-2 gap-2 border-t border-[var(--border-dark)] shrink-0">
                  <button type="button" onClick={() => setModals(m => ({ ...m, profile: profile }))} className="flex items-center gap-2 flex-1 min-w-0 hover:bg-[var(--border-light)] p-1 rounded transition-colors text-left">
                    <div className="relative shrink-0 w-8 h-8">
                      <img src={profile.avatar || 'pfp.png'} alt="Avatar" className="w-8 h-8 rounded-full bg-[var(--bg-input)] object-cover" style={getAvatarStyle(profile.avatar, profile.username)} />
                      <div className="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-[#3ba55c] border-2 border-[var(--bg-userpanel)] rounded-full" />
                    </div>
                    <div className="flex-1 min-w-0 leading-tight">
                      <div className="text-sm font-bold text-[var(--text-main)] truncate flex items-center gap-1">
                        {profile.nickname || profile.username}
                        {profile.isAdmin && <span className="bg-amber-400 text-black text-[9px] px-1 rounded-sm tracking-wider">ADMIN</span>}
                      </div>
                      <div className="text-xs text-[var(--text-faded)] truncate">#{profile.uid.substring(0,4)}</div>
                    </div>
                  </button>
                  <div className="flex text-[var(--text-muted)] shrink-0">
                    <button type="button" onClick={() => setMicMuted(!micMuted)} className={"p-1.5 rounded transition-colors " + (micMuted ? 'text-[#ed4245] hover:bg-[#ed4245]/10' : 'hover:bg-[var(--border-light)]')} title="Toggle Mic">{micMuted ? <MicOff size={18} /> : <Mic size={18} />}</button>
                    <button type="button" onClick={() => setDeafened(!deafened)} className={"p-1.5 rounded transition-colors " + (deafened ? 'text-[#ed4245] hover:bg-[#ed4245]/10' : 'hover:bg-[var(--border-light)]')} title="Toggle Audio"><Headphones size={18} className={deafened ? 'opacity-50' : ''} /></button>
                    <button type="button" onClick={() => setModals(m => ({ ...m, settings: true }))} className="p-1.5 hover:bg-[var(--border-light)] rounded" title="Settings"><Settings size={18} /></button>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* 3. Main Chat Area */}
          <div className="flex-1 flex flex-col min-w-0 bg-[var(--bg-panel)] relative h-full">
            {context === 'discovery' ? (
              <div className="flex-1 p-4 md:p-8 overflow-y-auto hide-scrollbar">
                <div className="md:hidden flex items-center gap-3 mb-6"><button type="button" onClick={() => setLeftMenuOpen(true)} className="p-2 bg-[var(--bg-input)] rounded text-[var(--text-main)]"><Menu size={24} /></button></div>
                <h1 className="text-2xl md:text-3xl font-bold text-[var(--text-main)] mb-6 flex items-center gap-3"><Compass className="text-[#5865F2] shrink-0" size={32}/> Global Servers</h1>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                  {data.servers.length === 0 && <div className="text-[var(--text-faded)]">No servers exist yet. Create one!</div>}
                  {data.servers.map(s => (
                    <div key={s.id} onClick={() => switchContext('server', s.id)} className="bg-[var(--bg-sidebar)] rounded-lg overflow-hidden cursor-pointer hover:-translate-y-1 hover:shadow-xl transition-all border border-[var(--border-light)] group">
                      <div className="h-24 bg-gradient-to-br from-[#5865F2] to-purple-600 relative overflow-hidden group-hover:opacity-90"><div className="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"/></div>
                      <div className="p-4 relative">
                        <img src={s.icon} className="absolute -top-10 left-4 w-16 h-16 rounded-xl border-4 border-[var(--bg-sidebar)] bg-[var(--bg-input)] shadow-lg object-cover shrink-0" alt=""/>
                        <div className="mt-8 font-bold text-[var(--text-main)] text-lg">{s.name}</div>
                        <div className="text-sm text-[var(--text-muted)] mt-1 line-clamp-2">A global community.</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ) : context === 'home' && !activeChannelId ? (
              <div className="flex-1 flex flex-col bg-[var(--bg-panel)] h-full overflow-hidden">
                <div className="h-12 px-4 flex items-center shadow-sm border-b border-[var(--border-dark)] shrink-0 bg-[var(--bg-panel)] gap-4">
                    <button type="button" className="md:hidden p-1 mr-1 text-[var(--text-muted)] hover:text-[var(--text-main)] shrink-0" onClick={() => setLeftMenuOpen(true)}><Menu size={20} /></button>
                    <div className="flex items-center gap-2 text-[var(--text-main)] font-bold px-2 border-r border-[var(--border-dark)] pr-4 shrink-0"><Users size={20} className="text-[var(--text-faded)]" /> Friends</div>
                    <div className="flex items-center gap-4 text-[var(--text-muted)] text-sm font-medium overflow-x-auto hide-scrollbar">
                        <button type="button" className={homeTab === 'online' ? 'text-[var(--text-main)]' : 'hover:text-[var(--text-main)]'} onClick={() => setHomeTab('online')}>Online</button>
                        <button type="button" className={homeTab === 'all' ? 'text-[var(--text-main)]' : 'hover:text-[var(--text-main)]'} onClick={() => setHomeTab('all')}>All</button>
                        <button type="button" className={homeTab === 'pending' ? 'text-[var(--text-main)] flex items-center gap-1' : 'hover:text-[var(--text-main)] flex items-center gap-1'} onClick={() => setHomeTab('pending')}>
                            Pending {pendingIncomingCount > 0 && <span className="bg-[#ed4245] text-white text-[10px] px-1.5 py-0.5 rounded-full leading-none">{pendingIncomingCount}</span>}
                        </button>
                        <button type="button" className={homeTab === 'add' ? 'bg-[#3ba55c] text-white px-2 py-0.5 rounded' : 'text-[#3ba55c] hover:bg-[#3ba55c]/20 px-2 py-0.5 rounded'} onClick={() => setHomeTab('add')}>Add Friend</button>
                    </div>
                    <div className="flex items-center gap-3 md:gap-4 text-[var(--text-muted)] shrink-0 ml-auto relative">
                      <button type="button" onClick={() => setModals(m => ({ ...m, notifications: true }))} className="hover:text-[var(--text-main)] p-1 rounded hover:bg-[var(--border-light)] transition-colors relative">
                        <Bell size={20} />{myNotifications.length > 0 && <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-[#ed4245] rounded-full border-2 border-[var(--bg-panel)]"></span>}
                      </button>
                    </div>
                </div>

                <div className="flex-1 p-4 md:p-8 overflow-y-auto hide-scrollbar flex justify-center">
                    {homeTab === 'add' ? (
                        <div className="w-full max-w-2xl mt-4">
                            <h2 className="text-[var(--text-main)] font-bold text-lg mb-2">ADD FRIEND</h2>
                            <p className="text-[var(--text-faded)] text-sm mb-4">You can add a friend with their exact NeoChat Username.</p>
                            <form onSubmit={handleAddFriendSubmit} className="flex items-center bg-[var(--bg-base)] border border-[var(--border-dark)] focus-within:border-[#5865F2] rounded-lg p-2 gap-3 transition-colors">
                                <input type="text" name="friend_username" placeholder="Exact username" className="flex-1 bg-transparent text-[var(--text-main)] placeholder-[var(--text-faded)] outline-none px-3 py-2" autoComplete="off" />
                                <button type="submit" className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-6 py-2 rounded font-medium transition-colors text-sm">Send Friend Request</button>
                            </form>
                            <div className="mt-10 border-t border-[var(--border-light)] pt-10 text-center">
                                <img src="pfp.png" className="w-48 h-48 mx-auto opacity-10 filter grayscale object-contain" alt="Empty" />
                                <p className="text-[var(--text-faded)] mt-4">Wumpus is waiting on friends. You don't have to though!</p>
                            </div>
                        </div>
                    ) : homeTab === 'pending' ? (
                        <div className="w-full max-w-3xl">
                            <h2 className="text-[var(--text-faded)] font-bold text-xs uppercase tracking-wider mb-4 border-b border-[var(--border-light)] pb-4">
                                PENDING REQUESTS â€” {pendingRequests.length}
                            </h2>
                            {pendingRequests.length === 0 && <div className="text-center text-[var(--text-faded)] mt-20">No pending friend requests.</div>}
                            <div className="flex flex-col">
                                {pendingRequests.map(req => (
                                    <div key={req.id} className="flex items-center justify-between p-3 border-t border-[var(--border-light)] hover:bg-[var(--bg-sidebar)] rounded transition-colors group cursor-pointer" onClick={() => setModals(m => ({ ...m, profile: req.targetUser }))}>
                                        <div className="flex items-center gap-3">
                                            <div className="relative shrink-0 w-10 h-10">
                                               <img src={req.targetUser.avatar || 'pfp.png'} className={"w-10 h-10 rounded-full object-cover bg-[var(--bg-input)] " + (req.targetUser.isDeleted ? 'opacity-50 grayscale' : '')} style={getAvatarStyle(req.targetUser.avatar, req.targetUser.username)} />
                                            </div>
                                            <div className="flex flex-col">
                                                <span className="font-bold text-[var(--text-main)]">{req.targetUser.nickname || req.targetUser.username}</span>
                                                <span className="text-xs text-[var(--text-faded)]">{req.isOutgoing ? 'Outgoing Friend Request' : 'Incoming Friend Request'}</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {!req.isOutgoing && (
                                                <button type="button" onClick={(e) => { e.stopPropagation(); handleAcceptRequest(req.id, req.targetUser); }} className="p-2 bg-[var(--bg-input)] hover:bg-[#3ba55c] text-[var(--text-muted)] hover:text-white rounded-full transition-colors" title="Accept"><Check size={18} /></button>
                                            )}
                                            <button type="button" onClick={(e) => { e.stopPropagation(); handleRemoveFriendOrRequest(req.id); }} className="p-2 bg-[var(--bg-input)] hover:bg-[#ed4245] text-[var(--text-muted)] hover:text-white rounded-full transition-colors" title={req.isOutgoing ? "Cancel" : "Decline"}><X size={18} /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ) : (
                        <div className="w-full max-w-3xl">
                            <h2 className="text-[var(--text-faded)] font-bold text-xs uppercase tracking-wider mb-4 border-b border-[var(--border-light)] pb-4">
                                {homeTab === 'online' ? `ONLINE â€” ${allDMs.filter(c => isOnline(c.targetUser.lastActive) && !c.targetUser.isDeleted).length}` : `ALL FRIENDS â€” ${allDMs.length}`}
                            </h2>
                            {allDMs.length === 0 && <div className="text-center text-[var(--text-faded)] mt-20">You don't have any friends added yet. Try the "Add Friend" tab!</div>}
                            <div className="flex flex-col">
                                {allDMs.filter(c => homeTab === 'all' || (isOnline(c.targetUser.lastActive) && !c.targetUser.isDeleted)).map(ch => (
                                    <div key={ch.id} className="flex items-center justify-between p-3 border-t border-[var(--border-light)] hover:bg-[var(--bg-sidebar)] rounded transition-colors group cursor-pointer" onClick={() => setActiveChannelId(ch.id)}>
                                        <div className="flex items-center gap-3">
                                            <div className="relative shrink-0 w-10 h-10">
                                               <img src={ch.targetUser.avatar || 'pfp.png'} className={"w-10 h-10 rounded-full object-cover bg-[var(--bg-input)] " + (ch.targetUser.isDeleted ? 'opacity-50 grayscale' : '')} style={getAvatarStyle(ch.targetUser.avatar, ch.targetUser.username)} />
                                               {!ch.targetUser.isDeleted && <div className={"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 border-[3px] border-[var(--bg-panel)] group-hover:border-[var(--bg-sidebar)] rounded-full transition-colors " + (isOnline(ch.targetUser.lastActive) ? 'bg-[#3ba55c]' : 'bg-[#747f8d]')} />}
                                            </div>
                                            <div className="flex flex-col">
                                                <span className="font-bold text-[var(--text-main)]">{ch.targetUser.nickname || ch.targetUser.username}</span>
                                                <span className="text-xs text-[var(--text-faded)]">{ch.targetUser.isDeleted ? 'Deleted User' : isOnline(ch.targetUser.lastActive) ? 'Online' : 'Offline'}</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button type="button" className="p-2 bg-[var(--bg-input)] hover:bg-black/50 text-[var(--text-muted)] hover:text-[var(--text-main)] rounded-full transition-colors" title="Message"><MessageSquare size={18} /></button>
                                            <button type="button" className="p-2 bg-[var(--bg-input)] hover:bg-black/50 text-[var(--text-muted)] hover:text-[var(--text-main)] rounded-full transition-colors" title="More" onClick={(e) => { e.stopPropagation(); setModals(m => ({ ...m, profile: ch.targetUser })); }}><span className="font-bold tracking-widest leading-none block transform -translate-y-1">...</span></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
              </div>
            ) : (
              <React.Fragment>
                {/* Header Top Bar */}
                <div className="h-12 px-4 flex items-center justify-between shadow-sm border-b border-[var(--border-dark)] shrink-0 z-10 bg-[var(--bg-panel)]">
                  <div className="flex items-center gap-2 min-w-0">
                    <button type="button" className="md:hidden p-1 mr-1 text-[var(--text-muted)] hover:text-[var(--text-main)] shrink-0" onClick={() => setLeftMenuOpen(true)}><Menu size={20} /></button>
                    {activeChannelInfo.isDM ? (
                       <div className="w-6 h-6 rounded-full shrink-0 overflow-hidden bg-[var(--bg-input)]"><img src={activeChannelInfo.avatar || 'pfp.png'} className={"w-full h-full object-cover " + (activeChannelInfo.targetUser?.isDeleted ? 'opacity-50 grayscale' : '')} style={getAvatarStyle(activeChannelInfo.avatar, activeChannelInfo.name)} /></div>
                    ) : ( <Hash className="text-[var(--text-faded)] shrink-0" size={24} /> )}
                    <span className="font-bold text-[var(--text-main)] truncate">{activeChannelInfo.name}</span>
                  </div>
                  <div className="flex items-center gap-3 md:gap-4 text-[var(--text-muted)] shrink-0 relative">
                    <button type="button" onClick={() => setModals(m => ({ ...m, search: true }))} className="hover:text-[var(--text-main)] p-1 rounded hover:bg-[var(--border-light)] transition-colors"><Search size={20} /></button>
                    <button type="button" onClick={() => setModals(m => ({ ...m, notifications: true }))} className="hover:text-[var(--text-main)] p-1 rounded hover:bg-[var(--border-light)] transition-colors relative"><Bell size={20} />{myNotifications.length > 0 && <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-[#ed4245] rounded-full border-2 border-[var(--bg-panel)]"></span>}</button>
                    {context === 'server' && ( <button type="button" className={membersSidebarOpen ? 'text-[var(--text-main)] p-1 bg-[var(--border-light)] rounded' : 'hover:text-[var(--text-main)] p-1 rounded hover:bg-[var(--border-light)] transition-colors'} onClick={() => setMembersSidebarOpen(!membersSidebarOpen)}><Users size={20} /></button> )}
                    {context === 'home' && activeChannelId && ( <button type="button" onClick={() => setDmProfileSidebarOpen(!dmProfileSidebarOpen)} className={dmProfileSidebarOpen ? 'text-[var(--text-main)] p-1 bg-[var(--border-light)] rounded' : 'hover:text-[var(--text-main)] p-1 rounded hover:bg-[var(--border-light)] transition-colors'}><User size={20} /></button> )}
                  </div>
                </div>

                {/* Messages Container */}
                <div className="flex-1 overflow-y-auto p-4 flex flex-col gap-1 hide-scrollbar">
                  {!activeChannelId && <div className="m-auto text-center text-[var(--text-faded)] px-4"><Hash size={48} className="mx-auto mb-4 opacity-50 shrink-0"/><p>Select a channel from the sidebar to start chatting</p></div>}
                  {activeChannelId && channelMessages.map((msg, idx) => {
                    const prevMsg = channelMessages[idx - 1];
                    const isGrouped = prevMsg && prevMsg.senderId === msg.senderId && (msg.timestamp - prevMsg.timestamp < 300000); 
                    const sender = data.users.find(u => u.uid === msg.senderId) || getDeletedUser(msg.senderId);
                    const date = new Date(msg.timestamp);
                    const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    return (
                      <div key={msg.id} className={"group flex gap-3 md:gap-4 px-2 md:px-4 py-1 hover:bg-black/5 rounded " + (isGrouped ? 'mt-0' : 'mt-4')}>
                        {isGrouped ? (
                          <div className="w-10 flex-shrink-0 text-right opacity-0 group-hover:opacity-100 text-[10px] text-[var(--text-faded)] pt-1 select-none hidden md:block">{timeStr}</div>
                        ) : (
                          <img src={sender.avatar || 'pfp.png'} alt="Avatar" className={"w-10 h-10 shrink-0 rounded-full bg-[var(--bg-input)] object-cover " + (sender.isDeleted ? 'opacity-50 grayscale' : 'cursor-pointer hover:shadow-lg transition-transform hover:scale-105')} style={getAvatarStyle(sender.avatar, sender.username)} onClick={() => !sender.isDeleted && setModals(m => ({ ...m, profile: sender }))} />
                        )}
                        
                        <div className="flex-1 min-w-0">
                          {!isGrouped || window.innerWidth < 768 ? (
                            <div className="flex items-baseline gap-2 mb-1">
                              <span className={"font-medium flex items-center gap-1 truncate " + (sender.isDeleted ? 'text-[var(--text-faded)] line-through' : 'text-[var(--text-main)] hover:underline cursor-pointer')} onClick={() => !sender.isDeleted && setModals(m => ({ ...m, profile: sender }))}>
                                {sender.nickname || sender.username}
                                {sender.isAdmin && <span className="bg-amber-400 text-black text-[9px] px-1 rounded-sm tracking-wider font-bold h-3 flex items-center">ADMIN</span>}
                              </span>
                              <span className="text-xs text-[var(--text-faded)] shrink-0">{date.toLocaleDateString()} at {timeStr}</span>
                            </div>
                          ) : null}
                          
                          {msg.text && <div className="text-[var(--text-main)] break-words leading-relaxed text-sm md:text-base" dangerouslySetInnerHTML={parseMarkdown(msg.text)} />}
                          {msg.imageUrl && <img src={msg.imageUrl} alt="attachment" className="max-w-xs md:max-w-sm max-h-60 md:max-h-80 rounded-lg mt-2 cursor-pointer border border-[var(--border-light)] object-contain" onClick={() => setImageView(msg.imageUrl)} />}

                          {msg.reactions && Object.keys(msg.reactions).length > 0 && (
                            <div className="flex flex-wrap gap-1 mt-1">
                              {Object.keys(msg.reactions).map(emoji => {
                                const uids = msg.reactions[emoji];
                                return (
                                  <button key={emoji} type="button" onClick={() => toggleReaction(msg.id, emoji, msg.reactions)} className={"flex items-center gap-1 px-1.5 py-0.5 rounded border " + (uids.includes(profile.uid) ? 'bg-[#5865F2]/20 border-[#5865F2] text-[#5865F2]' : 'bg-[var(--bg-sidebar)] border-transparent text-[var(--text-muted)] hover:border-[var(--border-dark)]') + " text-xs font-bold transition-colors"}>
                                    <span>{emoji}</span><span>{uids.length}</span>
                                  </button>
                                );
                              })}
                            </div>
                          )}
                        </div>

                        {/* Quick Reactions Hover Bar */}
                        <div className="absolute right-4 -mt-3 hidden group-hover:flex items-center bg-[var(--bg-panel)] border border-[var(--border-dark)] rounded shadow-sm px-1 py-0.5 z-10">
                          {['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®'].map(emoji => (
                            <button type="button" key={emoji} onClick={() => toggleReaction(msg.id, emoji, msg.reactions || {})} className="p-1 hover:bg-[var(--border-light)] rounded text-lg grayscale hover:grayscale-0 transition-all hover:scale-110">{emoji}</button>
                          ))}
                          {(profile.uid === msg.senderId || profile.isAdmin) && (
                            <button type="button" onClick={() => handleDeleteMessage(msg.id)} className="p-1.5 ml-1 text-[var(--text-faded)] hover:text-white hover:bg-[#ed4245] rounded transition-colors" title="Delete Message">
                              <Trash2 size={16} />
                            </button>
                          )}
                        </div>
                      </div>
                    );
                  })}
                  <div ref={messagesEndRef} className="h-4" />
                </div>

                {/* Input Area */}
                {activeChannelId && (
                  <div className="px-2 md:px-4 pb-4 md:pb-6 pt-2 shrink-0">
                    <div className="bg-[var(--bg-input)] rounded-lg flex items-center p-2 gap-2 shadow-sm focus-within:ring-1 focus-within:ring-[#5865F2]">
                      <label className="p-2 hover:bg-[var(--border-dark)] rounded-full cursor-pointer text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors shrink-0">
                        <Paperclip size={20} />
                        <input type="file" hidden accept="image/*" onChange={handleImageUpload} disabled={profile.isBanned} />
                      </label>
                      <form onSubmit={sendMessage} className="flex-1 flex min-w-0">
                        <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} disabled={profile.isBanned || activeChannelInfo.targetUser?.isDeleted} placeholder={profile.isBanned ? "You are banned from sending messages." : activeChannelInfo.targetUser?.isDeleted ? "You cannot message a deleted user." : ("Message " + (activeChannelInfo.isDM ? "@" : "#") + activeChannelInfo.name)} className="flex-1 bg-transparent text-[var(--text-main)] placeholder-[var(--text-faded)] focus:outline-none px-2 py-1 min-w-0 disabled:opacity-50" autoComplete="off" />
                        <button type="submit" disabled={!inputText.trim() || profile.isBanned || activeChannelInfo.targetUser?.isDeleted} className={"p-2 rounded-full transition-colors shrink-0 " + (inputText.trim() && !profile.isBanned && !activeChannelInfo.targetUser?.isDeleted ? 'bg-[#5865F2] text-white hover:bg-[#4752c4]' : 'text-[var(--text-faded)] bg-transparent')}><Send size={18} className={inputText.trim() ? 'translate-x-0.5' : ''}/></button>
                      </form>
                    </div>
                    <div className="text-xs text-[var(--text-faded)] mt-1 px-2 font-mono">Markdown supported: **bold**, *italic*, __underline__, <code>code</code></div>
                  </div>
                )}
              </React.Fragment>
            )}
          </div>

          {/* 4. Members Sidebar (Right) OR DM Profile Sidebar */}
          {context === 'server' && membersSidebarOpen ? (
            <div className={`fixed inset-y-0 right-0 z-40 md:relative md:z-auto h-full w-60 bg-[var(--bg-sidebar)] flex flex-col shrink-0 overflow-y-auto border-l border-[var(--border-dark)] hide-scrollbar transform transition-transform duration-300 ${membersSidebarOpen ? 'translate-x-0' : 'translate-x-full hidden md:flex md:translate-x-0'}`}>
              <div className="text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider px-4 pt-6 pb-2 border-b border-[var(--border-light)] mb-2">Global Users â€” {data.users.length}</div>
              {data.users.map(u => (
                <div key={u.uid} onClick={() => { setModals(m => ({ ...m, profile: u })); setMembersSidebarOpen(false); }} className="flex items-center gap-3 px-4 py-2 mx-2 rounded hover:bg-[var(--border-light)] cursor-pointer group">
                  <div className="relative shrink-0 w-8 h-8">
                    <img src={u.avatar || 'pfp.png'} className="w-8 h-8 shrink-0 rounded-full bg-[var(--bg-input)] object-cover" alt="" style={getAvatarStyle(u.avatar, u.username)} />
                    <div className={"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 border-[3px] border-[var(--bg-sidebar)] group-hover:border-[var(--bg-panel)] rounded-full transition-colors " + (isOnline(u.lastActive) ? 'bg-[#3ba55c]' : 'bg-[#747f8d]')} />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className={"font-medium truncate flex items-center gap-1 " + (isOnline(u.lastActive) ? 'text-[var(--text-main)]' : 'text-[var(--text-faded)] group-hover:text-[var(--text-muted)]')}>
                      {u.nickname || u.username}
                      {u.isAdmin && <span className="bg-amber-400 text-black text-[8px] px-1 rounded-sm tracking-wider font-bold">ADMIN</span>}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : context === 'home' && activeChannelId && dmProfileSidebarOpen ? (
            <div className={`fixed inset-y-0 right-0 z-40 md:relative md:z-auto h-full w-60 md:w-72 bg-[var(--bg-sidebar)] flex flex-col shrink-0 overflow-y-auto border-l border-[var(--border-dark)] hide-scrollbar transform transition-transform duration-300 ${dmProfileSidebarOpen ? 'translate-x-0' : 'translate-x-full hidden md:flex md:translate-x-0'}`}>
               <div className="h-28 relative shrink-0 bg-[#5865F2]" style={{ backgroundColor: activeChannelInfo.targetUser?.color || '#5865F2', backgroundImage: activeChannelInfo.targetUser?.banner ? `url(${activeChannelInfo.targetUser.banner})` : 'none', backgroundSize: 'cover', backgroundPosition: 'center' }} />
               <div className="px-4 pb-4 relative pt-14">
                  <div className="absolute -top-12 left-4 rounded-full border-[6px] border-[var(--bg-sidebar)] bg-[var(--bg-sidebar)] w-[92px] h-[92px] shrink-0">
                     <img src={activeChannelInfo.avatar || 'pfp.png'} className={"w-full h-full rounded-full object-cover bg-[var(--bg-input)] " + (activeChannelInfo.targetUser?.isDeleted ? 'opacity-50 grayscale' : '')} style={getAvatarStyle(activeChannelInfo.avatar, activeChannelInfo.name)} />
                     {!activeChannelInfo.targetUser?.isDeleted && <div className={"absolute bottom-1 right-1 w-5 h-5 border-[3px] border-[var(--bg-sidebar)] rounded-full " + (isOnline(activeChannelInfo.targetUser?.lastActive) ? 'bg-[#3ba55c]' : 'bg-[#747f8d]')} />}
                  </div>
                  <div className="mt-2">
                      <div className="text-xl font-bold text-[var(--text-main)] flex items-center gap-2 flex-wrap">
                          {activeChannelInfo.name}
                          {activeChannelInfo.targetUser?.isAdmin && <span className="bg-amber-400 text-black text-[10px] px-1.5 py-0.5 rounded-sm tracking-wider h-fit">ADMIN</span>}
                      </div>
                      <div className="text-sm text-[var(--text-muted)]">{activeChannelInfo.targetUser?.nickname ? `${activeChannelInfo.targetUser.username} ` : ''}#{activeChannelInfo.targetUser?.uid.substring(0,6)}</div>
                  </div>
                  <div className="bg-[var(--bg-rail)] rounded-lg p-3 border border-[var(--border-light)] mt-4">
                      <div className="text-xs font-bold text-[var(--text-faded)] uppercase mb-1">About Me</div>
                      <div className="text-sm text-[var(--text-main)] break-words whitespace-pre-wrap">{activeChannelInfo.targetUser?.bio || "This user hasn't set a bio yet."}</div>
                      <div className="text-xs font-bold text-[var(--text-faded)] uppercase mb-1 mt-4">NeoChat Member Since</div>
                      <div className="text-sm text-[var(--text-main)]">{activeChannelInfo.targetUser?.isDeleted ? 'Account Deleted' : new Date(activeChannelInfo.targetUser?.lastActive || Date.now()).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                  </div>
               </div>
            </div>
          ) : null}

          {/* --- Modals --- */}
          {modals.search && (
             <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={() => setModals(m => ({ ...m, search: false }))}>
               <div className="bg-[var(--bg-panel)] w-full max-w-2xl h-[80vh] rounded-lg shadow-2xl flex flex-col border border-[var(--border-light)]" onClick={e => e.stopPropagation()}>
                 <div className="p-4 border-b border-[var(--border-dark)] flex items-center gap-3 shrink-0">
                    <Search className="text-[var(--text-faded)] shrink-0" />
                    <input autoFocus type="text" placeholder="Search all messages globally..." className="bg-transparent text-[var(--text-main)] w-full outline-none text-lg" onChange={(e) => setSearchQuery(e.target.value)} />
                    <button type="button" className="shrink-0 p-1 bg-[var(--border-light)] hover:bg-[var(--border-dark)] rounded" onClick={() => setModals(m => ({ ...m, search: false }))}><X className="text-[var(--text-main)]" size={20} /></button>
                 </div>
                 <div className="flex-1 overflow-y-auto p-4 hide-scrollbar">
                    {searchQuery.trim() === '' ? <div className="text-center text-[var(--text-faded)] mt-10">Type something to search through all loaded messages.</div>
                    : searchResults.length === 0 ? <div className="text-center text-[var(--text-faded)] mt-10">No messages matched your search.</div>
                    : searchResults.map(msg => {
                           const sender = data.users.find(u => u.uid === msg.senderId) || getDeletedUser(msg.senderId);
                           return (
                               <div key={msg.id} className="mb-4 bg-[var(--bg-sidebar)] p-3 rounded border border-[var(--border-light)] cursor-pointer hover:border-[#5865F2] transition-colors" onClick={() => { setActiveChannelId(msg.channelId); setModals(m => ({...m, search: false})); }}>
                                  <div className="flex items-center gap-2 mb-1">
                                      <img src={sender.avatar} style={getAvatarStyle(sender.avatar, sender.username)} className={"w-5 h-5 rounded-full object-cover shrink-0 " + (sender.isDeleted ? 'opacity-50 grayscale' : '')} />
                                      <span className={"font-bold text-sm " + (sender.isDeleted ? 'text-[var(--text-faded)] line-through' : 'text-[var(--text-main)]')}>{sender.nickname || sender.username}</span>
                                      <span className="text-xs text-[var(--text-faded)] ml-auto">{new Date(msg.timestamp).toLocaleDateString()}</span>
                                  </div>
                                  <div className="text-[var(--text-main)] text-sm line-clamp-2">{msg.text || '[Image Attachment]'}</div>
                               </div>
                           )
                       })
                    }
                 </div>
               </div>
             </div>
          )}

          {modals.notifications && (
             <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={() => setModals(m => ({ ...m, notifications: false }))}>
               <div className="bg-[var(--bg-panel)] w-full max-w-sm max-h-[80vh] rounded-lg shadow-2xl flex flex-col border border-[var(--border-light)]" onClick={e => e.stopPropagation()}>
                 <div className="p-4 border-b border-[var(--border-dark)] flex items-center justify-between shrink-0">
                    <h2 className="font-bold text-[var(--text-main)] flex items-center gap-2"><Bell size={20} className="text-[#5865F2]" /> Notifications</h2>
                    <button type="button" className="shrink-0 p-1 hover:bg-[var(--border-light)] rounded" onClick={() => setModals(m => ({ ...m, notifications: false }))}><X className="text-[var(--text-faded)]" size={20} /></button>
                 </div>
                 <div className="flex-1 overflow-y-auto p-4 hide-scrollbar">
                    {myNotifications.length === 0 ? <div className="text-center text-[var(--text-faded)] my-10">You have no new notifications.</div>
                    : myNotifications.map(msg => {
                           const sender = data.users.find(u => u.uid === msg.senderId) || getDeletedUser(msg.senderId);
                           return (
                               <div key={msg.id} className="mb-3 bg-[var(--bg-sidebar)] p-3 rounded border-l-4 border-l-[#5865F2] cursor-pointer hover:bg-[var(--bg-input)] transition-colors" onClick={() => { switchContext('home'); setActiveChannelId(msg.channelId); setModals(m => ({...m, notifications: false})); }}>
                                  <div className="text-xs text-[var(--text-muted)] mb-1">New Message from <strong>{sender.nickname || sender.username}</strong></div>
                                  <div className="text-[var(--text-main)] text-sm truncate">{msg.text || '[Image Attachment]'}</div>
                                  <div className="text-[10px] text-[var(--text-faded)] mt-1">{new Date(msg.timestamp).toLocaleString()}</div>
                               </div>
                           )
                       })
                    }
                 </div>
               </div>
             </div>
          )}

          {modals.serverSettings && activeServer && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={() => setModals(m => ({ ...m, serverSettings: false }))}>
              <div className="bg-[var(--bg-panel)] w-full max-w-md rounded-lg p-6 shadow-2xl border border-[var(--border-light)]" onClick={e => e.stopPropagation()}>
                <h2 className="text-xl md:text-2xl font-bold text-[var(--text-main)] mb-6 text-center">Server Settings</h2>
                <div className="mb-6">
                  <label className="block text-xs font-bold text-[var(--text-faded)] uppercase mb-2">Server Name</label>
                  <input type="text" id="edit-server-name" defaultValue={activeServer.name} className="w-full bg-[var(--bg-input)] text-[var(--text-main)] p-2.5 rounded border border-[var(--border-dark)] focus:border-[#5865F2] outline-none" />
                </div>
                <div className="flex justify-between items-center mt-8 border-t border-[var(--border-light)] pt-6">
                  <button type="button" onClick={async () => {
                      const val = document.getElementById('edit-server-name').value.trim();
                      if (val && val !== activeServer.name) { await supabase.from('servers').update({ name: val }).eq('id', activeServer.id); showToast('Server name updated', 'success'); }
                      setModals(m => ({ ...m, serverSettings: false }));
                  }} className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-6 py-2 rounded font-medium transition-colors">Save Changes</button>
                  <button type="button" onClick={async () => {
                      if (confirm('Are you sure you want to delete this server?')) { await supabase.from('servers').delete().eq('id', activeServer.id); setModals(m => ({ ...m, serverSettings: false })); switchContext('home'); showToast('Server deleted', 'success'); }
                  }} className="text-[#ed4245] hover:underline text-sm font-medium">Delete Server</button>
                </div>
              </div>
            </div>
          )}

          {modals.createServer && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={() => setModals(m => ({ ...m, createServer: false }))}>
              <div className="bg-[var(--bg-panel)] w-full max-w-md rounded-lg p-6 shadow-2xl border border-[var(--border-light)]" onClick={e => e.stopPropagation()}>
                <h2 className="text-xl md:text-2xl font-bold text-[var(--text-main)] mb-2 text-center">Customize your server</h2>
                <p className="text-center text-[var(--text-muted)] mb-6 text-sm">Give your new server a personality with a name.</p>
                <form onSubmit={handleCreateServer}>
                  <div className="mb-6">
                    <label className="block text-xs font-bold text-[var(--text-faded)] uppercase mb-2">Server Name</label>
                    <input name="name" autoFocus placeholder={(profile?.username || '') + "'s server"} className="w-full bg-[var(--bg-input)] text-[var(--text-main)] p-2.5 rounded border border-[var(--border-dark)] focus:border-[#5865F2] outline-none" required />
                  </div>
                  <div className="flex justify-between items-center bg-[var(--bg-sidebar)] -m-6 p-4 mt-2 rounded-b-lg">
                    <button type="button" onClick={() => setModals(m => ({ ...m, createServer: false }))} className="text-[var(--text-main)] hover:underline px-4 py-2 text-sm">Back</button>
                    <button type="submit" className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-6 py-2 rounded font-medium transition-colors">Create</button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {modals.createChannel && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4" onClick={() => setModals(m => ({ ...m, createChannel: false }))}>
              <div className="bg-[var(--bg-panel)] w-full max-w-md rounded-lg p-6 shadow-2xl border border-[var(--border-light)]" onClick={e => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-xl font-bold text-[var(--text-main)]">Create Text Channel</h2>
                  <button type="button" onClick={() => setModals(m => ({ ...m, createChannel: false }))} className="text-[var(--text-faded)] hover:text-[var(--text-main)]"><X size={20}/></button>
                </div>
                <form onSubmit={handleCreateChannel}>
                  <div className="mb-6">
                    <label className="block text-xs font-bold text-[var(--text-faded)] uppercase mb-2">Channel Name</label>
                    <div className="relative flex items-center bg-[var(--bg-input)] rounded border border-[var(--border-dark)] focus-within:border-[#5865F2]">
                      <Hash className="absolute left-2 text-[var(--text-faded)] shrink-0" size={18} />
                      <input name="name" autoFocus placeholder="new-channel" className="w-full bg-transparent text-[var(--text-main)] p-2.5 pl-8 outline-none" required />
                    </div>
                  </div>
                  <div className="flex justify-end gap-3 bg-[var(--bg-sidebar)] -m-6 p-4 mt-2 rounded-b-lg">
                    <button type="button" onClick={() => setModals(m => ({ ...m, createChannel: false }))} className="text-[var(--text-main)] hover:underline px-4 py-2 text-sm">Cancel</button>
                    <button type="submit" className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-6 py-2 rounded font-medium transition-colors">Create Channel</button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* User Profile Modal */}
          {modals.profile && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4" onClick={() => { setModals(m => ({ ...m, profile: null })); setProfileMenuOpen(false); }}>
              <div className="w-full max-w-[340px] bg-[var(--bg-userpanel)] rounded-lg shadow-2xl overflow-visible border border-[var(--border-dark)] animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                <div className="h-24 relative shrink-0 rounded-t-lg bg-[#5865F2]" style={{ backgroundColor: modals.profile.color || '#5865F2', backgroundImage: modals.profile.banner ? `url(${modals.profile.banner})` : 'none', backgroundSize: 'cover', backgroundPosition: 'center' }} />
                <div className="px-4 pb-4 relative pt-14">
                  <div className="absolute -top-[42px] left-4 rounded-full border-[6px] border-[var(--bg-userpanel)] bg-[var(--bg-userpanel)] w-[84px] h-[84px] shrink-0 z-10">
                    <img src={modals.profile.avatar || 'pfp.png'} className={"w-full h-full rounded-full object-cover bg-[var(--bg-input)] " + (modals.profile.isDeleted ? 'opacity-50 grayscale' : '')} alt="User Avatar" style={getAvatarStyle(modals.profile.avatar, modals.profile.username)} />
                    {!modals.profile.isDeleted && <div className={"absolute bottom-0.5 right-0.5 w-4 h-4 border-[3px] border-[var(--bg-userpanel)] rounded-full " + (isOnline(modals.profile.lastActive) ? 'bg-[#3ba55c]' : 'bg-[#747f8d]')} />}
                  </div>
                  
                  <div className="mt-2">
                    <div className="text-xl font-bold text-[var(--text-main)] flex items-center gap-2 flex-wrap">
                      {modals.profile.nickname || modals.profile.username}
                      {modals.profile.isAdmin && <span className="bg-amber-400 text-black text-[10px] px-1.5 py-0.5 rounded-sm tracking-wider h-fit">ADMIN</span>}
                    </div>
                    <div className="text-sm text-[var(--text-muted)]">{modals.profile.nickname ? `${modals.profile.username} ` : ''}#{modals.profile.uid.substring(0,6)}</div>
                  </div>

                  <div className="bg-[var(--bg-rail)] rounded-lg p-3 border border-[var(--border-light)] mt-4">
                    <div className="text-xs font-bold text-[var(--text-faded)] uppercase mb-1">About Me</div>
                    <div className="text-sm text-[var(--text-main)] break-words whitespace-pre-wrap max-h-24 overflow-y-auto hide-scrollbar">{modals.profile.bio || "This user hasn't set a bio yet."}</div>
                    <div className="text-xs font-bold text-[var(--text-faded)] uppercase mb-1 mt-4">NeoChat Member Since</div>
                    <div className="text-sm text-[var(--text-main)]">{modals.profile.isDeleted ? 'Account Deleted' : new Date(modals.profile.lastActive || Date.now()).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                  </div>

                  {(() => {
                      // Profile Actions Logic
                      const isSelf = modals.profile.uid === profile.uid;
                      const sortedUids = [profile.uid, modals.profile.uid].sort().join('_');
                      const isFriend = data.channels.find(c => c.serverId === 'dm' && c.name === sortedUids);
                      const pendingReq = data.channels.find(c => c.serverId === 'request' && (c.name === `${profile.uid}_${modals.profile.uid}` || c.name === `${modals.profile.uid}_${profile.uid}`));
                      const isOutgoingReq = pendingReq && pendingReq.name.startsWith(profile.uid);

                      if (isSelf) {
                          return <button type="button" onClick={() => setModals(m => ({ ...m, profile: null, settings: true }))} className="mt-4 w-full bg-[var(--bg-sidebar)] hover:bg-[var(--border-light)] text-[var(--text-main)] py-2 rounded text-sm font-medium transition-colors border border-[var(--border-dark)]">Edit User Profile</button>;
                      } else if (modals.profile.isDeleted) {
                          return null; // No actions for deleted user
                      } else if (isFriend) {
                          return (
                              <div className="flex gap-2 relative mt-4">
                                <button type="button" onClick={() => handleStartDM(modals.profile)} className="flex-1 bg-[#5865F2] hover:bg-[#4752c4] text-white py-2 rounded text-sm font-medium transition-colors">Send Message</button>
                                <button type="button" onClick={() => setProfileMenuOpen(!profileMenuOpen)} className="bg-[var(--bg-sidebar)] hover:bg-[var(--border-light)] border border-[var(--border-dark)] px-3 rounded transition-colors text-[var(--text-main)] flex items-center justify-center shrink-0"><span className="font-bold tracking-widest leading-none block transform -translate-y-1">...</span></button>
                                {profileMenuOpen && (
                                   <div className="absolute bottom-full right-0 mb-2 w-48 bg-[#18191c] rounded shadow-xl border border-[var(--border-light)] py-1 z-[110]">
                                      <button type="button" className="w-full text-left px-3 py-2 text-sm text-[var(--text-main)] hover:bg-[#ed4245] hover:text-white transition-colors flex items-center gap-2" onClick={() => { handleRemoveFriendOrRequest(isFriend.id); setProfileMenuOpen(false); setModals(m=>({...m, profile: null})); }}><UserMinus size={14} /> Remove Friend</button>
                                      <button type="button" className="w-full text-left px-3 py-2 text-sm text-[#ed4245] hover:bg-[#ed4245] hover:text-white transition-colors flex items-center gap-2" onClick={() => { showToast(`You blocked ${modals.profile.username}.`, "error"); setProfileMenuOpen(false); }}><ShieldBan size={14} /> Block User</button>
                                   </div>
                                )}
                              </div>
                          );
                      } else if (pendingReq) {
                          if (isOutgoingReq) {
                              return <button type="button" onClick={() => handleRemoveFriendOrRequest(pendingReq.id)} className="mt-4 w-full bg-[var(--bg-sidebar)] hover:bg-[var(--border-light)] text-[var(--text-main)] py-2 rounded text-sm font-medium transition-colors border border-[var(--border-dark)] flex justify-center items-center gap-2"><UserX size={16}/> Cancel Request</button>;
                          } else {
                              return (
                                  <div className="flex gap-2 mt-4">
                                      <button type="button" onClick={() => handleAcceptRequest(pendingReq.id, modals.profile)} className="flex-1 bg-[#3ba55c] hover:bg-[#2d8046] text-white py-2 rounded text-sm font-medium transition-colors flex justify-center items-center gap-2"><UserCheck size={16}/> Accept</button>
                                      <button type="button" onClick={() => handleRemoveFriendOrRequest(pendingReq.id)} className="flex-1 bg-[var(--bg-sidebar)] hover:bg-[#ed4245] text-[var(--text-main)] hover:text-white py-2 rounded text-sm font-medium transition-colors border border-[var(--border-dark)] hover:border-[#ed4245]">Decline</button>
                                  </div>
                              );
                          }
                      } else {
                          return <button type="button" onClick={() => handleSendRequest(modals.profile)} className="mt-4 w-full bg-[#5865F2] hover:bg-[#4752c4] text-white py-2 rounded text-sm font-medium transition-colors flex justify-center items-center gap-2"><UserPlus size={16}/> Send Friend Request</button>;
                      }
                  })()}

                  {/* ADMIN TOOLS */}
                  {profile.isAdmin && !modals.profile.isDeleted && modals.profile.uid !== profile.uid && (
                     <div className="mt-4 border-t border-[var(--border-light)] pt-4">
                        <div className="text-xs font-bold text-[#ed4245] uppercase mb-2 flex items-center gap-1"><AlertCircle size={14}/> Admin Tools</div>
                        <div className="flex gap-2">
                           <button type="button" onClick={() => adminBanUser(modals.profile.uid)} className="flex-1 bg-[#ed4245]/20 hover:bg-[#ed4245] text-[#ed4245] hover:text-white py-1.5 rounded text-xs font-bold transition-colors">Ban User</button>
                           <button type="button" onClick={() => adminClearMessages(modals.profile.uid)} className="flex-1 bg-[#ed4245]/20 hover:bg-[#ed4245] text-[#ed4245] hover:text-white py-1.5 rounded text-xs font-bold transition-colors">Purge Chat</button>
                        </div>
                        <button type="button" onClick={() => adminDeleteUser(modals.profile.uid)} className="w-full mt-2 bg-transparent border border-[#ed4245] hover:bg-[#ed4245] text-[#ed4245] hover:text-white py-1.5 rounded text-xs font-bold transition-colors flex items-center justify-center gap-2"><Trash2 size={14}/> Delete Account</button>
                     </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Personal Settings */}
          {modals.settings && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-0 md:p-4" onClick={() => setModals(m => ({ ...m, settings: false }))}>
              <div className="bg-[var(--bg-panel)] w-full h-full md:max-w-4xl md:h-auto md:max-h-[85vh] md:rounded-lg shadow-2xl flex flex-col md:flex-row overflow-hidden border border-[var(--border-light)]" onClick={e => e.stopPropagation()}>
                
                {/* Settings Left Menu */}
                <div className="w-full md:w-1/3 bg-[var(--bg-sidebar)] p-4 md:p-6 flex flex-row md:flex-col overflow-x-auto hide-scrollbar shrink-0 border-b md:border-b-0 md:border-r border-[var(--border-dark)]">
                  <div className="hidden md:block text-xs font-bold text-[var(--text-faded)] uppercase mb-2 px-2">User Settings</div>
                  <div onClick={() => setSettingsTab('account')} className={`text-[var(--text-main)] px-3 py-1.5 rounded mr-2 md:mr-0 md:mb-1 cursor-pointer font-medium whitespace-nowrap shrink-0 transition-colors ${settingsTab === 'account' ? 'bg-[var(--border-dark)]' : 'hover:bg-[var(--border-light)]'}`}>My Account</div>
                  <div onClick={() => setSettingsTab('profiles')} className={`text-[var(--text-main)] px-3 py-1.5 rounded mr-2 md:mr-0 md:mb-4 cursor-pointer font-medium whitespace-nowrap shrink-0 transition-colors ${settingsTab === 'profiles' ? 'bg-[var(--border-dark)]' : 'hover:bg-[var(--border-light)]'}`}>Profiles</div>
                  <div className="hidden md:block text-xs font-bold text-[var(--text-faded)] uppercase mb-2 px-2 md:mt-4">App Settings</div>
                  <div onClick={() => setSettingsTab('appearance')} className={`text-[var(--text-main)] px-3 py-1.5 rounded mr-2 md:mr-0 md:mb-1 cursor-pointer font-medium whitespace-nowrap shrink-0 transition-colors ${settingsTab === 'appearance' ? 'bg-[var(--border-dark)]' : 'hover:bg-[var(--border-light)]'}`}>Appearance</div>
                  <div onClick={() => setSettingsTab('notifications')} className={`text-[var(--text-main)] px-3 py-1.5 rounded md:mb-1 cursor-pointer font-medium whitespace-nowrap shrink-0 transition-colors ${settingsTab === 'notifications' ? 'bg-[var(--border-dark)]' : 'hover:bg-[var(--border-light)]'}`}>Notifications</div>
                  
                  <div className="hidden md:block mt-auto border-t border-[var(--border-light)] pt-4">
                     <button type="button" onClick={handleLogout} className="flex items-center justify-center gap-2 bg-transparent hover:bg-[#ed4245]/10 text-[#ed4245] px-3 py-2 rounded w-full transition-colors font-bold"><LogOut size={16}/> Log Out</button>
                  </div>
                </div>

                {/* Settings Content Area */}
                <div className="w-full md:w-2/3 p-6 md:p-10 overflow-y-auto relative hide-scrollbar flex-1 bg-[var(--bg-panel)]">
                  <div className="absolute top-4 right-4 md:top-6 md:right-6 p-1 text-[var(--text-faded)] hover:text-[var(--text-main)] cursor-pointer hover:bg-[var(--border-light)] rounded-full transition-all border-2 border-transparent hover:border-[var(--border-dark)]" onClick={() => setModals(m => ({ ...m, settings: false }))}><X size={20} /></div>
                  
                  {settingsTab === 'account' && (
                      <div>
                          <h2 className="text-xl font-bold text-[var(--text-main)] mb-6">My Account</h2>
                          <div className="bg-[var(--bg-sidebar)] rounded-xl mb-6 border border-[var(--border-light)] overflow-hidden">
                            <div className="h-24 relative" style={{ backgroundColor: profile.color || '#5865F2', backgroundImage: profile.banner ? `url(${profile.banner})` : 'none', backgroundSize: 'cover', backgroundPosition: 'center' }} />
                            <div className="px-4 md:px-6 pb-6 relative pt-14">
                              <div className="absolute -top-[42px] left-4 md:left-6 w-[84px] h-[84px] rounded-full border-[6px] border-[var(--bg-sidebar)] bg-[var(--bg-input)] z-10 flex items-center justify-center overflow-hidden">
                                 <img src={profile.avatar || 'pfp.png'} className="w-full h-full object-cover" alt="Avatar" style={getAvatarStyle(profile.avatar, profile.username)} />
                              </div>
                              <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4 mt-2">
                                <div className="flex-1">
                                   <h3 className="text-xl font-bold text-[var(--text-main)] leading-none mb-1">{profile.nickname || profile.username}</h3>
                                   <span className="text-sm text-[var(--text-muted)]">{profile.nickname ? `${profile.username} ` : ''}#{profile.uid.substring(0,4)}</span>
                                </div>
                                <button type="button" onClick={() => setSettingsTab('profiles')} className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-5 py-2 rounded text-sm font-medium transition-colors">Edit Profile</button>
                              </div>
                            </div>
                          </div>
                      </div>
                  )}

                  {settingsTab === 'profiles' && (
                      <div>
                          <h2 className="text-xl font-bold text-[var(--text-main)] mb-6">Profiles</h2>
                          <div className="space-y-6">
                              <div className="pb-6 border-b border-[var(--border-light)]">
                                  <label className="block text-xs font-bold text-[var(--text-faded)] uppercase mb-2">Display Name (Nickname)</label>
                                  <input type="text" defaultValue={profile.nickname || profile.username} onBlur={e => updateProfile({ nickname: e.target.value.trim() })} className="w-full bg-[var(--bg-input)] text-[var(--text-main)] p-3 rounded border border-[var(--border-dark)] focus:border-[#5865F2] outline-none transition-colors" />
                              </div>
                              <div className="flex flex-col md:flex-row gap-6 pb-6 border-b border-[var(--border-light)]">
                                  <div className="flex-1">
                                      <label className="block text-xs font-bold text-[var(--text-faded)] uppercase mb-2">Avatar</label>
                                      <div className="flex items-center gap-4">
                                          <img src={profile.avatar || 'pfp.png'} className="w-16 h-16 rounded-full object-cover bg-[var(--bg-input)]" style={getAvatarStyle(profile.avatar, profile.username)}/>
                                          <label className="bg-[var(--bg-sidebar)] border border-[var(--border-dark)] hover:bg-[var(--border-light)] text-[var(--text-main)] px-4 py-2 rounded text-sm font-medium cursor-pointer transition-colors">
                                            Change Avatar
                                            <input type="file" hidden accept="image/*" onChange={async (e) => {
                                               if(e.target.files[0]) {
                                                 showToast("Uploading avatar...", "info");
                                                 updateProfile({ avatar: await compressImage(e.target.files[0], 400, 400, 0.8) });
                                                 showToast("Avatar updated!", "success");
                                               }
                                            }}/>
                                          </label>
                                      </div>
                                  </div>
                                  <div className="flex-1">
                                      <label className="block text-xs font-bold text-[var(--text-faded)] uppercase mb-2">Profile Color</label>
                                      <div className="flex items-center gap-3">
                                          <input type="color" defaultValue={profile.color || getPalette(profile.username)} onBlur={e => updateProfile({ color: e.target.value })} className="w-10 h-10 rounded cursor-pointer bg-transparent border-none p-0" />
                                          <span className="text-sm text-[var(--text-muted)]">Choose a fallback banner color.</span>
                                      </div>
                                  </div>
                              </div>
                              <div className="pb-6 border-b border-[var(--border-light)]">
                                  <label className="block text-xs font-bold text-[var(--text-faded)] uppercase mb-2">Profile Banner</label>
                                  <div className="w-full h-32 rounded-lg bg-[var(--bg-input)] border-2 border-dashed border-[var(--border-dark)] flex items-center justify-center relative overflow-hidden group">
                                      {profile.banner && <img src={profile.banner} className="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-20 transition-opacity" />}
                                      <label className="relative z-10 bg-[var(--bg-panel)] border border-[var(--border-dark)] text-[var(--text-main)] px-4 py-2 rounded shadow-lg cursor-pointer hover:bg-[var(--border-light)] transition-colors flex items-center gap-2 text-sm font-medium">
                                          <ImageIcon size={16}/> Upload Banner
                                          <input type="file" hidden accept="image/*" onChange={async (e) => {
                                               if(e.target.files[0]) {
                                                 showToast("Uploading banner...", "info");
                                                 updateProfile({ banner: await compressImage(e.target.files[0], 1200, 600, 0.8) });
                                                 showToast("Banner updated!", "success");
                                               }
                                            }}/>
                                      </label>
                                  </div>
                              </div>
                              <div>
                                 <label className="block text-xs font-bold text-[var(--text-faded)] uppercase mb-2">About Me</label>
                                 <textarea className="w-full bg-[var(--bg-input)] text-[var(--text-main)] p-3 rounded border border-[var(--border-dark)] focus:border-[#5865F2] outline-none text-sm resize-none transition-colors" rows="3" defaultValue={profile.bio} onBlur={(e) => updateProfile({ bio: e.target.value })} placeholder="Tell everyone a little about yourself..." />
                              </div>
                          </div>
                      </div>
                  )}

                  {settingsTab === 'appearance' && (
                      <div>
                          <h2 className="text-xl font-bold text-[var(--text-main)] mb-6">Appearance</h2>
                          <label className="block text-xs font-bold text-[var(--text-faded)] uppercase mb-4">Theme</label>
                          <div className="space-y-3">
                              {['dark', 'light', 'oled'].map(t => (
                                  <label key={t} className="flex items-center gap-3 p-3 rounded bg-[var(--bg-sidebar)] border border-[var(--border-light)] cursor-pointer hover:border-[var(--text-muted)] transition-colors">
                                      <input type="radio" name="theme" value={t} defaultChecked={(localStorage.getItem('neochat_theme') || 'dark') === t} className="w-5 h-5 accent-[#5865F2]" onChange={(e) => {
                                          localStorage.setItem('neochat_theme', e.target.value);
                                          document.body.className = `overflow-hidden theme-${e.target.value}`;
                                      }}/>
                                      <span className="text-[var(--text-main)] capitalize font-medium">{t === 'oled' ? 'Midnight (OLED)' : t}</span>
                                  </label>
                              ))}
                          </div>
                      </div>
                  )}

                  {settingsTab === 'notifications' && (
                      <div>
                          <h2 className="text-xl font-bold text-[var(--text-main)] mb-6">Notifications</h2>
                          <div className="bg-[var(--bg-sidebar)] border border-[var(--border-light)] p-5 rounded-lg">
                              <h3 className="text-[var(--text-main)] font-bold mb-2 flex items-center gap-2"><Monitor size={18}/> Desktop Notifications</h3>
                              <p className="text-[var(--text-muted)] text-sm mb-4">Turn on browser notifications to see when your friends message you while NeoChat is in the background.</p>
                              <button type="button" onClick={() => {
                                  if (!("Notification" in window)) return showToast("Browser does not support notifications.", "error");
                                  Notification.requestPermission().then(p => {
                                      if (p === "granted") showToast("Notifications enabled!", "success");
                                      else showToast("Notification permission denied.", "error");
                                  });
                              }} className="bg-[#5865F2] hover:bg-[#4752c4] text-white px-5 py-2 rounded text-sm font-medium transition-colors">Enable Notifications</button>
                          </div>
                      </div>
                  )}

                  <div className="md:hidden mt-10 pt-6 border-t border-[var(--border-light)]">
                     <button type="button" onClick={handleLogout} className="flex items-center justify-center gap-2 bg-[#ed4245] hover:bg-[#c9383b] text-white px-3 py-3 rounded w-full transition-colors font-bold shadow-sm"><LogOut size={18}/> Log Out</button>
                  </div>
                </div>
              </div>
            </div>
          )}

        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
