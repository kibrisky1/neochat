<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NeoChat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.39.3"
      }
    }
  </script>
  <style>
    /* â”€â”€ THEME TOKENS â”€â”€ */
    :root {
      --bg-base:      #1a1b1e;
      --bg-panel:     #25262b;
      --bg-sidebar:   #1e1f23;
      --bg-rail:      #141517;
      --bg-input:     #2c2e33;
      --bg-hover:     rgba(255,255,255,0.05);
      --bg-userpanel: #1a1b1e;
      --text-main:    #e8eaed;
      --text-muted:   #9ca3af;
      --text-faded:   #6b7280;
      --accent:       #5865F2;
      --accent-hover: #4752c4;
      --green:        #3ba55c;
      --red:          #ed4245;
      --border:       rgba(255,255,255,0.07);
      --shadow:       0 4px 24px rgba(0,0,0,0.4);
      --radius:       8px;
      --rail-pill:    #ffffff;
    }
    body.theme-light {
      --bg-base:      #f0f2f5;
      --bg-panel:     #ffffff;
      --bg-sidebar:   #f2f3f5;
      --bg-rail:      #e3e5e8;
      --bg-input:     #e9eaec;
      --bg-hover:     rgba(0,0,0,0.04);
      --bg-userpanel: #ebedef;
      --text-main:    #1a1b1e;
      --text-muted:   #4e5058;
      --text-faded:   #72767d;
      --accent:       #5865F2;
      --border:       rgba(0,0,0,0.09);
      --shadow:       0 4px 24px rgba(0,0,0,0.12);
      --rail-pill:    #5865F2;
    }
    body.theme-oled {
      --bg-base:      #000000;
      --bg-panel:     #060607;
      --bg-sidebar:   #030304;
      --bg-rail:      #000000;
      --bg-input:     #0f0f10;
      --bg-hover:     rgba(255,255,255,0.04);
      --bg-userpanel: #050506;
      --text-main:    #f3f4f6;
      --text-muted:   #9ca3af;
      --text-faded:   #6b7280;
      --border:       rgba(255,255,255,0.08);
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--bg-base);
      color: var(--text-main);
      overscroll-behavior: none;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€ SCROLLBAR â”€â”€ */
    .scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
    .scrollbar::-webkit-scrollbar-track { background: transparent; }
    .scrollbar::-webkit-scrollbar-thumb { background: var(--bg-input); border-radius: 99px; }
    .scrollbar:hover::-webkit-scrollbar-thumb { background: var(--text-faded); }

    /* â”€â”€ MESSAGE INPUT â”€â”€ */
    .msg-input { font-family: 'DM Sans', sans-serif; }
    code, .mono { font-family: 'JetBrains Mono', monospace; }

    /* â”€â”€ ANIMATIONS â”€â”€ */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-12px); }
      to   { opacity: 1; transform: translateX(0); }
    }
    @keyframes popIn {
      from { opacity: 0; transform: scale(0.92); }
      to   { opacity: 1; transform: scale(1); }
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translateX(40px); }
      to   { opacity: 1; transform: translateX(0); }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.4; }
    }
    @keyframes typingDot {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30%            { transform: translateY(-4px); opacity: 1; }
    }

    .anim-fade-up  { animation: fadeUp 0.2s ease both; }
    .anim-slide-in { animation: slideIn 0.2s ease both; }
    .anim-pop-in   { animation: popIn 0.18s cubic-bezier(0.34,1.56,0.64,1) both; }
    .anim-toast    { animation: toastIn 0.28s cubic-bezier(0.34,1.2,0.64,1) both; }
    .anim-spin     { animation: spin 0.8s linear infinite; }
    .anim-pulse    { animation: pulse 1.5s ease infinite; }

    /* â”€â”€ MESSAGE HOVER BAR â”€â”€ */
    .msg-row { position: relative; }
    .msg-actions { display: none; position: absolute; right: 12px; top: -18px; z-index: 10; }
    .msg-row:hover .msg-actions { display: flex; }

    /* â”€â”€ RAIL PILL â”€â”€ */
    .rail-pill {
      position: absolute;
      left: -14px;
      width: 4px;
      background: var(--rail-pill);
      border-radius: 0 4px 4px 0;
      transition: height 0.2s ease, opacity 0.2s ease;
    }

    /* â”€â”€ UNREAD BADGE â”€â”€ */
    .unread-dot {
      position: absolute;
      bottom: -2px; right: -2px;
      width: 14px; height: 14px;
      background: var(--red);
      border-radius: 50%;
      border: 3px solid var(--bg-rail);
      font-size: 8px;
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: 800;
    }

    /* â”€â”€ TYPING INDICATOR â”€â”€ */
    .typing-dot {
      width: 6px; height: 6px;
      background: var(--text-muted);
      border-radius: 50%;
      display: inline-block;
      animation: typingDot 1.4s ease infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    /* â”€â”€ SERVER ICON â”€â”€ */
    .srv-icon {
      width: 48px; height: 48px; border-radius: 24px;
      display: flex; align-items: center; justify-content: center;
      transition: border-radius 0.18s ease, background 0.18s ease, transform 0.1s ease;
      cursor: pointer; position: relative; overflow: hidden; flex-shrink: 0;
    }
    .srv-icon:hover, .srv-icon.active { border-radius: 16px; }
    .srv-icon:active { transform: scale(0.93); }

    /* â”€â”€ CODE BLOCKS â”€â”€ */
    code.inline { 
      background: var(--bg-input); 
      padding: 2px 6px; border-radius: 4px; 
      color: #eb459e; font-size: 0.88em;
      font-family: 'JetBrains Mono', monospace;
    }
    pre.code-block { 
      background: var(--bg-rail); 
      border: 1px solid var(--border);
      border-radius: 6px; padding: 12px 16px; 
      overflow-x: auto; margin: 6px 0;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85em; line-height: 1.6;
    }

    /* â”€â”€ SELECTION â”€â”€ */
    ::selection { background: rgba(88, 101, 242, 0.4); }

    /* â”€â”€ BUTTON RESET â”€â”€ */
    button { cursor: pointer; border: none; background: none; color: inherit; font-family: inherit; }

    /* â”€â”€ INPUT RESET â”€â”€ */
    input, textarea { font-family: inherit; }

    /* â”€â”€ STATUS INDICATOR â”€â”€ */
    .status-online  { background: #3ba55c; }
    .status-idle    { background: #faa61a; }
    .status-offline { background: #747f8d; }

    /* â”€â”€ MODAL BACKDROP â”€â”€ */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(6px);
      display: flex; align-items: center; justify-content: center;
      z-index: 100; padding: 16px;
    }

    /* â”€â”€ CONNECTION BANNER â”€â”€ */
    .conn-banner {
      position: fixed; top: 0; left: 0; right: 0;
      height: 36px;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 600;
      z-index: 200;
      transition: transform 0.3s ease;
    }
    .conn-banner.hidden { transform: translateY(-100%); }

    /* â”€â”€ MENTION HIGHLIGHT â”€â”€ */
    .mention { color: #7289da; background: rgba(114,137,218,0.15); border-radius: 3px; padding: 0 2px; cursor: pointer; }
    .mention:hover { background: rgba(114,137,218,0.35); }

    /* â”€â”€ CHANNEL ROW â”€â”€ */
    .ch-row {
      display: flex; align-items: center; gap: 8px;
      padding: 5px 8px; border-radius: 6px;
      cursor: pointer; transition: background 0.12s ease;
      color: var(--text-faded);
    }
    .ch-row:hover { background: var(--bg-hover); color: var(--text-muted); }
    .ch-row.active { background: rgba(88,101,242,0.15); color: var(--text-main); font-weight: 500; }

    /* â”€â”€ DM ROW â”€â”€ */
    .dm-row {
      display: flex; align-items: center; gap: 10px;
      padding: 6px 8px; border-radius: 6px;
      cursor: pointer; transition: background 0.12s ease;
      color: var(--text-faded); position: relative;
    }
    .dm-row:hover { background: var(--bg-hover); color: var(--text-muted); }
    .dm-row.active { background: rgba(88,101,242,0.15); color: var(--text-main); }

    /* â”€â”€ JUMP TO BOTTOM â”€â”€ */
    .jump-btn {
      position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
      background: var(--accent); color: white;
      padding: 6px 16px; border-radius: 99px;
      font-size: 13px; font-weight: 600;
      box-shadow: var(--shadow); cursor: pointer;
      transition: transform 0.15s ease, opacity 0.2s ease;
      display: flex; align-items: center; gap: 6px;
      z-index: 5;
    }
    .jump-btn:hover { transform: translateX(-50%) scale(1.04); }
    .jump-btn.hidden { opacity: 0; pointer-events: none; }

    /* â”€â”€ EMOJI PICKER â”€â”€ */
    .emoji-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; }

    /* â”€â”€ FOCUS STYLES â”€â”€ */
    .focus-ring:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
  </style>
</head>
<body class="overflow-hidden theme-dark">
<div id="root"></div>
<script type="text/babel" data-type="module">
import React, {
  useState, useEffect, useRef, useMemo, useCallback,
  createContext, useContext, memo, Fragment
} from 'react';
import { createRoot } from 'react-dom/client';
import { createClient } from '@supabase/supabase-js';
import {
  Hash, Search, Bell, Users, Plus, Compass, Settings,
  Mic, MicOff, Headphones, Send, Paperclip, X, Check,
  LogOut, User, Mail, Lock, Menu, AlertCircle, ShieldBan,
  MessageSquare, Image as ImageIcon, Trash2, UserPlus,
  UserMinus, UserCheck, UserX, Pencil, ChevronDown,
  Wifi, WifiOff, RefreshCw, Smile, Copy, MoreHorizontal,
  MessageCircle, Home, ArrowDown
} from 'lucide-react';

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL = 'https://cwsslsvuslimptikvrds.supabase.co';
const SUPABASE_KEY = 'sb_publishable_OETJRLtsxWNsEMTi61PpsA_QXfQqu41';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const PRESENCE_INTERVAL   = 45_000;   // ms
const ONLINE_THRESHOLD    = 120_000;  // ms
const MSG_GROUP_THRESHOLD = 300_000;  // 5 min
const SEND_RATE_LIMIT     = 500;      // ms between sends
const MAX_MSG_LENGTH      = 2000;
const MAX_FILE_SIZE       = 8 * 1024 * 1024; // 8MB
const EMOJI_QUICK         = ['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ”¥','âœ…','ðŸŽ‰'];
const EMOJI_PICKER        = ['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ”¥','âœ…','ðŸŽ‰','ðŸ¤”','ðŸ˜Ž','ðŸ¥³','ðŸ‘€','ðŸ’¯','ðŸ™Œ','â­','ðŸš€','ðŸ’€','ðŸ¤','ðŸ«¡','ðŸ’¬','ðŸ¤£','ðŸ˜','ðŸ¥°','ðŸ˜­','ðŸ¤¯','ðŸ’ª','ðŸ§ ','ðŸ«¶','ðŸ™','ðŸ¤Œ','âœ¨','ðŸ’¥'];

// â”€â”€ AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let msgSound = null;
try {
  msgSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqOkZSWl5iZmZmYl5aUkY6KhYGAfXl1cW5ramhlYmBdW1lXVlVUU1NTVFVWV1ldYGJlaGpucXV5fYCBhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en6BhYqOkZSWl5iZmZmYl5aUkY6KhYF+enZyb2xpZmNgXVtZV1ZVVFNTU1RVVldZXWBjZmlsb3J2en4=');
} catch (e) {}

function playNotifSound() {
  try { if (msgSound) { msgSound.currentTime = 0; msgSound.volume = 0.3; msgSound.play().catch(() => {}); } } catch (e) {}
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const uid36 = (len = 8) => Math.random().toString(36).slice(2, 2 + len);
const genId  = (pfx) => `${pfx}_${Date.now().toString(36)}${uid36(5)}`;

const PALETTES = ['#ef4444','#f97316','#f59e0b','#10b981','#22c55e',
                  '#8b5cf6','#d946ef','#f43f5e','#a855f7','#0ea5e9'];
function getPalette(seed = '') {
  let h = 0;
  for (let i = 0; i < seed.length; i++) h = seed.charCodeAt(i) + ((h << 5) - h);
  return PALETTES[Math.abs(h) % PALETTES.length];
}

function getAvatarStyle(avatar, username) {
  if (!avatar || avatar === 'pfp.png') return { backgroundColor: getPalette(username) };
  return {};
}

function getDeletedUser(uid = 'unknown') {
  let h = 0;
  for (let i = 0; i < uid.length; i++) h = uid.charCodeAt(i) + ((h << 5) - h);
  const n = Math.abs(h) % 10000;
  const name = `deleted_user${n.toString().padStart(4,'0')}`;
  return { uid, username: name, nickname: name, avatar: 'pfp.png', color: '#747f8d', bio: '', isDeleted: true };
}

function isOnline(lastActive) { return (Date.now() - (lastActive || 0)) < ONLINE_THRESHOLD; }

function formatTime(ts) {
  return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
function formatTimestamp(ts) {
  const d = new Date(ts);
  const now = new Date();
  const diff = now - d;
  if (diff < 86_400_000) {
    const isToday = d.toDateString() === now.toDateString();
    const yest = new Date(Date.now() - 86_400_000);
    const isYest = d.toDateString() === yest.toDateString();
    if (isToday) return `Today at ${formatTime(ts)}`;
    if (isYest) return `Yesterday at ${formatTime(ts)}`;
  }
  return `${d.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' })} ${formatTime(ts)}`;
}

// Enhanced markdown parser: supports **bold**, *italic*, __underline__, `code`, ```blocks```, > quotes, ~~strikethrough~~, @mentions
function parseMarkdown(text, users = []) {
  if (!text) return { __html: '' };
  
  // Escape HTML
  let html = String(text)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
  
  // Code blocks (multiline) - must be done FIRST
  html = html.replace(/```([\s\S]*?)```/g, (_, code) =>
    `<pre class="code-block">${code.trim()}</pre>`);
  
  // Inline code
  html = html.replace(/`([^`]+)`/g,
    '<code class="inline">$1</code>');
  
  // Bold + italic
  html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
  html = html.replace(/\*\*(.*?)\*\*/g,     '<strong>$1</strong>');
  html = html.replace(/\*(.*?)\*/g,         '<em>$1</em>');
  html = html.replace(/~~(.*?)~~/g,         '<del>$1</del>');
  html = html.replace(/__(.*?)__/g,         '<u>$1</u>');
  
  // Block quotes
  html = html.replace(/^&gt; (.*)$/gm,
    '<div style="border-left:3px solid var(--text-faded);padding-left:8px;color:var(--text-muted);margin:2px 0">$1</div>');

  // @mentions  
  users.forEach(u => {
    const safe = (u.nickname || u.username).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const re = new RegExp(`@${safe}`, 'gi');
    html = html.replace(re, `<span class="mention">@${u.nickname || u.username}</span>`);
  });
  
  // URLs
  html = html.replace(/(https?:\/\/[^\s<>"]+)/g,
    '<a href="$1" target="_blank" rel="noopener noreferrer" style="color:#00aff4;text-decoration:underline;text-underline-offset:2px">$1</a>');
  
  // Newlines (skip inside pre)
  html = html.replace(/\n/g, '<br>');
  
  return { __html: html };
}

async function compressImage(file, maxW = 1200, maxH = 1200, quality = 0.82) {
  return new Promise((resolve, reject) => {
    if (file.size > MAX_FILE_SIZE) {
      return reject(new Error(`File too large (max ${MAX_FILE_SIZE / 1024 / 1024}MB)`));
    }
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = ({ target: { result } }) => {
      const img = new Image();
      img.src = result;
      img.onload = () => {
        let { width: w, height: h } = img;
        const ratio = Math.min(1, maxW / w, maxH / h);
        w = Math.round(w * ratio);
        h = Math.round(h * ratio);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.onerror = () => reject(new Error('Failed to load image'));
    };
    reader.onerror = () => reject(new Error('Failed to read file'));
  });
}

function copyToClipboard(text) {
  if (navigator.clipboard) navigator.clipboard.writeText(text).catch(() => {});
  else {
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  }
}

// â”€â”€ CONTEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AppCtx = createContext(null);
function useApp() { return useContext(AppCtx); }

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Toast({ toast }) {
  if (!toast) return null;
  const colors = {
    success: 'bg-[#3ba55c]',
    error:   'bg-[#ed4245]',
    info:    'bg-[#5865F2]',
    warn:    'bg-[#faa61a]',
  };
  return (
    <div className={`fixed top-5 right-5 z-[300] flex items-center gap-3 px-5 py-3.5 rounded-xl shadow-2xl text-white font-semibold text-sm anim-toast ${colors[toast.type] || colors.info}`}>
      {toast.type === 'success' && <Check size={16} />}
      {toast.type === 'error'   && <X size={16} />}
      {toast.type === 'warn'    && <AlertCircle size={16} />}
      {toast.message}
    </div>
  );
}

// â”€â”€ CONNECTION BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ConnBanner({ status }) {
  const show = status !== 'connected';
  return (
    <div className={`conn-banner ${show ? '' : 'hidden'} ${status === 'connecting' ? 'bg-[#faa61a]' : 'bg-[#ed4245]'}`}>
      {status === 'connecting'
        ? <><span className="anim-spin inline-block mr-2"><RefreshCw size={14} /></span> Connecting to NeoChat...</>
        : <><WifiOff size={14} className="mr-2" /> Disconnected â€” trying to reconnect...</>}
    </div>
  );
}

// â”€â”€ AVATAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Avatar = memo(({ user, size = 32, showStatus = false, className = '' }) => {
  const sz = { width: size, height: size };
  const online = showStatus && isOnline(user?.lastActive);
  const dotSize = Math.max(10, Math.round(size * 0.3));
  
  return (
    <div className={`relative shrink-0 rounded-full overflow-visible ${className}`} style={{ width: size, height: size }}>
      <img
        src={user?.avatar || 'pfp.png'}
        alt={user?.username || 'User'}
        style={{ ...sz, ...getAvatarStyle(user?.avatar, user?.username) }}
        className={`rounded-full object-cover bg-[var(--bg-input)] ${user?.isDeleted ? 'opacity-50 grayscale' : ''}`}
        onError={e => { e.target.onerror = null; e.target.src = ''; e.target.style.backgroundColor = getPalette(user?.username); }}
      />
      {showStatus && (
        <div
          className={`absolute rounded-full border-2 border-[var(--bg-sidebar)] ${online ? 'status-online' : 'status-offline'}`}
          style={{ width: dotSize, height: dotSize, bottom: -1, right: -1, borderColor: 'var(--bg-sidebar)' }}
        />
      )}
    </div>
  );
});

// â”€â”€ MODAL WRAPPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Modal({ open, onClose, children, maxWidth = 480 }) {
  useEffect(() => {
    if (!open) return;
    const handler = (e) => { if (e.key === 'Escape') onClose(); };
    window.addEventListener('keydown', handler);
    return () => window.removeEventListener('keydown', handler);
  }, [open, onClose]);
  
  if (!open) return null;
  return (
    <div className="modal-backdrop" onClick={onClose}>
      <div
        className="anim-pop-in w-full bg-[var(--bg-panel)] rounded-xl shadow-2xl border border-[var(--border)] overflow-hidden"
        style={{ maxWidth }}
        onClick={e => e.stopPropagation()}
      >
        {children}
      </div>
    </div>
  );
}

// â”€â”€ TYPING INDICATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TypingIndicator({ typers }) {
  if (!typers.length) return null;
  const names = typers.slice(0, 3).map(u => u.nickname || u.username).join(', ');
  const extra = typers.length > 3 ? ` and ${typers.length - 3} more` : '';
  return (
    <div className="flex items-center gap-2 px-4 py-1 text-xs text-[var(--text-muted)]">
      <span className="flex gap-1 items-end">
        <span className="typing-dot" />
        <span className="typing-dot" />
        <span className="typing-dot" />
      </span>
      <span><strong>{names}{extra}</strong> {typers.length === 1 ? 'is' : 'are'} typing...</span>
    </div>
  );
}

// â”€â”€ MESSAGE COMPONENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Message = memo(({ msg, prev, users, profile, onReact, onDelete, onEdit, onImageClick }) => {
  const sender = users.find(u => u.uid === msg.senderId) || getDeletedUser(msg.senderId);
  const isOwn = msg.senderId === profile.uid;
  const isAdmin = profile.isAdmin;
  const grouped = prev && prev.senderId === msg.senderId && (msg.timestamp - prev.timestamp < MSG_GROUP_THRESHOLD);
  const [showEmojiPicker, setShowEmojiPicker] = useState(false);
  const [contextMenu, setContextMenu] = useState(null);
  
  // Mentions this user?
  const mentionsMe = msg.text?.includes(`@${profile.nickname || profile.username}`) ||
                     msg.text?.includes(`@${profile.username}`);

  const handleContextMenu = useCallback((e) => {
    e.preventDefault();
    setContextMenu({ x: e.clientX, y: e.clientY });
  }, []);

  useEffect(() => {
    if (!contextMenu) return;
    const close = () => setContextMenu(null);
    window.addEventListener('click', close);
    return () => window.removeEventListener('click', close);
  }, [contextMenu]);

  return (
    <div
      className={`msg-row flex gap-3 px-4 py-1 rounded-lg transition-colors duration-100
        ${grouped ? '' : 'mt-3'}
        ${mentionsMe ? 'bg-[rgba(250,166,26,0.05)] border-l-2 border-[#faa61a] pl-[14px]' : 'hover:bg-[var(--bg-hover)]'}
      `}
      onContextMenu={handleContextMenu}
    >
      {/* Avatar or time spacer */}
      {grouped ? (
        <div className="w-10 shrink-0 flex items-start justify-end pt-0.5 select-none">
          <span className="text-[10px] text-[var(--text-faded)] opacity-0 hover-show leading-none mt-1">
            {formatTime(msg.timestamp)}
          </span>
        </div>
      ) : (
        <Avatar
          user={sender}
          size={40}
          className={`mt-0.5 ${!sender.isDeleted ? 'cursor-pointer hover:opacity-90 transition-opacity' : ''}`}
          onClick={() => !sender.isDeleted && window.__openProfile?.(sender)}
        />
      )}

      {/* Content */}
      <div className="flex-1 min-w-0">
        {!grouped && (
          <div className="flex items-baseline gap-2 mb-0.5 flex-wrap">
            <span
              className={`font-semibold text-sm flex items-center gap-1.5 ${sender.isDeleted ? 'text-[var(--text-faded)] line-through' : 'text-[var(--text-main)] cursor-pointer hover:underline'}`}
              onClick={() => !sender.isDeleted && window.__openProfile?.(sender)}
            >
              {sender.nickname || sender.username}
              {sender.isAdmin && <span className="bg-amber-400 text-black text-[9px] px-1.5 py-0.5 rounded font-bold tracking-wider">ADMIN</span>}
              {sender.isBanned && <span className="bg-red-900 text-red-300 text-[9px] px-1.5 py-0.5 rounded font-bold">BANNED</span>}
            </span>
            <span className="text-[11px] text-[var(--text-faded)]">{formatTimestamp(msg.timestamp)}</span>
          </div>
        )}

        {/* Text */}
        {msg.text && (
          <div
            className="text-[var(--text-main)] text-sm leading-relaxed break-words"
            dangerouslySetInnerHTML={parseMarkdown(msg.text, users)}
          />
        )}
        {msg.isEdited && <span className="text-[10px] text-[var(--text-faded)] ml-1">(edited)</span>}

        {/* Image */}
        {msg.imageUrl && (
          <img
            src={msg.imageUrl}
            alt="attachment"
            className="mt-2 max-w-sm max-h-72 rounded-lg object-contain cursor-zoom-in border border-[var(--border)] hover:border-[var(--accent)] transition-colors"
            onClick={() => onImageClick(msg.imageUrl)}
            loading="lazy"
          />
        )}

        {/* Reactions */}
        {msg.reactions && Object.keys(msg.reactions).length > 0 && (
          <div className="flex flex-wrap gap-1 mt-1.5">
            {Object.entries(msg.reactions).map(([emoji, uids]) => (
              uids.length > 0 && (
                <button
                  key={emoji}
                  onClick={() => onReact(msg.id, emoji, msg.reactions)}
                  title={uids.map(id => users.find(u=>u.uid===id)?.username || 'User').join(', ')}
                  className={`flex items-center gap-1 px-2 py-0.5 rounded-full border text-xs font-semibold transition-colors ${
                    uids.includes(profile.uid)
                      ? 'bg-[rgba(88,101,242,0.2)] border-[var(--accent)] text-[var(--accent)]'
                      : 'bg-[var(--bg-input)] border-[var(--border)] text-[var(--text-muted)] hover:border-[var(--text-faded)]'
                  }`}
                >
                  <span>{emoji}</span><span>{uids.length}</span>
                </button>
              )
            ))}
          </div>
        )}
      </div>

      {/* Hover Action Bar */}
      <div className="msg-actions items-center bg-[var(--bg-panel)] border border-[var(--border)] rounded-lg shadow-lg px-1 py-0.5 gap-0.5">
        {EMOJI_QUICK.slice(0,4).map(e => (
          <button key={e} onClick={() => onReact(msg.id, e, msg.reactions || {})}
            className="p-1 hover:bg-[var(--bg-hover)] rounded text-base transition-all hover:scale-125 leading-none" title={e}
          >{e}</button>
        ))}
        <button onClick={() => setShowEmojiPicker(!showEmojiPicker)}
          className="p-1 hover:bg-[var(--bg-hover)] rounded text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors" title="More reactions"
        ><Smile size={15} /></button>
        {!msg.imageUrl && isOwn && (
          <button onClick={() => onEdit(msg)}
            className="p-1 hover:bg-[var(--bg-hover)] rounded text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors" title="Edit"
          ><Pencil size={15} /></button>
        )}
        <button onClick={() => { copyToClipboard(msg.text || ''); }}
          className="p-1 hover:bg-[var(--bg-hover)] rounded text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors" title="Copy text"
        ><Copy size={15} /></button>
        {(isOwn || isAdmin) && (
          <button onClick={() => onDelete(msg.id)}
            className="p-1 hover:bg-[var(--bg-hover)] rounded text-[var(--text-muted)] hover:text-[#ed4245] transition-colors" title="Delete"
          ><Trash2 size={15} /></button>
        )}
      </div>

      {/* Emoji Picker Popup */}
      {showEmojiPicker && (
        <div className="absolute right-4 z-20 anim-pop-in" style={{ top: grouped ? -8 : 40 }}>
          <div className="bg-[var(--bg-panel)] border border-[var(--border)] rounded-xl shadow-xl p-2">
            <div className="emoji-grid">
              {EMOJI_PICKER.map(e => (
                <button key={e} onClick={() => { onReact(msg.id, e, msg.reactions || {}); setShowEmojiPicker(false); }}
                  className="p-1 text-xl hover:bg-[var(--bg-hover)] rounded transition-all hover:scale-125"
                >{e}</button>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Context Menu */}
      {contextMenu && (
        <div
          className="fixed z-50 bg-[var(--bg-panel)] border border-[var(--border)] rounded-lg shadow-2xl py-1 min-w-[180px] anim-fade-up"
          style={{ top: contextMenu.y, left: Math.min(contextMenu.x, window.innerWidth - 200) }}
          onClick={e => e.stopPropagation()}
        >
          {msg.text && (
            <button onClick={() => { copyToClipboard(msg.text); setContextMenu(null); }}
              className="w-full text-left px-3 py-2 text-sm hover:bg-[var(--accent)] hover:text-white transition-colors flex items-center gap-2">
              <Copy size={14} /> Copy Message
            </button>
          )}
          {isOwn && !msg.imageUrl && (
            <button onClick={() => { onEdit(msg); setContextMenu(null); }}
              className="w-full text-left px-3 py-2 text-sm hover:bg-[var(--accent)] hover:text-white transition-colors flex items-center gap-2">
              <Pencil size={14} /> Edit Message
            </button>
          )}
          {(isOwn || isAdmin) && (
            <button onClick={() => { onDelete(msg.id); setContextMenu(null); }}
              className="w-full text-left px-3 py-2 text-sm text-[var(--red)] hover:bg-[var(--red)] hover:text-white transition-colors flex items-center gap-2">
              <Trash2 size={14} /> Delete Message
            </button>
          )}
        </div>
      )}
    </div>
  );
});

// â”€â”€ INPUT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function InputBar({ channelInfo, profile, editingMsg, onSend, onCancelEdit, onImageUpload, onTyping }) {
  const [text, setText] = useState('');
  const [charCount, setCharCount] = useState(0);
  const inputRef = useRef(null);
  const lastSendTime = useRef(0);

  useEffect(() => {
    if (editingMsg) {
      setText(editingMsg.text || '');
      inputRef.current?.focus();
    }
  }, [editingMsg]);

  const handleChange = (e) => {
    const val = e.target.value;
    if (val.length > MAX_MSG_LENGTH) return;
    setText(val);
    setCharCount(val.length);
    onTyping?.();
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
    if (e.key === 'Escape' && editingMsg) {
      cancelEdit();
    }
  };

  const cancelEdit = () => {
    setText('');
    setCharCount(0);
    onCancelEdit();
  };

  const handleSend = () => {
    const trimmed = text.trim();
    if (!trimmed) return;
    // Rate limiting
    const now = Date.now();
    if (now - lastSendTime.current < SEND_RATE_LIMIT) return;
    lastSendTime.current = now;
    onSend(trimmed, editingMsg);
    setText('');
    setCharCount(0);
  };

  const disabled = profile?.isBanned || channelInfo?.targetUser?.isDeleted;
  const placeholder = profile?.isBanned
    ? 'You are banned from sending messages.'
    : channelInfo?.targetUser?.isDeleted
    ? 'You cannot message a deleted user.'
    : `Message ${channelInfo?.isDM ? '@' : '#'}${channelInfo?.name}`;

  const nearLimit = charCount > MAX_MSG_LENGTH * 0.9;

  return (
    <div className="px-4 pb-6 pt-2 shrink-0">
      {editingMsg && (
        <div className="flex items-center gap-2 text-xs text-[var(--text-muted)] mb-1.5 px-1">
          <Pencil size={12} className="text-[var(--accent)]" />
          Editing message
          <button onClick={cancelEdit} className="text-[var(--accent)] hover:underline ml-1">Cancel</button>
        </div>
      )}
      <div className={`flex items-end gap-2 bg-[var(--bg-input)] rounded-xl px-3 py-2.5 border transition-colors ${editingMsg ? 'border-[var(--accent)]' : 'border-[var(--border)] focus-within:border-[var(--accent)]'}`}>
        {/* Image upload */}
        {!editingMsg && (
          <label className={`shrink-0 p-1.5 rounded-lg text-[var(--text-muted)] transition-colors cursor-pointer ${disabled ? 'opacity-40 pointer-events-none' : 'hover:bg-[var(--bg-hover)] hover:text-[var(--text-main)]'}`}>
            <Paperclip size={18} />
            <input type="file" hidden accept="image/*" onChange={onImageUpload} disabled={disabled} />
          </label>
        )}

        {/* Text input */}
        <textarea
          ref={inputRef}
          rows={1}
          value={text}
          onChange={handleChange}
          onKeyDown={handleKeyDown}
          disabled={disabled}
          placeholder={placeholder}
          className="flex-1 bg-transparent text-[var(--text-main)] placeholder-[var(--text-faded)] resize-none outline-none text-sm leading-relaxed disabled:opacity-50 msg-input"
          style={{ maxHeight: 160, overflowY: 'auto' }}
          onInput={e => {
            e.target.style.height = ''; 
            e.target.style.height = Math.min(e.target.scrollHeight, 160) + 'px';
          }}
        />

        {/* Char counter + send */}
        <div className="flex items-center gap-2 shrink-0 pb-0.5">
          {nearLimit && (
            <span className={`text-[11px] font-medium ${charCount >= MAX_MSG_LENGTH ? 'text-[var(--red)]' : 'text-[var(--text-faded)]'}`}>
              {MAX_MSG_LENGTH - charCount}
            </span>
          )}
          <button
            onClick={handleSend}
            disabled={!text.trim() || disabled || charCount >= MAX_MSG_LENGTH}
            className={`p-2 rounded-lg transition-all ${text.trim() && !disabled && charCount < MAX_MSG_LENGTH ? 'bg-[var(--accent)] text-white hover:bg-[var(--accent-hover)] active:scale-95' : 'text-[var(--text-faded)] opacity-40 cursor-not-allowed'}`}
          >
            {editingMsg ? <Check size={16} /> : <Send size={16} />}
          </button>
        </div>
      </div>
      {charCount > 0 && (
        <div className="text-[10px] text-[var(--text-faded)] mt-1 px-1">
          Shift+Enter for new line Â· Markdown: **bold** *italic* `code`
        </div>
      )}
    </div>
  );
}

// â”€â”€ DATE DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DateDivider({ date }) {
  return (
    <div className="flex items-center gap-3 px-4 my-4">
      <div className="flex-1 h-px bg-[var(--border)]" />
      <span className="text-xs text-[var(--text-faded)] font-medium whitespace-nowrap">{date}</span>
      <div className="flex-1 h-px bg-[var(--border)]" />
    </div>
  );
}

// â”€â”€ Friendly error messages for Supabase auth codes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function friendlyAuthError(err) {
  if (!err) return 'An unknown error occurred.';
  const msg = (err.message || '').toLowerCase();
  const code = err.code || err.error_code || '';

  // 422 â€” email already registered (Supabase returns this when email confirm is ON and email exists)
  if (err.status === 422 || msg.includes('user already registered') || msg.includes('email address is already registered'))
    return 'This email is already registered. Try signing in instead.';

  // 400 â€” wrong password / unconfirmed account
  if (msg.includes('invalid login credentials') || msg.includes('invalid email or password'))
    return 'Incorrect email or password. Double-check and try again.';
  if (msg.includes('email not confirmed'))
    return 'Please confirm your email address before signing in. Check your inbox (and spam folder).';
  if (msg.includes('email link is invalid') || msg.includes('token has expired'))
    return 'This confirmation link has expired. Please register again.';

  // Rate limiting
  if (msg.includes('too many requests') || err.status === 429)
    return 'Too many attempts. Please wait a moment and try again.';

  // Network
  if (msg.includes('failed to fetch') || msg.includes('networkerror'))
    return 'Network error â€” check your connection and try again.';

  // Weak password
  if (msg.includes('password should be'))
    return 'Password must be at least 6 characters.';

  // Generic fallback â€” show the raw message but cleaned up
  return err.message || 'Something went wrong. Please try again.';
}

// â”€â”€ AUTH SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AuthScreen({ onToast }) {
  const [mode,          setMode]          = useState('login');
  const [loading,       setLoading]       = useState(false);
  const [fieldError,    setFieldError]    = useState({}); // { email, username, password, general }
  const [awaitConfirm,  setAwaitConfirm]  = useState(false); // shown after signup with email confirm ON
  const formRef = useRef(null);

  // Clear errors when switching modes
  const switchMode = (m) => { setMode(m); setFieldError({}); setAwaitConfirm(false); };

  const validate = (email, password, username) => {
    const errs = {};
    if (mode === 'register') {
      if (!username || username.length < 2)  errs.username = 'Must be at least 2 characters.';
      if (username.length > 32)               errs.username = 'Max 32 characters.';
      if (/[^a-zA-Z0-9_.\- ]/.test(username)) errs.username = 'No special characters except . _ -';
    }
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) errs.email = 'Enter a valid email address.';
    if (!password || password.length < 6) errs.password = 'Must be at least 6 characters.';
    return errs;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (loading) return; // prevent double-submit
    setFieldError({});

    const fd       = new FormData(e.target);
    const email    = fd.get('email').trim().toLowerCase();
    const password = fd.get('password');
    const username = fd.get('username')?.trim() || '';

    // Client-side validation first â€” no network call needed
    const errs = validate(email, password, username);
    if (Object.keys(errs).length) { setFieldError(errs); return; }

    setLoading(true);
    try {
      if (mode === 'register') {
        const { data: authData, error } = await supabase.auth.signUp({ email, password });

        // Supabase signals "already registered" in multiple ways depending on settings:
        //  â€¢ error.status 422 (most common with email confirm ON)
        //  â€¢ error.message contains "already registered"
        //  â€¢ No error but user.identities === [] (email confirm OFF â€” Supabase quirk)
        const alreadyExists =
          error?.status === 422 ||
          error?.statusCode === 422 ||
          (error?.message || '').toLowerCase().includes('already registered') ||
          (error?.message || '').toLowerCase().includes('user already registered') ||
          (!error && authData?.user?.identities?.length === 0);

        if (alreadyExists) {
          setFieldError({
            email: 'This email is already registered.',
            general: 'Try signing in instead, or use a different email address.',
          });
          return;
        }

        if (error) {
          setFieldError({ general: friendlyAuthError(error) });
          return;
        }

        if (authData?.user) {
          // Create the profile row (works whether confirmed or not)
          const isDavid = username.toLowerCase().includes('david');
          const { error: profileError } = await supabase.from('users').upsert({
            id:         authData.user.id,
            uid:        authData.user.id,
            username,
            nickname:   username,
            avatar:     'pfp.png',
            banner:     '',
            color:      getPalette(username),
            bio:        '',
            isAdmin:    isDavid,
            isBanned:   false,
            status:     'online',
            lastActive: Date.now(),
          });

          if (profileError) {
            // Profile insert failed but auth succeeded â€” non-fatal, user can still log in
            console.warn('Profile upsert failed:', profileError.message);
          }

          if (!authData.session) {
            // Email confirmation required â€” show a dedicated confirmation screen
            setAwaitConfirm(true);
          } else {
            // Auto-confirmed (email confirm OFF) â€” user is now logged in via onAuthStateChange
            onToast('Account created! Welcome to NeoChat ðŸŽ‰', 'success');
          }
        }

      } else {
        // LOGIN
        const { data: loginData, error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) {
          const friendly = friendlyAuthError(error);
          // Route error to the right field
          if (friendly.toLowerCase().includes('email')) {
            setFieldError({ email: friendly });
          } else if (friendly.toLowerCase().includes('password') || friendly.toLowerCase().includes('credentials')) {
            setFieldError({ password: friendly });
          } else if (friendly.toLowerCase().includes('confirm')) {
            setFieldError({ general: friendly });
            // Offer to resend confirmation
          } else {
            setFieldError({ general: friendly });
          }
          return;
        }

        onToast('Welcome back!', 'success');
      }
    } catch (err) {
      // Network errors, unexpected throws
      setFieldError({ general: friendlyAuthError(err) });
    } finally {
      setLoading(false);
    }
  };

  // â”€â”€ Confirmation pending screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (awaitConfirm) {
    return (
      <div className="flex h-screen w-full items-center justify-center p-4 relative overflow-hidden"
        style={{ background: 'radial-gradient(ellipse at 30% 40%, rgba(88,101,242,0.12) 0%, transparent 60%), var(--bg-base)' }}>
        <div className="relative z-10 w-full max-w-[400px] anim-pop-in">
          <div className="bg-[var(--bg-panel)] border border-[var(--border)] rounded-2xl p-8 shadow-2xl text-center">
            <div className="w-16 h-16 mx-auto mb-5 rounded-full bg-[#3ba55c]/20 border-2 border-[#3ba55c] flex items-center justify-center">
              <Mail size={28} className="text-[#3ba55c]" />
            </div>
            <h2 className="text-xl font-bold text-[var(--text-main)] mb-2">Check your inbox</h2>
            <p className="text-sm text-[var(--text-muted)] mb-6 leading-relaxed">
              We sent a confirmation link to your email. Click it to activate your account, then come back and sign in.
            </p>
            <div className="bg-[var(--bg-input)] border border-[var(--border)] rounded-xl p-4 mb-6 text-left text-xs text-[var(--text-muted)] space-y-1.5">
              <p>â€¢ Check your spam / junk folder if you don't see it</p>
              <p>â€¢ The link expires after 24 hours</p>
              <p>â€¢ Make sure you used the right email address</p>
            </div>
            <button onClick={() => setAwaitConfirm(false)}
              className="w-full py-2.5 rounded-lg bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white font-semibold text-sm transition-colors">
              Back to Sign In
            </button>
          </div>
        </div>
      </div>
    );
  }

  // â”€â”€ Field error helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const FieldErr = ({ field }) => fieldError[field]
    ? <p className="text-xs text-[var(--red)] mt-1 flex items-center gap-1"><AlertCircle size={11} />{fieldError[field]}</p>
    : null;

  return (
    <div className="flex h-screen w-full items-center justify-center p-4 relative overflow-hidden"
      style={{ background: 'radial-gradient(ellipse at 30% 40%, rgba(88,101,242,0.12) 0%, transparent 60%), radial-gradient(ellipse at 70% 70%, rgba(218,70,239,0.08) 0%, transparent 50%), var(--bg-base)' }}>
      
      {/* Background grid */}
      <div className="absolute inset-0 opacity-5 pointer-events-none"
        style={{ backgroundImage: 'linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

      <div className="relative z-10 w-full max-w-[400px] anim-pop-in">
        <div className="bg-[var(--bg-panel)] border border-[var(--border)] rounded-2xl p-8 shadow-2xl">
          
          {/* Logo area */}
          <div className="text-center mb-8">
            <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-[var(--accent)] flex items-center justify-center shadow-lg">
              <MessageCircle size={32} className="text-white" />
            </div>
            <h1 className="text-2xl font-bold text-[var(--text-main)]">NeoChat</h1>
            <p className="text-sm text-[var(--text-muted)] mt-1">Real-time global communities</p>
          </div>

          {/* Tab switcher */}
          <div className="flex bg-[var(--bg-input)] rounded-lg p-1 mb-6">
            {[['login','Sign In'],['register','Register']].map(([m, label]) => (
              <button key={m} type="button" onClick={() => switchMode(m)}
                className={`flex-1 py-2 rounded-md text-sm font-semibold transition-all ${mode === m ? 'bg-[var(--bg-panel)] text-[var(--text-main)] shadow' : 'text-[var(--text-faded)] hover:text-[var(--text-muted)]'}`}>
                {label}
              </button>
            ))}
          </div>

          {/* General error banner */}
          {fieldError.general && (
            <div className="flex items-start gap-2 bg-[var(--red)]/10 border border-[var(--red)]/30 text-[var(--red)] rounded-lg px-3 py-2.5 mb-4 text-sm">
              <AlertCircle size={15} className="shrink-0 mt-0.5" />
              <span>{fieldError.general}</span>
            </div>
          )}

          <form ref={formRef} onSubmit={handleSubmit} className="space-y-4" noValidate>
            {mode === 'register' && (
              <div>
                <label className="block text-xs font-semibold text-[var(--text-faded)] uppercase tracking-wider mb-1.5">Username</label>
                <div className="relative">
                  <User size={15} className={`absolute left-3 top-1/2 -translate-y-1/2 ${fieldError.username ? 'text-[var(--red)]' : 'text-[var(--text-faded)]'}`} />
                  <input name="username" maxLength={32} placeholder="yourname" autoComplete="off"
                    className={`w-full bg-[var(--bg-input)] border text-[var(--text-main)] placeholder-[var(--text-faded)] rounded-lg pl-9 pr-4 py-3 text-sm focus:outline-none transition-colors ${fieldError.username ? 'border-[var(--red)]' : 'border-[var(--border)] focus:border-[var(--accent)]'}`} />
                </div>
                <FieldErr field="username" />
              </div>
            )}
            <div>
              <label className="block text-xs font-semibold text-[var(--text-faded)] uppercase tracking-wider mb-1.5">Email</label>
              <div className="relative">
                <Mail size={15} className={`absolute left-3 top-1/2 -translate-y-1/2 ${fieldError.email ? 'text-[var(--red)]' : 'text-[var(--text-faded)]'}`} />
                <input name="email" type="email" placeholder="you@example.com" autoComplete="email"
                  className={`w-full bg-[var(--bg-input)] border text-[var(--text-main)] placeholder-[var(--text-faded)] rounded-lg pl-9 pr-4 py-3 text-sm focus:outline-none transition-colors ${fieldError.email ? 'border-[var(--red)]' : 'border-[var(--border)] focus:border-[var(--accent)]'}`} />
              </div>
              <FieldErr field="email" />
            </div>
            <div>
              <label className="block text-xs font-semibold text-[var(--text-faded)] uppercase tracking-wider mb-1.5">Password</label>
              <div className="relative">
                <Lock size={15} className={`absolute left-3 top-1/2 -translate-y-1/2 ${fieldError.password ? 'text-[var(--red)]' : 'text-[var(--text-faded)]'}`} />
                <input name="password" type="password" minLength={6} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autoComplete={mode === 'login' ? 'current-password' : 'new-password'}
                  className={`w-full bg-[var(--bg-input)] border text-[var(--text-main)] placeholder-[var(--text-faded)] rounded-lg pl-9 pr-4 py-3 text-sm focus:outline-none transition-colors ${fieldError.password ? 'border-[var(--red)]' : 'border-[var(--border)] focus:border-[var(--accent)]'}`} />
              </div>
              <FieldErr field="password" />
            </div>

            <button type="submit" disabled={loading}
              className="w-full bg-[var(--accent)] hover:bg-[var(--accent-hover)] disabled:opacity-60 disabled:cursor-not-allowed text-white font-semibold py-3 rounded-lg transition-all active:scale-[0.98] flex items-center justify-center gap-2 mt-2">
              {loading
                ? <><span className="anim-spin inline-block"><RefreshCw size={16} /></span> Please wait...</>
                : mode === 'login' ? 'Sign In' : 'Create Account'}
            </button>
          </form>

          {/* Switch mode hint */}
          <p className="text-center text-xs text-[var(--text-faded)] mt-5">
            {mode === 'login'
              ? <>Don't have an account? <button type="button" onClick={() => switchMode('register')} className="text-[var(--accent)] hover:underline font-semibold">Register</button></>
              : <>Already have an account? <button type="button" onClick={() => switchMode('login')} className="text-[var(--accent)] hover:underline font-semibold">Sign In</button></>}
          </p>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ PROFILE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ProfileModal({ target, profile, data, onClose, onSendRequest, onAcceptRequest, onRemoveFriend, onStartDM, onAdminBan, onAdminPurge, onAdminDelete }) {
  if (!target) return null;
  
  const [menuOpen, setMenuOpen] = useState(false);
  const isSelf = target.uid === profile.uid;
  const sortedKey = [profile.uid, target.uid].sort().join('_');
  const dmChan = data.channels.find(c => c.serverId === 'dm' && c.name === sortedKey);
  const pendingReq = data.channels.find(c => c.serverId === 'request' &&
    (c.name === `${profile.uid}_${target.uid}` || c.name === `${target.uid}_${profile.uid}`));
  const isOutgoing = pendingReq?.name.startsWith(profile.uid);

  return (
    <Modal open={!!target} onClose={onClose} maxWidth={340}>
      {/* Banner */}
      <div className="h-24 relative" style={{
        backgroundColor: target.color || 'var(--accent)',
        backgroundImage: target.banner ? `url(${target.banner})` : undefined,
        backgroundSize: 'cover', backgroundPosition: 'center'
      }} />
      
      <div className="px-5 pb-5 relative pt-16">
        {/* Avatar */}
        <div className="absolute -top-11 left-5 rounded-full border-[5px] border-[var(--bg-panel)]" style={{ background: 'var(--bg-panel)' }}>
          <Avatar user={target} size={80} showStatus={!target.isDeleted} />
        </div>

        {/* Close button */}
        <button onClick={onClose} className="absolute top-3 right-3 p-1.5 rounded-lg hover:bg-[var(--bg-hover)] text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors">
          <X size={18} />
        </button>

        {/* Info */}
        <div className="mt-1">
          <div className="flex items-center gap-2 flex-wrap">
            <h2 className="text-xl font-bold text-[var(--text-main)]">{target.nickname || target.username}</h2>
            {target.isAdmin && <span className="bg-amber-400 text-black text-[9px] px-1.5 py-0.5 rounded font-bold tracking-wider">ADMIN</span>}
          </div>
          <p className="text-sm text-[var(--text-muted)]">{target.nickname ? target.username : ''}#{target.uid.slice(0, 6)}</p>
          {target.isDeleted && <p className="text-xs text-[var(--red)] mt-0.5">Account deleted</p>}
        </div>

        {/* Bio card */}
        <div className="bg-[var(--bg-input)] rounded-xl p-3 border border-[var(--border)] mt-4">
          <p className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider mb-1.5">About Me</p>
          <p className="text-sm text-[var(--text-main)] break-words whitespace-pre-wrap max-h-20 overflow-y-auto scrollbar">
            {target.bio || <span className="text-[var(--text-faded)] italic">No bio set.</span>}
          </p>
          <p className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider mb-1 mt-3">Member Since</p>
          <p className="text-sm text-[var(--text-main)]">
            {target.isDeleted ? 'Account Deleted' : new Date(target.lastActive || Date.now()).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
          </p>
        </div>

        {/* Action buttons */}
        {!target.isDeleted && (
          <div className="mt-4 relative">
            {isSelf ? (
              <button onClick={() => { onClose(); window.__openSettings?.('profiles'); }}
                className="w-full py-2 rounded-lg bg-[var(--bg-input)] border border-[var(--border)] text-sm font-medium hover:bg-[var(--bg-hover)] transition-colors">
                Edit Profile
              </button>
            ) : dmChan ? (
              <div className="flex gap-2">
                <button onClick={() => { onStartDM(target); onClose(); }}
                  className="flex-1 py-2 rounded-lg bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white text-sm font-semibold transition-colors">
                  Message
                </button>
                <div className="relative">
                  <button onClick={() => setMenuOpen(!menuOpen)}
                    className="px-3 py-2 rounded-lg bg-[var(--bg-input)] border border-[var(--border)] hover:bg-[var(--bg-hover)] transition-colors">
                    <MoreHorizontal size={16} />
                  </button>
                  {menuOpen && (
                    <div className="absolute bottom-full right-0 mb-2 w-44 bg-[var(--bg-panel)] border border-[var(--border)] rounded-xl shadow-xl py-1 z-50 anim-pop-in">
                      <button onClick={() => { onRemoveFriend(dmChan.id); onClose(); }}
                        className="w-full text-left px-3 py-2 text-sm hover:bg-[var(--red)] hover:text-white transition-colors flex items-center gap-2 text-[var(--red)]">
                        <UserMinus size={14} /> Remove Friend
                      </button>
                    </div>
                  )}
                </div>
              </div>
            ) : pendingReq ? (
              isOutgoing ? (
                <button onClick={() => onRemoveFriend(pendingReq.id)}
                  className="w-full py-2 rounded-lg bg-[var(--bg-input)] border border-[var(--border)] text-sm font-medium hover:bg-[var(--bg-hover)] transition-colors flex items-center justify-center gap-2">
                  <UserX size={15} /> Cancel Request
                </button>
              ) : (
                <div className="flex gap-2">
                  <button onClick={() => { onAcceptRequest(pendingReq.id, target); onClose(); }}
                    className="flex-1 py-2 rounded-lg bg-[#3ba55c] hover:bg-[#2d8046] text-white text-sm font-semibold transition-colors flex items-center justify-center gap-1">
                    <UserCheck size={15} /> Accept
                  </button>
                  <button onClick={() => onRemoveFriend(pendingReq.id)}
                    className="flex-1 py-2 rounded-lg bg-[var(--bg-input)] border border-[var(--border)] text-sm font-medium hover:bg-[var(--red)] hover:text-white hover:border-[var(--red)] transition-colors">
                    Decline
                  </button>
                </div>
              )
            ) : (
              <button onClick={() => { onSendRequest(target); onClose(); }}
                className="w-full py-2 rounded-lg bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white text-sm font-semibold transition-colors flex items-center justify-center gap-2">
                <UserPlus size={15} /> Add Friend
              </button>
            )}
          </div>
        )}

        {/* Admin tools */}
        {profile.isAdmin && !target.isDeleted && !isSelf && (
          <div className="mt-4 border-t border-[var(--border)] pt-4">
            <p className="text-[10px] font-bold text-[var(--red)] uppercase tracking-wider mb-2 flex items-center gap-1">
              <AlertCircle size={11} /> Admin
            </p>
            <div className="flex gap-2">
              <button onClick={() => onAdminBan(target.uid)}
                className="flex-1 py-1.5 rounded-lg text-xs font-bold text-[var(--red)] border border-[var(--red)]/30 hover:bg-[var(--red)] hover:text-white transition-colors">
                Ban
              </button>
              <button onClick={() => onAdminPurge(target.uid)}
                className="flex-1 py-1.5 rounded-lg text-xs font-bold text-[var(--red)] border border-[var(--red)]/30 hover:bg-[var(--red)] hover:text-white transition-colors">
                Purge Chat
              </button>
              <button onClick={() => onAdminDelete(target.uid)}
                className="flex-1 py-1.5 rounded-lg text-xs font-bold text-[var(--red)] border border-[var(--red)]/30 hover:bg-[var(--red)] hover:text-white transition-colors">
                Delete
              </button>
            </div>
          </div>
        )}
      </div>
    </Modal>
  );
}

// â”€â”€ SETTINGS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SettingsModal({ open, onClose, profile, onUpdate, onLogout, initialTab = 'account' }) {
  const [tab, setTab] = useState(initialTab);
  
  useEffect(() => { if (open) setTab(initialTab); }, [open, initialTab]);

  const tabs = [
    { id: 'account', label: 'My Account', group: 'user' },
    { id: 'profiles', label: 'Profiles', group: 'user' },
    { id: 'appearance', label: 'Appearance', group: 'app' },
    { id: 'notifications', label: 'Notifications', group: 'app' },
  ];

  if (!open) return null;

  return (
    <div className="modal-backdrop p-0" onClick={onClose}>
      <div className="w-full h-full md:h-auto md:max-h-[88vh] md:max-w-4xl bg-[var(--bg-panel)] md:rounded-2xl border border-[var(--border)] shadow-2xl flex overflow-hidden anim-pop-in"
        onClick={e => e.stopPropagation()}>
        
        {/* Sidebar */}
        <div className="w-56 bg-[var(--bg-sidebar)] p-4 flex-col gap-1 hidden md:flex shrink-0 border-r border-[var(--border)]">
          <p className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider px-2 mb-1 mt-2">User Settings</p>
          {tabs.filter(t => t.group === 'user').map(t => (
            <button key={t.id} onClick={() => setTab(t.id)}
              className={`text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors ${tab === t.id ? 'bg-[var(--bg-hover)] text-[var(--text-main)]' : 'text-[var(--text-muted)] hover:bg-[var(--bg-hover)] hover:text-[var(--text-main)]'}`}>
              {t.label}
            </button>
          ))}
          <p className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider px-2 mb-1 mt-4">App Settings</p>
          {tabs.filter(t => t.group === 'app').map(t => (
            <button key={t.id} onClick={() => setTab(t.id)}
              className={`text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors ${tab === t.id ? 'bg-[var(--bg-hover)] text-[var(--text-main)]' : 'text-[var(--text-muted)] hover:bg-[var(--bg-hover)] hover:text-[var(--text-main)]'}`}>
              {t.label}
            </button>
          ))}
          <div className="mt-auto pt-4 border-t border-[var(--border)]">
            <button onClick={onLogout}
              className="w-full flex items-center gap-2 px-3 py-2 text-sm font-semibold text-[var(--red)] rounded-lg hover:bg-[var(--red)] hover:text-white transition-colors">
              <LogOut size={15} /> Log Out
            </button>
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6 md:p-10 relative scrollbar">
          <button onClick={onClose} className="absolute top-4 right-4 p-2 rounded-lg hover:bg-[var(--bg-hover)] text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors">
            <X size={20} />
          </button>

          {/* Mobile tabs */}
          <div className="flex gap-2 overflow-x-auto pb-2 mb-6 md:hidden scrollbar">
            {tabs.map(t => (
              <button key={t.id} onClick={() => setTab(t.id)}
                className={`whitespace-nowrap px-3 py-1.5 rounded-lg text-sm font-medium transition-colors shrink-0 ${tab === t.id ? 'bg-[var(--accent)] text-white' : 'bg-[var(--bg-input)] text-[var(--text-muted)]'}`}>
                {t.label}
              </button>
            ))}
          </div>

          {tab === 'account' && (
            <div>
              <h2 className="text-xl font-bold text-[var(--text-main)] mb-6">My Account</h2>
              <div className="bg-[var(--bg-sidebar)] rounded-xl border border-[var(--border)] overflow-hidden mb-6">
                <div className="h-20" style={{ backgroundColor: profile.color || 'var(--accent)', backgroundImage: profile.banner ? `url(${profile.banner})` : undefined, backgroundSize: 'cover', backgroundPosition: 'center' }} />
                <div className="px-5 pb-5 pt-14 relative">
                  <div className="absolute -top-10 left-5 rounded-full border-[5px] border-[var(--bg-sidebar)]">
                    <Avatar user={profile} size={76} />
                  </div>
                  <div className="flex items-start justify-between flex-wrap gap-3 mt-1">
                    <div>
                      <h3 className="text-lg font-bold text-[var(--text-main)]">{profile.nickname || profile.username}</h3>
                      <p className="text-sm text-[var(--text-muted)]">#{profile.uid.slice(0, 8)}</p>
                    </div>
                    <button onClick={() => setTab('profiles')}
                      className="px-4 py-2 bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white text-sm font-semibold rounded-lg transition-colors">
                      Edit Profile
                    </button>
                  </div>
                </div>
              </div>
              <div className="bg-[var(--bg-sidebar)] rounded-xl border border-[var(--border)] p-4">
                <p className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider mb-3">Account Info</p>
                <div className="space-y-3">
                  <div>
                    <p className="text-xs text-[var(--text-faded)] mb-0.5">Username</p>
                    <p className="text-sm font-medium text-[var(--text-main)]">{profile.username}</p>
                  </div>
                  <div>
                    <p className="text-xs text-[var(--text-faded)] mb-0.5">User ID</p>
                    <p className="text-sm font-mono text-[var(--text-muted)]">{profile.uid}</p>
                  </div>
                </div>
              </div>
            </div>
          )}

          {tab === 'profiles' && (
            <div>
              <h2 className="text-xl font-bold text-[var(--text-main)] mb-6">Profiles</h2>
              <div className="space-y-5">
                <div>
                  <label className="block text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider mb-2">Display Name</label>
                  <input type="text" defaultValue={profile.nickname || profile.username} maxLength={32}
                    onBlur={e => onUpdate({ nickname: e.target.value.trim() || profile.username })}
                    className="w-full bg-[var(--bg-input)] border border-[var(--border)] text-[var(--text-main)] rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-[var(--accent)] transition-colors" />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider mb-2">Avatar</label>
                    <div className="flex items-center gap-3">
                      <Avatar user={profile} size={56} />
                      <label className="px-3 py-2 bg-[var(--bg-input)] border border-[var(--border)] rounded-lg text-sm font-medium cursor-pointer hover:bg-[var(--bg-hover)] transition-colors">
                        Change
                        <input type="file" hidden accept="image/*" onChange={async e => {
                          if (!e.target.files?.[0]) return;
                          try {
                            const b64 = await compressImage(e.target.files[0], 400, 400, 0.85);
                            onUpdate({ avatar: b64 });
                          } catch (err) { alert(err.message); }
                        }} />
                      </label>
                    </div>
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider mb-2">Profile Color</label>
                    <div className="flex items-center gap-2">
                      <input type="color" defaultValue={profile.color || getPalette(profile.username)}
                        onBlur={e => onUpdate({ color: e.target.value })}
                        className="w-10 h-10 rounded-lg cursor-pointer border border-[var(--border)] bg-transparent p-0.5" />
                      <span className="text-xs text-[var(--text-muted)]">Banner fallback color</span>
                    </div>
                  </div>
                </div>
                <div>
                  <label className="block text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider mb-2">Banner Image</label>
                  <div className="h-28 rounded-xl bg-[var(--bg-input)] border-2 border-dashed border-[var(--border)] relative overflow-hidden group flex items-center justify-center"
                    style={{ backgroundImage: profile.banner ? `url(${profile.banner})` : undefined, backgroundSize: 'cover', backgroundPosition: 'center' }}>
                    {profile.banner && <div className="absolute inset-0 bg-black/40 group-hover:bg-black/50 transition-colors" />}
                    <label className="relative z-10 px-4 py-2 bg-[var(--bg-panel)] border border-[var(--border)] rounded-lg text-sm font-medium cursor-pointer hover:bg-[var(--bg-hover)] transition-colors flex items-center gap-2">
                      <ImageIcon size={14} /> Upload Banner
                      <input type="file" hidden accept="image/*" onChange={async e => {
                        if (!e.target.files?.[0]) return;
                        try {
                          const b64 = await compressImage(e.target.files[0], 1200, 600, 0.82);
                          onUpdate({ banner: b64 });
                        } catch (err) { alert(err.message); }
                      }} />
                    </label>
                  </div>
                  {profile.banner && (
                    <button onClick={() => onUpdate({ banner: '' })} className="text-xs text-[var(--red)] mt-1 hover:underline">Remove banner</button>
                  )}
                </div>
                <div>
                  <label className="block text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider mb-2">Bio <span className="text-[var(--text-faded)] font-normal normal-case">(max 180 chars)</span></label>
                  <textarea rows={3} maxLength={180} defaultValue={profile.bio}
                    onBlur={e => onUpdate({ bio: e.target.value })}
                    placeholder="Tell the world about yourself..."
                    className="w-full bg-[var(--bg-input)] border border-[var(--border)] text-[var(--text-main)] placeholder-[var(--text-faded)] rounded-lg px-4 py-3 text-sm resize-none focus:outline-none focus:border-[var(--accent)] transition-colors" />
                </div>
              </div>
            </div>
          )}

          {tab === 'appearance' && (
            <div>
              <h2 className="text-xl font-bold text-[var(--text-main)] mb-6">Appearance</h2>
              <p className="text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider mb-3">Theme</p>
              <div className="space-y-2">
                {[
                  { id: 'dark',  label: 'Dark', desc: 'Easy on the eyes' },
                  { id: 'light', label: 'Light', desc: 'Bright and clean' },
                  { id: 'oled',  label: 'Midnight (OLED)', desc: 'Pure black for OLED displays' },
                ].map(t => {
                  const cur = localStorage.getItem('neochat_theme') || 'dark';
                  return (
                    <label key={t.id} className="flex items-center gap-3 p-4 rounded-xl bg-[var(--bg-sidebar)] border border-[var(--border)] cursor-pointer hover:border-[var(--accent)] transition-colors">
                      <input type="radio" name="theme" value={t.id} defaultChecked={cur === t.id}
                        onChange={e => { localStorage.setItem('neochat_theme', e.target.value); document.body.className = `overflow-hidden theme-${e.target.value}`; }}
                        className="w-4 h-4 accent-[var(--accent)]" />
                      <div>
                        <p className="font-semibold text-sm text-[var(--text-main)]">{t.label}</p>
                        <p className="text-xs text-[var(--text-muted)]">{t.desc}</p>
                      </div>
                    </label>
                  );
                })}
              </div>
            </div>
          )}

          {tab === 'notifications' && (
            <div>
              <h2 className="text-xl font-bold text-[var(--text-main)] mb-6">Notifications</h2>
              <div className="bg-[var(--bg-sidebar)] border border-[var(--border)] rounded-xl p-5">
                <div className="flex items-start gap-3">
                  <Bell size={20} className="text-[var(--accent)] mt-0.5 shrink-0" />
                  <div className="flex-1">
                    <p className="font-semibold text-[var(--text-main)] mb-1">Browser Notifications</p>
                    <p className="text-sm text-[var(--text-muted)] mb-4">Get notified when friends message you, even when NeoChat is in the background.</p>
                    <button onClick={() => {
                      if (!('Notification' in window)) return alert('Your browser does not support notifications.');
                      Notification.requestPermission().then(p => alert(p === 'granted' ? 'âœ… Notifications enabled!' : 'âŒ Permission denied.'));
                    }} className="px-4 py-2 bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white text-sm font-semibold rounded-lg transition-colors">
                      Enable Notifications
                    </button>
                    {typeof Notification !== 'undefined' && Notification.permission === 'granted' && (
                      <span className="ml-3 text-xs text-[#3ba55c] font-semibold">âœ“ Enabled</span>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Mobile logout */}
          <div className="md:hidden mt-8 pt-6 border-t border-[var(--border)]">
            <button onClick={onLogout} className="w-full flex items-center justify-center gap-2 py-3 rounded-xl bg-[var(--red)] text-white font-semibold">
              <LogOut size={16} /> Log Out
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  // â”€â”€â”€ Auth / Data state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [user,       setUser]       = useState(null);
  const [data,       setData]       = useState({ users: [], servers: [], channels: [], messages: [] });
  const [loading,    setLoading]    = useState(true);
  const [connStatus, setConnStatus] = useState('connecting'); // 'connecting' | 'connected' | 'disconnected'
  const [toast,      setToast]      = useState(null);
  const toastTimer = useRef(null);

  // â”€â”€â”€ App state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [context,         setContext]         = useState('home');
  const [activeServerId,  setActiveServerId]  = useState(null);
  const [activeChannelId, setActiveChannelId] = useState(null);
  const [homeTab,         setHomeTab]         = useState('online');
  const [closedDMs,       setClosedDMs]       = useState(() => JSON.parse(localStorage.getItem('neo_closed_dms') || '{}'));

  // â”€â”€â”€ UI state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [leftOpen,            setLeftOpen]            = useState(false);
  const [membersSidebarOpen,  setMembersSidebarOpen]  = useState(false);
  const [dmSidebarOpen,       setDmSidebarOpen]       = useState(true);
  const [profileModal,        setProfileModal]        = useState(null);
  const [settingsOpen,        setSettingsOpen]        = useState(false);
  const [settingsTab,         setSettingsTab]         = useState('account');
  const [imageView,           setImageView]           = useState(null);
  const [editingMsg,          setEditingMsg]          = useState(null);
  const [searchQuery,         setSearchQuery]         = useState('');
  const [showSearch,          setShowSearch]          = useState(false);
  const [showNotifs,          setShowNotifs]          = useState(false);
  const [showCreateServer,    setShowCreateServer]    = useState(false);
  const [showCreateChannel,   setShowCreateChannel]   = useState(false);
  const [showServerSettings,  setShowServerSettings]  = useState(false);
  const [atBottom,            setAtBottom]            = useState(true);
  const [unreadCounts,        setUnreadCounts]        = useState({});
  const [typers,              setTypers]              = useState([]); // placeholder
  const [micMuted,            setMicMuted]            = useState(false);
  const [deafened,            setDeafened]            = useState(false);

  const messagesEndRef  = useRef(null);
  const msgListRef      = useRef(null);
  const channelRef      = useRef(null);

  // â”€â”€â”€ Toast helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const showToast = useCallback((message, type = 'info') => {
    clearTimeout(toastTimer.current);
    setToast({ message, type });
    toastTimer.current = setTimeout(() => setToast(null), 3500);
  }, []);

  // â”€â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    const saved = localStorage.getItem('neochat_theme') || 'dark';
    document.body.className = `overflow-hidden theme-${saved}`;
  }, []);

  // â”€â”€â”€ Auth setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) setUser({ uid: session.user.id });
      else { setUser(null); setLoading(false); setConnStatus('connected'); }
    });
    const { data: sub } = supabase.auth.onAuthStateChange((_, session) => {
      if (session) setUser({ uid: session.user.id });
      else { setUser(null); setLoading(false); setConnStatus('connected'); }
    });
    return () => sub.subscription.unsubscribe();
  }, []);

  // â”€â”€â”€ Data fetch + realtime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    if (!user?.uid) return;
    let rtChannel;
    let reconnectTimer;

    const fetchAll = async () => {
      setConnStatus('connecting');
      try {
        const [u, s, c, m] = await Promise.all([
          supabase.from('users').select('*'),
          supabase.from('servers').select('*'),
          supabase.from('channels').select('*'),
          supabase.from('messages').select('*').order('timestamp', { ascending: true }),
        ]);
        if (u.error || s.error || c.error || m.error) throw u.error || s.error || c.error || m.error;
        setData({ users: u.data || [], servers: s.data || [], channels: c.data || [], messages: m.data || [] });
        setConnStatus('connected');
      } catch (err) {
        console.error('Fetch error:', err);
        setConnStatus('disconnected');
        reconnectTimer = setTimeout(fetchAll, 8000);
        return;
      }
      setLoading(false);

      rtChannel = supabase.channel('db-changes')
        .on('postgres_changes', { event: '*', schema: 'public' }, ({ table, eventType, new: nr, old: or }) => {
          setData(prev => {
            if (!prev[table]) return prev;
            const next = { ...prev, [table]: [...prev[table]] };
            if (eventType === 'INSERT') {
              if (!next[table].find(i => i.id === nr.id)) next[table] = [...next[table], nr];
            } else if (eventType === 'UPDATE') {
              next[table] = next[table].map(i => i.id === nr.id ? nr : i);
            } else if (eventType === 'DELETE') {
              next[table] = next[table].filter(i => i.id !== or.id);
            }
            return next;
          });
        })
        .subscribe(status => {
          if (status === 'SUBSCRIBED') setConnStatus('connected');
          if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
            setConnStatus('disconnected');
          }
        });
    };

    fetchAll();
    return () => {
      clearTimeout(reconnectTimer);
      if (rtChannel) supabase.removeChannel(rtChannel);
    };
  }, [user?.uid]);

  // â”€â”€â”€ Presence ping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const profile = useMemo(() => user ? data.users.find(u => u.uid === user.uid) : null, [user, data.users]);

  useEffect(() => {
    if (!user?.uid || !profile?.id) return;
    const ping = () => supabase.from('users').update({ lastActive: Date.now(), status: 'online' }).eq('id', user.uid);
    ping();
    const interval = setInterval(ping, PRESENCE_INTERVAL);
    return () => clearInterval(interval);
  }, [user?.uid, profile?.id]);

  // â”€â”€â”€ Expose global helpers for child components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    window.__openProfile = (u) => setProfileModal(u);
    window.__openSettings = (tab) => { setSettingsTab(tab || 'account'); setSettingsOpen(true); };
    return () => { delete window.__openProfile; delete window.__openSettings; };
  }, []);

  // â”€â”€â”€ Derived data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const activeServer = useMemo(() => data.servers.find(s => s.id === activeServerId), [data.servers, activeServerId]);
  const serverChannels = useMemo(() =>
    data.channels.filter(c => c.serverId === activeServerId).sort((a,b) => a.createdAt - b.createdAt),
    [data.channels, activeServerId]);
  const activeChannel = useMemo(() => data.channels.find(c => c.id === activeChannelId), [data.channels, activeChannelId]);

  const channelMessages = useMemo(() =>
    data.messages.filter(m => m.channelId === activeChannelId).sort((a,b) => a.timestamp - b.timestamp),
    [data.messages, activeChannelId]);

  const allDMs = useMemo(() => {
    if (!profile) return [];
    return data.channels
      .filter(c => c.serverId === 'dm' && c.name.includes(profile.uid))
      .map(c => {
        const otherUid = c.name.split('_').find(id => id !== profile.uid);
        const otherUser = data.users.find(u => u.uid === otherUid) || getDeletedUser(otherUid);
        const msgs = data.messages.filter(m => m.channelId === c.id);
        const latest = msgs.length ? Math.max(...msgs.map(m => m.timestamp)) : c.createdAt;
        const lastMsg = msgs[msgs.length - 1];
        return { ...c, targetUser: otherUser, latestActivity: latest, lastMsg };
      }).sort((a,b) => b.latestActivity - a.latestActivity);
  }, [data.channels, data.users, data.messages, profile]);

  const activeDMs = useMemo(() => allDMs.filter(c => {
    const closedAt = closedDMs[c.id];
    return !closedAt || c.latestActivity > closedAt;
  }), [allDMs, closedDMs]);

  const pendingRequests = useMemo(() => {
    if (!profile) return [];
    return data.channels
      .filter(c => c.serverId === 'request' && c.name.includes(profile.uid))
      .map(c => {
        const [uid1, uid2] = c.name.split('_');
        const isOutgoing = uid1 === profile.uid;
        const otherUid = isOutgoing ? uid2 : uid1;
        const otherUser = data.users.find(u => u.uid === otherUid) || getDeletedUser(otherUid);
        return { ...c, targetUser: otherUser, isOutgoing };
      }).sort((a,b) => b.createdAt - a.createdAt);
  }, [data.channels, data.users, profile]);

  const pendingIncoming = useMemo(() => pendingRequests.filter(r => !r.isOutgoing).length, [pendingRequests]);

  const searchResults = useMemo(() => {
    if (!searchQuery.trim()) return [];
    const q = searchQuery.toLowerCase();
    return data.messages
      .filter(m => m.text?.toLowerCase().includes(q))
      .sort((a,b) => b.timestamp - a.timestamp)
      .slice(0, 40);
  }, [data.messages, searchQuery]);

  const myNotifications = useMemo(() => {
    if (!profile) return [];
    const dmIds = allDMs.map(c => c.id);
    return data.messages
      .filter(m => dmIds.includes(m.channelId) && m.senderId !== profile.uid)
      .sort((a,b) => b.timestamp - a.timestamp)
      .slice(0, 20);
  }, [allDMs, data.messages, profile]);

  // â”€â”€â”€ Channel header info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const channelInfo = useMemo(() => {
    if (!activeChannelId) return null;
    if (context === 'server' && activeChannel) {
      return { name: activeChannel.name, isDM: false };
    }
    if (context === 'home') {
      const ch = allDMs.find(c => c.id === activeChannelId);
      if (ch) return { name: ch.targetUser.nickname || ch.targetUser.username, isDM: true, avatar: ch.targetUser.avatar, color: ch.targetUser.color, banner: ch.targetUser.banner, targetUser: ch.targetUser };
    }
    return null;
  }, [activeChannelId, context, activeChannel, allDMs]);

  // â”€â”€â”€ Sound & scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    if (!channelMessages.length || !profile) return;
    const last = channelMessages[channelMessages.length - 1];
    const isNew = Date.now() - last.timestamp < 5000;
    const isOthers = last.senderId !== profile.uid;
    if (isNew && isOthers && !deafened) {
      playNotifSound();
      if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
        const sender = data.users.find(u => u.uid === last.senderId);
        try { new Notification(`${sender?.username || 'Someone'}: ${last.text || 'ðŸ“· Image'}`, { silent: true }); } catch {}
      }
    }
    if (atBottom) scrollToBottom();
    else {
      // Increment unread for this channel
      if (isOthers && isNew) {
        setUnreadCounts(prev => ({ ...prev, [activeChannelId]: (prev[activeChannelId] || 0) + 1 }));
      }
    }
  }, [channelMessages.length]);

  const scrollToBottom = useCallback((smooth = false) => {
    messagesEndRef.current?.scrollIntoView({ behavior: smooth ? 'smooth' : 'auto' });
  }, []);

  const handleMsgScroll = useCallback((e) => {
    const el = e.target;
    const bottom = el.scrollHeight - el.clientHeight - el.scrollTop < 60;
    setAtBottom(bottom);
    if (bottom) setUnreadCounts(prev => ({ ...prev, [activeChannelId]: 0 }));
  }, [activeChannelId]);

  // â”€â”€â”€ Navigation helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const switchContext = useCallback((ctx, id = null) => {
    setContext(ctx);
    if (ctx === 'server') {
      setActiveServerId(id);
      const first = data.channels.find(c => c.serverId === id);
      if (first) setActiveChannelId(first.id);
    } else {
      setActiveServerId(null);
      if (ctx === 'home' && id) {
        setActiveChannelId(id);
      } else if (ctx !== 'home') {
        setActiveChannelId(null);
      }
    }
    setLeftOpen(false);
    setEditingMsg(null);
  }, [data.channels]);

  const openDM = useCallback((chId) => {
    setContext('home');
    setActiveChannelId(chId);
    setLeftOpen(false);
    setUnreadCounts(prev => ({ ...prev, [chId]: 0 }));
  }, []);

  // â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const handleLogout = async () => {
    await supabase.auth.signOut();
    switchContext('home');
    showToast('Logged out.', 'info');
  };

  const handleSendRequest = async (targetUser) => {
    if (!profile || !targetUser) return;
    const req = { id: genId('req'), serverId: 'request', name: `${profile.uid}_${targetUser.uid}`, createdAt: Date.now() };
    setData(prev => ({ ...prev, channels: [...prev.channels, req] }));
    const { error } = await supabase.from('channels').insert(req);
    if (error) { setData(prev => ({ ...prev, channels: prev.channels.filter(c => c.id !== req.id) })); return showToast(error.message, 'error'); }
    showToast(`Friend request sent to ${targetUser.username}!`, 'success');
  };

  const handleAcceptRequest = async (channelId, targetUser) => {
    const dmName = [profile.uid, targetUser.uid].sort().join('_');
    setData(prev => ({ ...prev, channels: prev.channels.map(c => c.id === channelId ? { ...c, serverId: 'dm', name: dmName } : c) }));
    const { error } = await supabase.from('channels').update({ serverId: 'dm', name: dmName }).eq('id', channelId);
    if (error) { showToast(error.message, 'error'); return; }
    showToast(`You're now friends with ${targetUser.username}!`, 'success');
  };

  const handleRemoveFriend = async (channelId) => {
    setData(prev => ({ ...prev, channels: prev.channels.filter(c => c.id !== channelId) }));
    await supabase.from('channels').delete().eq('id', channelId);
    if (activeChannelId === channelId) switchContext('home');
  };

  const handleStartDM = async (targetUser) => {
    if (!profile || !targetUser || targetUser.isDeleted) return;
    const dmName = [profile.uid, targetUser.uid].sort().join('_');
    let ch = data.channels.find(c => c.serverId === 'dm' && c.name === dmName);
    if (!ch) {
      const pending = data.channels.find(c => c.serverId === 'request' &&
        (c.name === `${profile.uid}_${targetUser.uid}` || c.name === `${targetUser.uid}_${profile.uid}`));
      if (pending) {
        const isIncoming = pending.name.startsWith(targetUser.uid);
        if (isIncoming) await handleAcceptRequest(pending.id, targetUser);
        else return showToast('Request pending â€” they must accept first.', 'info');
        ch = { ...pending, serverId: 'dm', name: dmName };
      } else {
        return showToast('You must be friends to send DMs.', 'error');
      }
    }
    // Reopen if closed
    if (closedDMs[ch.id]) {
      const nc = { ...closedDMs }; delete nc[ch.id]; setClosedDMs(nc);
      localStorage.setItem('neo_closed_dms', JSON.stringify(nc));
    }
    setProfileModal(null);
    openDM(ch.id);
  };

  const handleCloseDM = (e, chId) => {
    e?.stopPropagation();
    const nc = { ...closedDMs, [chId]: Date.now() };
    setClosedDMs(nc);
    localStorage.setItem('neo_closed_dms', JSON.stringify(nc));
    if (activeChannelId === chId) switchContext('home');
  };

  const handleAddFriend = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const name = fd.get('uname').trim().toLowerCase();
    if (!name) return;
    if (name === profile.username.toLowerCase()) return showToast("You can't add yourself.", 'warn');
    const target = data.users.find(u => u.username.toLowerCase() === name && !u.isDeleted);
    if (!target) return showToast('User not found â€” check exact username.', 'error');
    const sorted = [profile.uid, target.uid].sort().join('_');
    if (data.channels.find(c => c.serverId === 'dm' && c.name === sorted)) return showToast('Already friends.', 'info');
    if (data.channels.find(c => c.serverId === 'request' && (c.name === `${profile.uid}_${target.uid}` || c.name === `${target.uid}_${profile.uid}`))) return showToast('Request already exists.', 'info');
    await handleSendRequest(target);
    e.target.reset();
  };

  const handleCreateServer = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const name = fd.get('name').trim();
    if (!name) return;
    const sid = genId('srv'), cid = genId('chan');
    const srv = { id: sid, name, ownerId: profile.uid, createdAt: Date.now(), icon: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=5865F2&color=fff&bold=true` };
    const ch  = { id: cid, serverId: sid, name: 'general', createdAt: Date.now() };
    setData(prev => ({ ...prev, servers: [...prev.servers, srv], channels: [...prev.channels, ch] }));
    await supabase.from('servers').insert(srv);
    await supabase.from('channels').insert(ch);
    setShowCreateServer(false);
    switchContext('server', sid);
    showToast('Server created!', 'success');
  };

  const handleCreateChannel = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const name = fd.get('name').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
    if (!name || !activeServerId) return;
    const ch = { id: genId('chan'), serverId: activeServerId, name, createdAt: Date.now() };
    setData(prev => ({ ...prev, channels: [...prev.channels, ch] }));
    await supabase.from('channels').insert(ch);
    setShowCreateChannel(false);
    setActiveChannelId(ch.id);
    showToast('Channel created!', 'success');
  };

  const handleSendMessage = async (text, editing) => {
    if (!activeChannelId || !profile) return;
    if (profile.isBanned) return showToast('You are banned from sending messages.', 'error');

    if (editing) {
      setData(prev => ({ ...prev, messages: prev.messages.map(m => m.id === editing.id ? { ...m, text, isEdited: true } : m) }));
      setEditingMsg(null);
      const { error } = await supabase.from('messages').update({ text, isEdited: true }).eq('id', editing.id);
      if (error) { setData(prev => ({ ...prev, messages: prev.messages.map(m => m.id === editing.id ? { ...m, text: editing.text, isEdited: editing.isEdited } : m) })); showToast('Failed to edit.', 'error'); }
      return;
    }

    const msg = { id: genId('msg'), channelId: activeChannelId, text, senderId: profile.uid, timestamp: Date.now(), reactions: {}, isEdited: false };
    setData(prev => ({ ...prev, messages: [...prev.messages, msg] }));
    scrollToBottom();
    const { error } = await supabase.from('messages').insert(msg);
    if (error) {
      setData(prev => ({ ...prev, messages: prev.messages.filter(m => m.id !== msg.id) }));
      showToast('Failed to send message.', 'error');
    }
  };

  const handleImageUpload = async (e) => {
    const file = e.target.files?.[0];
    if (!file || !activeChannelId || !profile) return;
    if (profile.isBanned) return showToast('You are banned.', 'error');
    e.target.value = '';
    showToast('Compressing image...', 'info');
    try {
      const b64 = await compressImage(file);
      const msg = { id: genId('msg'), channelId: activeChannelId, text: '', imageUrl: b64, senderId: profile.uid, timestamp: Date.now(), reactions: {} };
      setData(prev => ({ ...prev, messages: [...prev.messages, msg] }));
      scrollToBottom();
      const { error } = await supabase.from('messages').insert(msg);
      if (error) {
        setData(prev => ({ ...prev, messages: prev.messages.filter(m => m.id !== msg.id) }));
        showToast('Failed to send image.', 'error');
      }
    } catch (err) { showToast(err.message || 'Image upload failed.', 'error'); }
  };

  const handleDeleteMessage = async (msgId) => {
    if (!confirm('Delete this message?')) return;
    setData(prev => ({ ...prev, messages: prev.messages.filter(m => m.id !== msgId) }));
    const { error } = await supabase.from('messages').delete().eq('id', msgId);
    if (error) showToast('Failed to delete.', 'error');
  };

  const handleReact = async (msgId, emoji, currentReactions) => {
    let rxns = JSON.parse(JSON.stringify(currentReactions || {}));
    if (!rxns[emoji]) rxns[emoji] = [];
    if (rxns[emoji].includes(profile.uid)) {
      rxns[emoji] = rxns[emoji].filter(id => id !== profile.uid);
      if (!rxns[emoji].length) delete rxns[emoji];
    } else {
      rxns[emoji].push(profile.uid);
    }
    setData(prev => ({ ...prev, messages: prev.messages.map(m => m.id === msgId ? { ...m, reactions: rxns } : m) }));
    await supabase.from('messages').update({ reactions: rxns }).eq('id', msgId);
  };

  const handleUpdateProfile = async (updates) => {
    if (!profile) return;
    setData(prev => ({ ...prev, users: prev.users.map(u => u.uid === profile.uid ? { ...u, ...updates } : u) }));
    const { error } = await supabase.from('users').update(updates).eq('id', profile.id);
    if (error) showToast('Failed to save. ' + error.message, 'error');
    else showToast('Profile updated!', 'success');
  };

  // Admin
  const adminBan = async (uid) => {
    if (!profile?.isAdmin || !confirm('Ban this user?')) return;
    await supabase.from('users').update({ isBanned: true }).eq('uid', uid);
    showToast('User banned.', 'success');
  };
  const adminPurge = async (uid) => {
    if (!profile?.isAdmin || !confirm('Purge all messages from this user?')) return;
    await supabase.from('messages').delete().eq('senderId', uid);
    showToast('Messages purged.', 'success');
  };
  const adminDelete = async (uid) => {
    if (!profile?.isAdmin || !confirm('Delete this account? This cannot be undone.')) return;
    const n = Math.floor(1000 + Math.random() * 9000);
    await supabase.from('users').update({ username: `deleted_user${n}`, nickname: `deleted_user${n}`, avatar: 'pfp.png', banner: '', bio: '', color: '#747f8d', isDeleted: true }).eq('uid', uid);
    setProfileModal(null);
    showToast('User deleted.', 'success');
  };

  // â”€â”€â”€ Early returns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (loading) return (
    <div className="flex h-screen items-center justify-center bg-[var(--bg-base)]">
      <div className="text-center">
        <div className="w-16 h-16 rounded-2xl bg-[var(--accent)] flex items-center justify-center mx-auto mb-4 anim-pulse">
          <MessageCircle size={32} className="text-white" />
        </div>
        <p className="text-[var(--text-muted)] font-medium">Loading NeoChat...</p>
      </div>
    </div>
  );

  if (!profile) return <AuthScreen onToast={showToast} />;

  // â”€â”€â”€ Message list with date dividers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const msgListWithDividers = [];
  let lastDate = null;
  channelMessages.forEach((msg, i) => {
    const d = new Date(msg.timestamp).toDateString();
    if (d !== lastDate) {
      lastDate = d;
      const label = d === new Date().toDateString() ? 'Today'
        : d === new Date(Date.now() - 86400000).toDateString() ? 'Yesterday'
        : new Date(msg.timestamp).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      msgListWithDividers.push({ type: 'divider', key: 'div_' + msg.timestamp, label });
    }
    msgListWithDividers.push({ type: 'msg', key: msg.id, msg, prev: channelMessages[i - 1] });
  });

  const dmTarget = channelInfo?.isDM ? channelInfo.targetUser : null;

  // â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return (
    <div className="flex h-screen w-full bg-[var(--bg-base)] text-[var(--text-main)] overflow-hidden relative">
      <Toast toast={toast} />
      <ConnBanner status={connStatus} />

      {/* Image lightbox */}
      {imageView && (
        <div className="fixed inset-0 bg-black/85 backdrop-blur-md flex items-center justify-center z-[200] p-4 cursor-zoom-out" onClick={() => setImageView(null)}>
          <img src={imageView} alt="Full view" className="max-w-full max-h-full object-contain rounded-xl shadow-2xl cursor-default" onClick={e => e.stopPropagation()} />
          <button onClick={() => setImageView(null)} className="absolute top-5 right-5 p-2 bg-black/60 hover:bg-black/80 text-white rounded-full transition-colors">
            <X size={22} />
          </button>
          <a href={imageView} download="neochat-image.jpg" onClick={e => e.stopPropagation()}
            className="absolute bottom-5 left-1/2 -translate-x-1/2 px-4 py-2 bg-black/60 hover:bg-black/80 text-white rounded-full text-sm font-medium transition-colors">
            Download
          </a>
        </div>
      )}

      {/* Mobile overlay */}
      {leftOpen && <div className="fixed inset-0 bg-black/70 z-30 md:hidden" onClick={() => setLeftOpen(false)} />}
      {membersSidebarOpen && <div className="fixed inset-0 bg-black/70 z-30 md:hidden" onClick={() => setMembersSidebarOpen(false)} />}

      {/* Profile Modal */}
      <ProfileModal
        target={profileModal}
        profile={profile}
        data={data}
        onClose={() => setProfileModal(null)}
        onSendRequest={handleSendRequest}
        onAcceptRequest={handleAcceptRequest}
        onRemoveFriend={handleRemoveFriend}
        onStartDM={handleStartDM}
        onAdminBan={adminBan}
        onAdminPurge={adminPurge}
        onAdminDelete={adminDelete}
      />

      {/* Settings Modal */}
      <SettingsModal
        open={settingsOpen}
        onClose={() => setSettingsOpen(false)}
        profile={profile}
        onUpdate={handleUpdateProfile}
        onLogout={handleLogout}
        initialTab={settingsTab}
      />

      {/* Search Modal */}
      <Modal open={showSearch} onClose={() => setShowSearch(false)} maxWidth={640}>
        <div className="flex items-center gap-3 p-4 border-b border-[var(--border)]">
          <Search size={18} className="text-[var(--text-faded)] shrink-0" />
          <input autoFocus type="text" placeholder="Search all messagesâ€¦"
            value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
            className="flex-1 bg-transparent text-[var(--text-main)] text-base outline-none placeholder-[var(--text-faded)]" />
          <button onClick={() => { setShowSearch(false); setSearchQuery(''); }} className="p-1 rounded hover:bg-[var(--bg-hover)] text-[var(--text-faded)]"><X size={18} /></button>
        </div>
        <div className="overflow-y-auto max-h-[60vh] p-4 scrollbar">
          {!searchQuery.trim() && <p className="text-center text-[var(--text-faded)] mt-8 text-sm">Type to search all messages.</p>}
          {searchQuery.trim() && !searchResults.length && <p className="text-center text-[var(--text-faded)] mt-8 text-sm">No results found.</p>}
          {searchResults.map(msg => {
            const sender = data.users.find(u => u.uid === msg.senderId) || getDeletedUser(msg.senderId);
            return (
              <div key={msg.id} onClick={() => { openDM(msg.channelId); setShowSearch(false); setSearchQuery(''); }}
                className="flex gap-3 p-3 rounded-xl hover:bg-[var(--bg-hover)] cursor-pointer transition-colors mb-2 border border-[var(--border)]">
                <Avatar user={sender} size={36} className="shrink-0 mt-0.5" />
                <div className="flex-1 min-w-0">
                  <div className="flex items-baseline gap-2">
                    <span className="text-sm font-semibold text-[var(--text-main)]">{sender.nickname || sender.username}</span>
                    <span className="text-[11px] text-[var(--text-faded)]">{new Date(msg.timestamp).toLocaleDateString()}</span>
                  </div>
                  <p className="text-sm text-[var(--text-muted)] truncate">{msg.text || '[Image]'}</p>
                </div>
              </div>
            );
          })}
        </div>
      </Modal>

      {/* Notifications Modal */}
      <Modal open={showNotifs} onClose={() => setShowNotifs(false)} maxWidth={380}>
        <div className="flex items-center justify-between p-4 border-b border-[var(--border)]">
          <h2 className="font-bold text-[var(--text-main)] flex items-center gap-2"><Bell size={18} className="text-[var(--accent)]" /> Notifications</h2>
          <button onClick={() => setShowNotifs(false)} className="p-1 rounded hover:bg-[var(--bg-hover)] text-[var(--text-faded)]"><X size={18} /></button>
        </div>
        <div className="overflow-y-auto max-h-[60vh] p-4 scrollbar">
          {!myNotifications.length && <p className="text-center text-[var(--text-faded)] mt-8 text-sm">No notifications.</p>}
          {myNotifications.map(msg => {
            const sender = data.users.find(u => u.uid === msg.senderId) || getDeletedUser(msg.senderId);
            return (
              <div key={msg.id} onClick={() => { openDM(msg.channelId); setShowNotifs(false); }}
                className="flex gap-3 p-3 rounded-xl hover:bg-[var(--bg-hover)] cursor-pointer mb-2 border-l-4 border-l-[var(--accent)] bg-[var(--bg-sidebar)] transition-colors">
                <Avatar user={sender} size={32} className="shrink-0" />
                <div className="flex-1 min-w-0">
                  <p className="text-xs text-[var(--text-muted)] mb-0.5">from <strong>{sender.nickname || sender.username}</strong></p>
                  <p className="text-sm text-[var(--text-main)] truncate">{msg.text || 'ðŸ“· Image'}</p>
                  <p className="text-[10px] text-[var(--text-faded)] mt-0.5">{formatTimestamp(msg.timestamp)}</p>
                </div>
              </div>
            );
          })}
        </div>
      </Modal>

      {/* Create Server Modal */}
      <Modal open={showCreateServer} onClose={() => setShowCreateServer(false)}>
        <div className="p-6">
          <h2 className="text-xl font-bold text-[var(--text-main)] mb-2">Create a Server</h2>
          <p className="text-sm text-[var(--text-muted)] mb-6">Give your community a name and identity.</p>
          <form onSubmit={handleCreateServer}>
            <label className="block text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider mb-2">Server Name</label>
            <input name="name" autoFocus required placeholder={`${profile.username}'s server`}
              className="w-full bg-[var(--bg-input)] border border-[var(--border)] text-[var(--text-main)] rounded-lg px-4 py-3 text-sm outline-none focus:border-[var(--accent)] transition-colors mb-6" />
            <div className="flex justify-end gap-3">
              <button type="button" onClick={() => setShowCreateServer(false)} className="px-4 py-2 text-sm text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors">Cancel</button>
              <button type="submit" className="px-5 py-2 bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white text-sm font-semibold rounded-lg transition-colors">Create</button>
            </div>
          </form>
        </div>
      </Modal>

      {/* Create Channel Modal */}
      <Modal open={showCreateChannel} onClose={() => setShowCreateChannel(false)}>
        <div className="p-6">
          <h2 className="text-xl font-bold text-[var(--text-main)] mb-6">Create Text Channel</h2>
          <form onSubmit={handleCreateChannel}>
            <label className="block text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider mb-2">Channel Name</label>
            <div className="relative">
              <Hash size={15} className="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-faded)]" />
              <input name="name" autoFocus required placeholder="new-channel"
                className="w-full bg-[var(--bg-input)] border border-[var(--border)] text-[var(--text-main)] rounded-lg pl-9 pr-4 py-3 text-sm outline-none focus:border-[var(--accent)] transition-colors mb-6" />
            </div>
            <div className="flex justify-end gap-3 mt-2">
              <button type="button" onClick={() => setShowCreateChannel(false)} className="px-4 py-2 text-sm text-[var(--text-muted)] hover:text-[var(--text-main)]">Cancel</button>
              <button type="submit" className="px-5 py-2 bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white text-sm font-semibold rounded-lg transition-colors">Create Channel</button>
            </div>
          </form>
        </div>
      </Modal>

      {/* Server Settings Modal */}
      {showServerSettings && activeServer && (
        <Modal open maxWidth={460} onClose={() => setShowServerSettings(false)}>
          <div className="p-6">
            <h2 className="text-xl font-bold text-[var(--text-main)] mb-6">Server Settings</h2>
            <label className="block text-xs font-bold text-[var(--text-faded)] uppercase tracking-wider mb-2">Server Name</label>
            <input type="text" id="srv-name-edit" defaultValue={activeServer.name}
              className="w-full bg-[var(--bg-input)] border border-[var(--border)] text-[var(--text-main)] rounded-lg px-4 py-3 text-sm outline-none focus:border-[var(--accent)] transition-colors" />
            <div className="flex justify-between items-center mt-8">
              <button onClick={async () => {
                const v = document.getElementById('srv-name-edit').value.trim();
                if (v && v !== activeServer.name) { await supabase.from('servers').update({ name: v }).eq('id', activeServer.id); showToast('Server updated!', 'success'); }
                setShowServerSettings(false);
              }} className="px-5 py-2 bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white text-sm font-semibold rounded-lg transition-colors">Save</button>
              <button onClick={async () => {
                if (!confirm('Delete this server? This cannot be undone.')) return;
                await supabase.from('servers').delete().eq('id', activeServer.id);
                setShowServerSettings(false);
                switchContext('home');
                showToast('Server deleted.', 'success');
              }} className="text-[var(--red)] text-sm font-medium hover:underline">Delete Server</button>
            </div>
          </div>
        </Modal>
      )}

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {/* LEFT NAV */}
      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <div className={`fixed inset-y-0 left-0 z-40 md:relative md:z-auto flex flex-row h-full shrink-0 transition-transform duration-300 ${leftOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>

        {/* Server Rail */}
        <div className="w-[68px] bg-[var(--bg-rail)] flex flex-col items-center py-3 gap-1.5 overflow-y-auto hide-scrollbar shrink-0">
          
          {/* Home */}
          <div className="relative flex justify-center w-full mb-1">
            <div className={`rail-pill ${context === 'home' ? '' : 'opacity-0'}`} style={{ height: context === 'home' ? 40 : 16, top: '50%', transform: 'translateY(-50%)' }} />
            <div className={`srv-icon ${context === 'home' ? 'active bg-[var(--accent)]' : 'bg-[var(--bg-panel)] hover:bg-[var(--accent)]'}`}
              onClick={() => switchContext('home')} title="Home">
              <Home size={22} className="text-white" />
              {pendingIncoming > 0 && <div className="unread-dot">{pendingIncoming > 9 ? '9+' : pendingIncoming}</div>}
            </div>
          </div>

          <div className="w-8 h-px bg-[var(--border)] my-1 shrink-0" />

          {/* Servers */}
          {data.servers.map(srv => {
            const active = activeServerId === srv.id;
            return (
              <div key={srv.id} className="relative flex justify-center w-full">
                <div className={`rail-pill ${active ? '' : 'opacity-0'}`} style={{ height: active ? 40 : 16, top: '50%', transform: 'translateY(-50%)' }} />
                <div className={`srv-icon overflow-hidden ${active ? 'active ring-2 ring-white/20' : ''}`}
                  onClick={() => switchContext('server', srv.id)} title={srv.name}>
                  <img src={srv.icon} alt={srv.name} className="w-full h-full object-cover" />
                </div>
              </div>
            );
          })}

          <div className="relative flex justify-center w-full mt-1">
            <div className="srv-icon bg-[var(--bg-panel)] hover:bg-[#3ba55c] text-[#3ba55c] hover:text-white"
              onClick={() => setShowCreateServer(true)} title="Create Server">
              <Plus size={22} />
            </div>
          </div>
          <div className="relative flex justify-center w-full mt-auto">
            <div className={`srv-icon ${context === 'discovery' ? 'active bg-[#3ba55c]' : 'bg-[var(--bg-panel)] hover:bg-[#3ba55c]'} text-[#3ba55c] hover:text-white`}
              onClick={() => { setContext('discovery'); setActiveServerId(null); setActiveChannelId(null); setLeftOpen(false); }} title="Explore Servers">
              <Compass size={22} />
            </div>
          </div>
        </div>

        {/* Channel / DM Sidebar */}
        {context !== 'discovery' && (
          <div className="w-60 bg-[var(--bg-sidebar)] flex flex-col shrink-0 border-r border-[var(--border)]">
            
            {/* Header */}
            <div className="h-12 px-4 flex items-center justify-between border-b border-[var(--border)] shrink-0">
              <span className="font-bold text-[var(--text-main)] truncate text-sm">
                {context === 'server' && activeServer ? activeServer.name : 'Direct Messages'}
              </span>
              {context === 'server' && activeServer && profile.isAdmin && (
                <button onClick={() => setShowServerSettings(true)} title="Server Settings"
                  className="p-1 rounded hover:bg-[var(--bg-hover)] text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors shrink-0">
                  <Settings size={15} />
                </button>
              )}
            </div>

            {/* List */}
            <div className="flex-1 overflow-y-auto p-2 scrollbar">
              {context === 'server' ? (
                <>
                  <div className="flex items-center justify-between px-2 pt-4 pb-1 group">
                    <span className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider">Text Channels</span>
                    {profile.isAdmin && (
                      <button onClick={() => setShowCreateChannel(true)} className="opacity-0 group-hover:opacity-100 text-[var(--text-faded)] hover:text-[var(--text-main)] transition-all" title="Add Channel">
                        <Plus size={14} />
                      </button>
                    )}
                  </div>
                  {serverChannels.map(ch => (
                    <div key={ch.id} className={`ch-row ${activeChannelId === ch.id ? 'active' : ''}`}
                      onClick={() => { setActiveChannelId(ch.id); setLeftOpen(false); }}>
                      <Hash size={17} className="shrink-0 text-[var(--text-faded)]" />
                      <span className="truncate text-sm">{ch.name}</span>
                    </div>
                  ))}
                  {!serverChannels.length && (
                    <p className="text-xs text-[var(--text-faded)] text-center mt-6 px-2">No channels yet.{profile.isAdmin ? ' Create one!' : ''}</p>
                  )}
                </>
              ) : (
                <>
                  <div className="px-2 pt-4 pb-1">
                    <span className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider">Direct Messages</span>
                  </div>
                  {!activeDMs.length && (
                    <div className="text-center px-4 mt-6">
                      <Users size={28} className="mx-auto text-[var(--text-faded)] mb-2 opacity-40" />
                      <p className="text-xs text-[var(--text-faded)]">No open conversations. Add a friend!</p>
                    </div>
                  )}
                  {activeDMs.map(ch => {
                    const unread = unreadCounts[ch.id] || 0;
                    return (
                      <div key={ch.id} className={`dm-row ${activeChannelId === ch.id ? 'active' : ''} group`}
                        onClick={() => openDM(ch.id)}>
                        <div className="relative shrink-0">
                          <Avatar user={ch.targetUser} size={32} showStatus={!ch.targetUser.isDeleted} />
                          {unread > 0 && <div className="unread-dot" style={{ borderColor: 'var(--bg-sidebar)' }}>{unread > 9 ? '9+' : unread}</div>}
                        </div>
                        <span className={`flex-1 truncate text-sm ${unread > 0 ? 'font-semibold text-[var(--text-main)]' : ''}`}>
                          {ch.targetUser.nickname || ch.targetUser.username}
                        </span>
                        <button onClick={(e) => handleCloseDM(e, ch.id)}
                          className="opacity-0 group-hover:opacity-100 p-0.5 rounded text-[var(--text-faded)] hover:text-[var(--red)] transition-all shrink-0" title="Close">
                          <X size={13} />
                        </button>
                      </div>
                    );
                  })}
                </>
              )}
            </div>

            {/* User bar */}
            <div className="h-[52px] bg-[var(--bg-userpanel)] flex items-center px-2 gap-1 border-t border-[var(--border)] shrink-0">
              <button onClick={() => setProfileModal(profile)}
                className="flex items-center gap-2 flex-1 min-w-0 p-1.5 rounded-lg hover:bg-[var(--bg-hover)] transition-colors text-left">
                <div className="relative shrink-0">
                  <Avatar user={profile} size={32} />
                  <div className="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-[#3ba55c] border-2 border-[var(--bg-userpanel)] rounded-full" />
                </div>
                <div className="flex-1 min-w-0 leading-tight">
                  <div className="text-sm font-semibold text-[var(--text-main)] truncate flex items-center gap-1">
                    {profile.nickname || profile.username}
                    {profile.isAdmin && <span className="bg-amber-400 text-black text-[9px] px-1 rounded font-bold">ADMIN</span>}
                  </div>
                  <div className="text-[11px] text-[var(--text-faded)] truncate">#{profile.uid.slice(0,4)}</div>
                </div>
              </button>
              <button onClick={() => setMicMuted(!micMuted)} title={micMuted ? 'Unmute' : 'Mute'}
                className={`p-1.5 rounded-lg transition-colors ${micMuted ? 'text-[var(--red)] bg-[var(--red)]/10' : 'text-[var(--text-muted)] hover:bg-[var(--bg-hover)] hover:text-[var(--text-main)]'}`}>
                {micMuted ? <MicOff size={16} /> : <Mic size={16} />}
              </button>
              <button onClick={() => setDeafened(!deafened)} title={deafened ? 'Undeafen' : 'Deafen'}
                className={`p-1.5 rounded-lg transition-colors ${deafened ? 'text-[var(--red)] bg-[var(--red)]/10' : 'text-[var(--text-muted)] hover:bg-[var(--bg-hover)] hover:text-[var(--text-main)]'}`}>
                <Headphones size={16} className={deafened ? 'opacity-50' : ''} />
              </button>
              <button onClick={() => { setSettingsTab('account'); setSettingsOpen(true); }} title="Settings"
                className="p-1.5 rounded-lg text-[var(--text-muted)] hover:bg-[var(--bg-hover)] hover:text-[var(--text-main)] transition-colors">
                <Settings size={16} />
              </button>
            </div>
          </div>
        )}
      </div>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {/* MAIN AREA */}
      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <div className="flex-1 flex flex-col min-w-0 bg-[var(--bg-panel)] relative overflow-hidden">

        {/* â”€â”€ Discovery â”€â”€ */}
        {context === 'discovery' && (
          <div className="flex-1 overflow-y-auto scrollbar p-6 md:p-10">
            <div className="flex items-center gap-3 mb-6">
              <button onClick={() => setLeftOpen(true)} className="md:hidden p-2 rounded-lg bg-[var(--bg-input)] text-[var(--text-main)]"><Menu size={20} /></button>
              <h1 className="text-2xl font-bold text-[var(--text-main)] flex items-center gap-2"><Compass size={26} className="text-[var(--accent)]" /> Discover Servers</h1>
            </div>
            {!data.servers.length && (
              <div className="text-center mt-20 text-[var(--text-faded)]">
                <Compass size={48} className="mx-auto mb-4 opacity-20" />
                <p>No servers yet. Create one!</p>
              </div>
            )}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {data.servers.map(s => (
                <div key={s.id} onClick={() => switchContext('server', s.id)}
                  className="bg-[var(--bg-sidebar)] rounded-2xl border border-[var(--border)] overflow-hidden cursor-pointer hover:-translate-y-1 hover:shadow-xl transition-all group">
                  <div className="h-20 bg-gradient-to-br from-[var(--accent)] to-purple-600 relative">
                    <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                  </div>
                  <div className="px-4 pb-4 pt-10 relative">
                    <img src={s.icon} alt={s.name} className="absolute -top-8 left-4 w-14 h-14 rounded-xl border-4 border-[var(--bg-sidebar)] object-cover shadow-lg" />
                    <p className="font-bold text-[var(--text-main)]">{s.name}</p>
                    <p className="text-xs text-[var(--text-muted)] mt-0.5">{data.channels.filter(c => c.serverId === s.id).length} channels</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* â”€â”€ Home / Friends â”€â”€ */}
        {context === 'home' && !activeChannelId && (
          <div className="flex-1 flex flex-col overflow-hidden">
            {/* Header */}
            <div className="h-12 px-4 flex items-center gap-4 border-b border-[var(--border)] shrink-0">
              <button onClick={() => setLeftOpen(true)} className="md:hidden p-1 text-[var(--text-muted)] shrink-0"><Menu size={20} /></button>
              <div className="flex items-center gap-2 border-r border-[var(--border)] pr-4">
                <Users size={18} className="text-[var(--text-faded)]" />
                <span className="font-bold text-sm text-[var(--text-main)]">Friends</span>
              </div>
              <div className="flex items-center gap-1 overflow-x-auto scrollbar pb-px">
                {[
                  { id: 'online', label: 'Online' },
                  { id: 'all', label: 'All' },
                  { id: 'pending', label: `Pending${pendingIncoming > 0 ? ` (${pendingIncoming})` : ''}` },
                  { id: 'add', label: 'Add Friend', accent: true },
                ].map(t => (
                  <button key={t.id} onClick={() => setHomeTab(t.id)}
                    className={`whitespace-nowrap px-3 py-1 rounded text-sm font-medium transition-colors shrink-0 ${
                      homeTab === t.id
                        ? t.accent ? 'bg-[var(--green)] text-white' : 'bg-[var(--bg-hover)] text-[var(--text-main)]'
                        : t.accent ? 'text-[var(--green)] hover:bg-[var(--green)]/10' : 'text-[var(--text-faded)] hover:bg-[var(--bg-hover)] hover:text-[var(--text-muted)]'
                    }`}>
                    {t.label}
                  </button>
                ))}
              </div>
              <div className="ml-auto flex items-center gap-2">
                <button onClick={() => setShowNotifs(true)} className="relative p-1.5 rounded-lg text-[var(--text-muted)] hover:bg-[var(--bg-hover)] hover:text-[var(--text-main)] transition-colors">
                  <Bell size={18} />
                  {myNotifications.length > 0 && <span className="absolute top-0.5 right-0.5 w-2 h-2 bg-[var(--red)] rounded-full border border-[var(--bg-panel)]" />}
                </button>
              </div>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-6 md:p-8 scrollbar flex justify-center">
              {homeTab === 'add' && (
                <div className="w-full max-w-2xl">
                  <h2 className="font-bold text-[var(--text-main)] text-lg mb-1">Add Friend</h2>
                  <p className="text-sm text-[var(--text-muted)] mb-4">Type an exact username to send a friend request.</p>
                  <form onSubmit={handleAddFriend} className="flex items-center gap-3 bg-[var(--bg-input)] border border-[var(--border)] focus-within:border-[var(--accent)] rounded-xl p-2 transition-colors">
                    <input name="uname" placeholder="Exact username" autoComplete="off" required
                      className="flex-1 bg-transparent text-[var(--text-main)] placeholder-[var(--text-faded)] outline-none px-3 py-2 text-sm" />
                    <button type="submit" className="px-5 py-2 bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white text-sm font-semibold rounded-lg transition-colors">
                      Send Request
                    </button>
                  </form>
                  <div className="mt-12 text-center text-[var(--text-faded)]">
                    <Users size={48} className="mx-auto mb-3 opacity-10" />
                    <p className="text-sm">Your friends list is empty. Add some friends!</p>
                  </div>
                </div>
              )}

              {homeTab === 'pending' && (
                <div className="w-full max-w-2xl">
                  <p className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider mb-4 pb-3 border-b border-[var(--border)]">
                    Pending Requests â€” {pendingRequests.length}
                  </p>
                  {!pendingRequests.length && <p className="text-center text-[var(--text-faded)] mt-12 text-sm">No pending requests.</p>}
                  {pendingRequests.map(req => (
                    <div key={req.id} className="flex items-center justify-between p-3 rounded-xl border-t border-[var(--border)] hover:bg-[var(--bg-hover)] transition-colors group"
                      onClick={() => setProfileModal(req.targetUser)}>
                      <div className="flex items-center gap-3 cursor-pointer">
                        <Avatar user={req.targetUser} size={40} />
                        <div>
                          <p className="font-semibold text-sm text-[var(--text-main)]">{req.targetUser.nickname || req.targetUser.username}</p>
                          <p className="text-xs text-[var(--text-faded)]">{req.isOutgoing ? 'â†‘ Outgoing' : 'â†“ Incoming'} Friend Request</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2" onClick={e => e.stopPropagation()}>
                        {!req.isOutgoing && (
                          <button onClick={() => handleAcceptRequest(req.id, req.targetUser)}
                            className="p-2 rounded-full bg-[var(--bg-input)] hover:bg-[var(--green)] text-[var(--text-muted)] hover:text-white transition-colors" title="Accept">
                            <Check size={16} />
                          </button>
                        )}
                        <button onClick={() => handleRemoveFriend(req.id)}
                          className="p-2 rounded-full bg-[var(--bg-input)] hover:bg-[var(--red)] text-[var(--text-muted)] hover:text-white transition-colors" title={req.isOutgoing ? 'Cancel' : 'Decline'}>
                          <X size={16} />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {(homeTab === 'online' || homeTab === 'all') && (
                <div className="w-full max-w-2xl">
                  <p className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider mb-4 pb-3 border-b border-[var(--border)]">
                    {homeTab === 'online'
                      ? `Online â€” ${allDMs.filter(c => isOnline(c.targetUser.lastActive)).length}`
                      : `All Friends â€” ${allDMs.length}`}
                  </p>
                  {!allDMs.length && <p className="text-center text-[var(--text-faded)] mt-12 text-sm">No friends yet. Add some!</p>}
                  {allDMs
                    .filter(ch => homeTab === 'all' || isOnline(ch.targetUser.lastActive))
                    .map(ch => (
                      <div key={ch.id} className="flex items-center justify-between p-3 rounded-xl border-t border-[var(--border)] hover:bg-[var(--bg-hover)] cursor-pointer group transition-colors"
                        onClick={() => openDM(ch.id)}>
                        <div className="flex items-center gap-3">
                          <Avatar user={ch.targetUser} size={40} showStatus={!ch.targetUser.isDeleted} />
                          <div>
                            <p className="font-semibold text-sm text-[var(--text-main)]">{ch.targetUser.nickname || ch.targetUser.username}</p>
                            <p className="text-xs text-[var(--text-faded)]">
                              {ch.targetUser.isDeleted ? 'Deleted User' : isOnline(ch.targetUser.lastActive) ? 'Online' : 'Offline'}
                            </p>
                          </div>
                        </div>
                        <div className="opacity-0 group-hover:opacity-100 flex items-center gap-2 transition-opacity">
                          <button className="p-2 rounded-full bg-[var(--bg-input)] hover:bg-[var(--bg-hover)] text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors" title="Message">
                            <MessageSquare size={16} />
                          </button>
                          <button onClick={e => { e.stopPropagation(); setProfileModal(ch.targetUser); }}
                            className="p-2 rounded-full bg-[var(--bg-input)] hover:bg-[var(--bg-hover)] text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors" title="View Profile">
                            <User size={16} />
                          </button>
                        </div>
                      </div>
                    ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* â”€â”€ Chat area â”€â”€ */}
        {activeChannelId && (
          <>
            {/* Chat header */}
            <div className="h-12 px-4 flex items-center justify-between border-b border-[var(--border)] shrink-0 bg-[var(--bg-panel)] z-10">
              <div className="flex items-center gap-2 min-w-0">
                <button onClick={() => setLeftOpen(true)} className="md:hidden p-1 mr-1 text-[var(--text-muted)] shrink-0"><Menu size={20} /></button>
                {channelInfo?.isDM
                  ? <Avatar user={channelInfo.targetUser} size={24} className="shrink-0" />
                  : <Hash size={22} className="text-[var(--text-faded)] shrink-0" />}
                <span className="font-bold text-[var(--text-main)] truncate text-sm">{channelInfo?.name}</span>
                {channelInfo?.isDM && channelInfo.targetUser && !channelInfo.targetUser.isDeleted && (
                  <span className={`ml-1 text-[11px] ${isOnline(channelInfo.targetUser.lastActive) ? 'text-[var(--green)]' : 'text-[var(--text-faded)]'}`}>
                    â€¢ {isOnline(channelInfo.targetUser.lastActive) ? 'Online' : 'Offline'}
                  </span>
                )}
              </div>
              <div className="flex items-center gap-1 shrink-0">
                <button onClick={() => setShowSearch(true)} className="p-1.5 rounded-lg text-[var(--text-muted)] hover:bg-[var(--bg-hover)] hover:text-[var(--text-main)] transition-colors" title="Search">
                  <Search size={18} />
                </button>
                <button onClick={() => setShowNotifs(true)} className="relative p-1.5 rounded-lg text-[var(--text-muted)] hover:bg-[var(--bg-hover)] hover:text-[var(--text-main)] transition-colors" title="Notifications">
                  <Bell size={18} />
                  {myNotifications.length > 0 && <span className="absolute top-0.5 right-0.5 w-2 h-2 bg-[var(--red)] rounded-full" />}
                </button>
                {context === 'server' && (
                  <button onClick={() => setMembersSidebarOpen(!membersSidebarOpen)}
                    className={`p-1.5 rounded-lg transition-colors ${membersSidebarOpen ? 'bg-[var(--bg-hover)] text-[var(--text-main)]' : 'text-[var(--text-muted)] hover:bg-[var(--bg-hover)] hover:text-[var(--text-main)]'}`} title="Members">
                    <Users size={18} />
                  </button>
                )}
                {context === 'home' && activeChannelId && (
                  <button onClick={() => setDmSidebarOpen(!dmSidebarOpen)}
                    className={`p-1.5 rounded-lg transition-colors hidden md:block ${dmSidebarOpen ? 'bg-[var(--bg-hover)] text-[var(--text-main)]' : 'text-[var(--text-muted)] hover:bg-[var(--bg-hover)] hover:text-[var(--text-main)]'}`} title="Profile">
                    <User size={18} />
                  </button>
                )}
              </div>
            </div>

            {/* Messages */}
            <div ref={msgListRef} className="flex-1 overflow-y-auto py-2 scrollbar relative" onScroll={handleMsgScroll}>
              {/* Channel start welcome */}
              {channelMessages.length === 0 && (
                <div className="flex flex-col items-center justify-center h-full text-center px-8">
                  {channelInfo?.isDM
                    ? <><Avatar user={channelInfo.targetUser} size={64} className="mb-4" />
                        <p className="text-xl font-bold text-[var(--text-main)] mb-1">@{channelInfo.name}</p>
                        <p className="text-sm text-[var(--text-muted)]">This is the beginning of your conversation with {channelInfo.name}.</p></>
                    : <><Hash size={48} className="text-[var(--text-faded)] mb-4 opacity-30" />
                        <p className="text-xl font-bold text-[var(--text-main)] mb-1">#{channelInfo?.name}</p>
                        <p className="text-sm text-[var(--text-muted)]">This is the start of #{channelInfo?.name}. Send the first message!</p></>}
                </div>
              )}
              
              {msgListWithDividers.map(item =>
                item.type === 'divider'
                  ? <DateDivider key={item.key} date={item.label} />
                  : <Message
                      key={item.key}
                      msg={item.msg}
                      prev={item.prev}
                      users={data.users}
                      profile={profile}
                      onReact={handleReact}
                      onDelete={handleDeleteMessage}
                      onEdit={setEditingMsg}
                      onImageClick={setImageView}
                    />
              )}
              
              <TypingIndicator typers={typers} />
              <div ref={messagesEndRef} className="h-4" />
            </div>

            {/* Jump to bottom */}
            <button
              className={`jump-btn ${atBottom ? 'hidden' : ''}`}
              onClick={() => { scrollToBottom(true); setAtBottom(true); setUnreadCounts(p => ({ ...p, [activeChannelId]: 0 })); }}>
              <ArrowDown size={14} />
              {unreadCounts[activeChannelId] > 0 && <span>{unreadCounts[activeChannelId]} new</span>}
            </button>

            {/* Input */}
            <InputBar
              channelInfo={channelInfo}
              profile={profile}
              editingMsg={editingMsg}
              onSend={handleSendMessage}
              onCancelEdit={() => setEditingMsg(null)}
              onImageUpload={handleImageUpload}
            />
          </>
        )}
      </div>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {/* RIGHT SIDEBAR */}
      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {/* Members sidebar (server) */}
      {context === 'server' && membersSidebarOpen && (
        <div className={`fixed inset-y-0 right-0 z-40 md:relative md:z-auto w-60 bg-[var(--bg-sidebar)] flex flex-col border-l border-[var(--border)] shrink-0 overflow-y-auto scrollbar transition-transform duration-300 ${membersSidebarOpen ? 'translate-x-0' : 'translate-x-full md:hidden'}`}>
          <p className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider px-4 pt-5 pb-2 border-b border-[var(--border)]">
            Users â€” {data.users.length}
          </p>
          {data.users.map(u => (
            <div key={u.uid} onClick={() => { setProfileModal(u); setMembersSidebarOpen(false); }}
              className="flex items-center gap-2.5 px-3 py-2 mx-1 my-0.5 rounded-lg hover:bg-[var(--bg-hover)] cursor-pointer transition-colors group">
              <Avatar user={u} size={32} showStatus />
              <div className="flex-1 min-w-0">
                <p className={`text-sm font-medium truncate flex items-center gap-1 ${isOnline(u.lastActive) ? 'text-[var(--text-main)]' : 'text-[var(--text-faded)] group-hover:text-[var(--text-muted)]'}`}>
                  {u.nickname || u.username}
                  {u.isAdmin && <span className="bg-amber-400 text-black text-[7px] px-1 rounded font-bold">A</span>}
                </p>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* DM Profile sidebar */}
      {context === 'home' && activeChannelId && dmSidebarOpen && dmTarget && (
        <div className="hidden md:flex w-72 bg-[var(--bg-sidebar)] flex-col shrink-0 border-l border-[var(--border)] overflow-y-auto scrollbar">
          <div className="h-24 relative shrink-0" style={{
            backgroundColor: dmTarget.color || 'var(--accent)',
            backgroundImage: dmTarget.banner ? `url(${dmTarget.banner})` : undefined,
            backgroundSize: 'cover', backgroundPosition: 'center'
          }} />
          <div className="px-5 pb-5 pt-14 relative">
            <div className="absolute -top-11 left-5 rounded-full border-[5px] border-[var(--bg-sidebar)]">
              <Avatar user={dmTarget} size={80} showStatus={!dmTarget.isDeleted} />
            </div>
            <h2 className="text-lg font-bold text-[var(--text-main)] flex items-center gap-2 flex-wrap">
              {dmTarget.nickname || dmTarget.username}
              {dmTarget.isAdmin && <span className="bg-amber-400 text-black text-[9px] px-1.5 py-0.5 rounded font-bold">ADMIN</span>}
            </h2>
            <p className="text-sm text-[var(--text-muted)]">{dmTarget.nickname ? `${dmTarget.username} ` : ''}#{dmTarget.uid.slice(0,6)}</p>
            <div className="bg-[var(--bg-panel)] rounded-xl p-3 border border-[var(--border)] mt-4">
              <p className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider mb-1.5">About Me</p>
              <p className="text-sm text-[var(--text-main)] break-words whitespace-pre-wrap">{dmTarget.bio || <span className="text-[var(--text-faded)] italic">No bio set.</span>}</p>
              <p className="text-[10px] font-bold text-[var(--text-faded)] uppercase tracking-wider mb-1 mt-4">Member Since</p>
              <p className="text-sm text-[var(--text-main)]">{dmTarget.isDeleted ? 'Deleted' : new Date(dmTarget.lastActive || Date.now()).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

const root = createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
